@{
    ViewData["Title"] = "é¢¨éšªè©•ä¼°å ±å‘Š";
}

<div class="app-container">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="sidebar-logo">
                    <img src="~/images/logo.svg" alt="æ™ºåºè³‡è¨Š" class="logo-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                    <svg class="logo-svg" style="display:none;" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="20" y="20" width="40" height="120" stroke="currentColor" stroke-width="2" fill="none"/>
                        <rect x="60" y="60" width="60" height="40" stroke="currentColor" stroke-width="2" fill="none"/>
                        <rect x="60" y="100" width="40" height="40" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M140 20 L140 80 L180 80 L180 60 L160 60 L160 20 Z" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M140 100 L140 140 L180 140 L180 120 L160 120 L160 100 Z" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M120 140 L120 160 L180 160 L180 140 Z" stroke="currentColor" stroke-width="2" fill="none"/>
                        <rect x="140" y="20" width="40" height="20" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                </div>
                <div class="sidebar-brand-text">
                    <h2 class="sidebar-title">DocEngine</h2>
                    <p class="sidebar-subtitle">æ™ºåºè³‡è¨Š</p>
                </div>
            </div>
            <button class="sidebar-close" id="sidebarClose" aria-label="Close sidebar">
                <span></span>
                <span></span>
            </button>
        </div>
        <nav class="sidebar-nav">
            <a href="@Url.Action("Index", "Home")" class="nav-item" data-page="dashboard">
                <span class="nav-icon">ğŸ“Š</span>
                <span class="nav-text" data-i18n="Nav.Dashboard">å„€è¡¨æ¿</span>
            </a>
            <a href="#" class="nav-item" data-page="projects">
                <span class="nav-icon">ğŸ“</span>
                <span class="nav-text" data-i18n="Nav.Projects">å°ˆæ¡ˆ</span>
            </a>
            <a href="@Url.Action("Assessment", "Home")" class="nav-item" data-page="assessment">
                <span class="nav-icon">ğŸ“</span>
                <span class="nav-text" data-i18n="Nav.Assessment">è©•ä¼°</span>
            </a>
            <a href="@Url.Action("Report", "Home")" class="nav-item active" data-page="report">
                <span class="nav-icon">ğŸ“‹</span>
                <span class="nav-text" data-i18n="Nav.Report">å ±å‘Š</span>
            </a>
            <a href="#" class="nav-item" data-page="documentation">
                <span class="nav-icon">ğŸ“„</span>
                <span class="nav-text" data-i18n="Nav.Documentation">æ–‡ä»¶</span>
            </a>
            <a href="#" class="nav-item" data-page="risks">
                <span class="nav-icon">âš ï¸</span>
                <span class="nav-text" data-i18n="Nav.Risks">é¢¨éšª</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Mobile Header with Hamburger and Language Switcher -->
        <header class="mobile-header">
            <button class="hamburger" id="hamburger" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1 class="mobile-title">DocEngine</h1>
            <div class="mobile-header-actions">
                <div class="language-switcher-top">
                    <button class="lang-btn-top" onclick="i18n.setLang('zh-TW')" data-lang="zh-TW">
                        <span data-i18n="Common.Chinese">ç¹é«”ä¸­æ–‡</span>
                    </button>
                    <button class="lang-btn-top" onclick="i18n.setLang('en-US')" data-lang="en-US">
                        <span data-i18n="Common.English">English</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="content-wrapper">
            <div class="report-header">
                <div class="report-header-top">
                    <div class="report-header-left">
                        <h1 class="report-title" data-i18n="Report.Title">é¢¨éšªè©•ä¼°å ±å‘Š</h1>
                        <p class="report-subtitle" data-i18n="Report.Subtitle">æ ¹æ“šæ‚¨çš„å•å·çµæœè‡ªå‹•ç”Ÿæˆçš„é¢¨éšªæŒ‡ç´‹åˆ†æ</p>
                    </div>
                    <div class="report-header-right">
                        <div class="report-header-meta">
                            <div class="report-meta-item">
                                <span class="report-meta-label" data-i18n="Report.SystemName">ç³»çµ±åç¨±</span>
                                <span class="report-meta-value" id="systemNameDisplay">-</span>
                            </div>
                            <div class="report-meta-item">
                                <span class="report-meta-label" data-i18n="Report.AssessmentDate">è©•ä¼°æ—¥æœŸ</span>
                                <span class="report-meta-value" id="assessmentDate">-</span>
                            </div>
                        </div>
                        <div class="header-actions">
                            <div class="language-switcher-top">
                                <button class="lang-btn-top" onclick="i18n.setLang('zh-TW')" data-lang="zh-TW">
                                    <span data-i18n="Common.Chinese">ç¹é«”ä¸­æ–‡</span>
                                </button>
                                <button class="lang-btn-top" onclick="i18n.setLang('en-US')" data-lang="en-US">
                                    <span data-i18n="Common.English">English</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="maturity-info-box">
                    <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <span class="info-text">
                        <strong data-i18n="Assessment.MaturityLabel">M = æˆç†Ÿåº¦ (Maturity)</strong>
                        <span data-i18n="Assessment.MaturityDesc">ï¼šè©•ä¼°å„é …æµç¨‹èˆ‡èƒ½åŠ›çš„æˆç†Ÿç¨‹åº¦ï¼Œåˆ†æ•¸è¶Šé«˜è¡¨ç¤ºè©²é ˜åŸŸè¶Šæˆç†Ÿ</span>
                    </span>
                </div>
            </div>

            <!-- No Data Guide Section (ç•¶æ²’æœ‰å ±å‘Šæ•¸æ“šæ™‚é¡¯ç¤º) -->
            <div id="noReportGuide" class="report-no-data-guide" style="display: none;">
                <div class="no-data-card">
                    <div class="no-data-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                    </div>
                    <h2 class="no-data-title" data-i18n="Report.NoReportTitle">å°šæœªç”Ÿæˆå ±å‘Š</h2>
                    <p class="no-data-description" data-i18n="Report.NoReportDesc">å®Œæˆé¢¨éšªè©•ä¼°å•å·ä¸¦ä»˜æ¬¾å¾Œï¼Œå³å¯æŸ¥çœ‹æ‚¨çš„å°ˆå±¬é¢¨éšªè©•ä¼°å ±å‘Šã€‚</p>
                    <div class="no-data-actions">
                        <a href="@Url.Action("Assessment", "Home")" class="report-button primary">
                            <span data-i18n="Report.GoToAssessment">å‰å¾€è©•ä¼°å•å·</span>
                        </a>
                    </div>
                </div>
            </div>

            <div id="reportContent" class="report-layout" style="display: none;">
                <!-- System Name Display (for PDF) -->
                <div class="pdf-system-name" id="pdfSystemName" style="display: none;">
                    <h2 class="pdf-system-name-text" id="pdfSystemNameText"></h2>
                </div>
                
                <!-- Radar + Summary -->
                <section class="report-top" data-section="radar-summary">
                    <div class="report-card radar-card" data-block="radar">
                        <div class="section-header">
                            <h2 class="section-title" data-i18n="Report.RadarTitle">M1-M5 åˆ†æ•¸é›·é”åœ–</h2>
                            <p class="section-description" data-i18n="Report.RadarDesc">è¦–è¦ºåŒ–é¡¯ç¤ºäº”é …é—œéµé¢¨éšªæŒ‡æ¨™</p>
                        </div>
                        <div class="radar-chart-container report-radar-container">
                            <div class="radar-chart">
                                <svg id="reportRadar" class="radar-svg" viewBox="-20 -20 240 240" preserveAspectRatio="xMidYMid meet">
                                    <!-- Background circles -->
                                    <circle cx="100" cy="100" r="80" class="radar-circle" />
                                    <circle cx="100" cy="100" r="60" class="radar-circle" />
                                    <circle cx="100" cy="100" r="40" class="radar-circle" />
                                    <circle cx="100" cy="100" r="20" class="radar-circle" />

                                    <!-- 5 axes -->
                                    <line x1="100" y1="100" x2="100" y2="20" class="radar-line" />
                                    <line x1="100" y1="100" x2="167" y2="70" class="radar-line" />
                                    <line x1="100" y1="100" x2="147" y2="160" class="radar-line" />
                                    <line x1="100" y1="100" x2="53" y2="160" class="radar-line" />
                                    <line x1="100" y1="100" x2="33" y2="70" class="radar-line" />

                                    <!-- Dynamic polygon for M1-M5 -->
                                    <polygon id="radarPolygon" points="" class="radar-polygon" />

                                    <!-- Axis labels -->
                                    <text x="100" y="15" class="radar-label" data-i18n="Report.RadarM1">M1 äº¤æ¥</text>
                                    <text x="180" y="75" class="radar-label" data-i18n="Report.RadarM2">M2 è¿½æº¯</text>
                                    <text x="165" y="170" class="radar-label" data-i18n="Report.RadarM3">M3 è®Šæ›´</text>
                                    <text x="35" y="170" class="radar-label" data-i18n="Report.RadarM4">M4 é©—æ”¶</text>
                                    <text x="20" y="75" class="radar-label" data-i18n="Report.RadarM5">M5 æºé€š</text>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="report-card fingerprint-card" data-block="fingerprint">
                        <div class="section-header">
                            <h2 class="section-title" data-i18n="Report.FingerprintTitle">é¢¨éšªæŒ‡ç´‹ç¸½çµ</h2>
                            <p class="section-description" data-i18n="Report.FingerprintDesc">æ•´é«”é¢¨éšªè¼ªå»“èˆ‡å»ºè­°</p>
                        </div>
                        <div class="fingerprint-metrics">
                            <div class="metric-item">
                                <span class="metric-label" data-i18n="Report.TotalScore">ç¸½åˆ†</span>
                                <span class="metric-value" id="totalScore">0</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label" data-i18n="Report.RiskLevel">é¢¨éšªç­‰ç´š</span>
                                <span class="metric-badge" id="riskLevel">-</span>
                                <span class="metric-action" id="riskAction" style="display: block; margin-top: 8px; font-size: 11px; color: #b0b0b0; font-weight: normal; line-height: 1.4;">-</span>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label" data-i18n="Report.SampleTime">æ¨£æœ¬æ™‚é–“</span>
                                <span class="metric-value" id="surveyTime">-</span>
                            </div>
                        </div>
                        <!-- åˆ†æ•¸èªªæ˜è¡¨ï¼ˆç§»åˆ°é¢¨éšªåˆ†æ•¸ä¸‹æ–¹ï¼‰ -->
                        <div class="score-description-table" id="scoreDescriptionTable" style="margin-top: 24px; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; display: none;">
                            <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #e0e0e0;" data-i18n="Score.TableTitle">å„æŒ‡æ¨™åˆ†æ•¸èªªæ˜</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                        <th style="padding: 8px; text-align: left; color: #b0b0b0; font-weight: 600;" data-i18n="Score.Indicator">æŒ‡æ¨™</th>
                                        <th style="padding: 8px; text-align: center; color: #b0b0b0; font-weight: 600; width: 80px;" data-i18n="Score.Value">åˆ†æ•¸</th>
                                        <th style="padding: 8px; text-align: left; color: #b0b0b0; font-weight: 600;" data-i18n="Score.Description">èªªæ˜</th>
                                    </tr>
                                </thead>
                                <tbody id="scoreTableBody">
                                    <!-- å‹•æ…‹å¡«å…… -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Risk Improvement Advice Section (ç¨ç«‹å€å¡Š) -->
                <section class="report-advice-section" data-section="advice">
                    <div class="report-card advice-card" data-block="advice">
                        <div class="section-header">
                            <h2 class="section-title" data-i18n="Report.ImprovementAdvice">é¢¨éšªæ”¹å–„å»ºè­°</h2>
                        </div>
                        <div class="advice-block">
                            <p class="advice-text" id="adviceText" data-i18n="Report.DefaultAdvice">
                                å°‡æ ¹æ“šæ‚¨çš„å•å·çµæœç”¢ç”Ÿå…·é«”å»ºè­°ã€‚
                            </p>
                            <div class="ai-refresh-hint" id="adviceRefreshHint" style="display: none; margin-top: 12px; padding: 8px 12px; background: rgba(98, 0, 234, 0.1); border-left: 3px solid #6200ea; border-radius: 4px; font-size: 12px; color: #b0b0b0; line-height: 1.5;">
                                <span data-i18n="Report.AIRefreshHint">ğŸ’¡ æç¤ºï¼šå¯ä»¥é‡æ–°æ•´ç†é é¢ï¼ˆF5ï¼‰ç²å–ä¸åŒç‰ˆæœ¬çš„ AI å»ºè­°</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Open Questions Section -->
                <section class="report-open-questions" id="openQuestionsSection" style="display: none;" data-section="open-questions">
                    <div class="report-card" data-block="open-questions">
                        <div class="section-header">
                            <h2 class="section-title" data-i18n="Report.OpenQuestions">è£œå……èªªæ˜</h2>
                            <p class="section-description" data-i18n="Report.OpenQuestionsDesc">æ‚¨çš„è©³ç´°èªªæ˜èˆ‡è£œå……è³‡è¨Š</p>
                        </div>
                        <div class="open-questions-content">
                            <div class="open-question-item" id="openQ1" style="display: none;">
                                <h4 class="open-question-label" data-i18n="Assessment.OpenQ6">å•é¡Œ 6. è«‹æè¿°æ‚¨çš„å°ˆæ¡ˆé¢è‡¨çš„ä¸»è¦æŒ‘æˆ°</h4>
                                <p class="open-question-answer" id="answer-open1"></p>
                            </div>
                            <div class="open-question-item" id="openQ2" style="display: none;">
                                <h4 class="open-question-label" data-i18n="Assessment.OpenQ7">å•é¡Œ 7. è«‹èªªæ˜æ‚¨æœŸæœ›æ”¹å–„çš„é ˜åŸŸ</h4>
                                <p class="open-question-answer" id="answer-open2"></p>
                            </div>
                            <div class="open-question-item" id="openQ3" style="display: none;">
                                <h4 class="open-question-label" data-i18n="Assessment.OpenQ8">å•é¡Œ 8. è«‹æä¾›å…¶ä»–ç›¸é—œè³‡è¨Š</h4>
                                <p class="open-question-answer" id="answer-open3"></p>
                            </div>
                            <div class="no-open-answers" id="noOpenAnswers" style="display: none;">
                                <p data-i18n="Report.NoOpenAnswers">æœªå¡«å¯«è£œå……èªªæ˜</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- AI Insights Section -->
                <section class="report-ai-insights" id="aiInsightsSection" style="display: none;" data-section="ai-insights">
                    <div class="report-card" data-block="ai-insights">
                        <div class="section-header">
                            <h2 class="section-title" data-i18n="Report.AIInsights">é¢¨éšªæ´å¯Ÿ</h2>
                            <p class="section-description" data-i18n="Report.AIInsightsDesc">é‡å° M6ã€M7ã€M8 è£œå……èªªæ˜çš„æ·±åº¦åˆ†æ</p>
                        </div>
                        <div class="ai-section" id="ai-insights">
                            <div id="insights-loading" data-i18n="Report.Analyzing">åˆ†æä¸­...</div>
                            <div class="ai-refresh-hint" id="aiRefreshHint" style="display: none; margin-top: 12px; padding: 8px 12px; background: rgba(98, 0, 234, 0.1); border-left: 3px solid #6200ea; border-radius: 4px; font-size: 12px; color: #b0b0b0; line-height: 1.5;">
                                <span data-i18n="Report.AIRefreshHint">ğŸ’¡ æç¤ºï¼šå¯ä»¥é‡æ–°æ•´ç†é é¢ï¼ˆF5ï¼‰ç²å–ä¸åŒç‰ˆæœ¬çš„ AI å»ºè­°</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Disclaimer Section -->
                <section class="report-disclaimer" data-section="disclaimer">
                    <div class="report-card" data-block="disclaimer" style="margin-top: 32px; padding: 20px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border-left: 3px solid #6200ea;">
                        <div class="section-header">
                            <h3 class="section-title" style="font-size: 14px; margin-bottom: 12px; color: #e0e0e0;" data-i18n="Report.DisclaimerTitle">æœ¬å ±å‘Šé©ç”¨æ–¼</h3>
                        </div>
                        <div class="disclaimer-content" style="font-size: 12px; line-height: 1.8; color: #b0b0b0;">
                            <div data-i18n="Report.DisclaimerContent" style="white-space: pre-line;">æœ¬å ±å‘Šé©ç”¨æ–¼ï¼š
â€§ è»Ÿé«”å°ˆæ¡ˆé¢¨éšªç›¤é»
â€§ ç³»çµ±äº¤æ¥èˆ‡æ²»ç†æª¢è¦–
ä¸å–ä»£ï¼š
â€§ ç¨½æ ¸
â€§ æ³•è¦èªè­‰
â€§ ç¨‹å¼ç¢¼å®‰å…¨æƒæ</div>
                        </div>
                    </div>
                </section>

                <!-- Actions -->
                <section class="report-actions">
                    <button id="downloadPdfBtn" class="report-button primary" data-i18n="Report.DownloadPDF">
                        ä¸‹è¼‰ PDF å ±å‘Š
                    </button>
                </section>
            </div>
        </div>
    </main>

    <!-- Overlay for mobile -->
    <div class="overlay" id="overlay"></div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        const hamburger = document.getElementById('hamburger');
        const sidebar = document.getElementById('sidebar');
        const sidebarClose = document.getElementById('sidebarClose');
        const overlay = document.getElementById('overlay');
        const navItems = document.querySelectorAll('.nav-item');

        function toggleSidebar() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
        }

        hamburger?.addEventListener('click', toggleSidebar);
        sidebarClose?.addEventListener('click', toggleSidebar);
        overlay?.addEventListener('click', toggleSidebar);

        navItems.forEach(item => {
            item.addEventListener('click', function (e) {
                if (this.getAttribute('href') === '#') {
                    e.preventDefault();
                }

                navItems.forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');

                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });

        window.addEventListener('resize', function () {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // å¾æœå‹™ç«¯ Session æˆ– localStorage è®€å–å•å·æ•¸æ“šï¼ˆå„ªå…ˆä½¿ç”¨ Sessionï¼‰
        async function parseSurveyData() {
            // å„ªå…ˆå˜—è©¦å¾æœå‹™ç«¯ Session è®€å–ï¼ˆæ›´å®‰å…¨ï¼‰
            try {
                const response = await fetch('/Home/GetSurveyData');
                if (response.ok) {
                    const result = await response.json();
                    if (result.success && result.data) {
                        console.log('âœ“ å¾æœå‹™ç«¯ Session è®€å–åˆ°æ•¸æ“š:', result.data);
                        // åŒæ™‚ä¿å­˜æ™‚é–“æˆ³åˆ°è®Šæ•¸ä¸­
                        if (result.timestamp) {
                            window.surveyTimestamp = result.timestamp;
                        }
                        return result.data;
                    }
                }
            } catch (error) {
                console.warn('ç„¡æ³•å¾æœå‹™ç«¯ Session è®€å–æ•¸æ“šï¼Œå˜—è©¦ä½¿ç”¨ localStorage:', error);
            }
            
            // å¦‚æœ Session æ²’æœ‰æ•¸æ“šï¼Œå˜—è©¦å¾ localStorage è®€å–ï¼ˆå‘å¾Œå…¼å®¹ï¼‰
            const raw = localStorage.getItem('survey_data');
            if (raw) {
                try {
                    const data = JSON.parse(raw);
                    if (data && Object.keys(data).length > 0) {
                        console.log('âœ“ å¾ localStorage survey_data è®€å–åˆ°æ•¸æ“š:', data);
                        return data;
                    }
                } catch (e) {
                    console.error('âœ— è§£æ survey_data å¤±æ•—:', e);
                }
            }
            
            // å¦‚æœ survey_data ä¸å­˜åœ¨æˆ–ç‚ºç©ºï¼Œå¾å€‹åˆ¥ localStorage é …ç›®è®€å–
            const data = {};
            const keys = ['M1', 'M2', 'M3', 'M4', 'M5', 'open1', 'open2', 'open3', 'systemName'];
            keys.forEach(key => {
                const value = localStorage.getItem(`survey_${key}`);
                if (value !== null && value !== '') {
                    data[key] = value;
                }
            });
            
            if (Object.keys(data).length > 0) {
                console.log('âœ“ å¾å€‹åˆ¥ localStorage é …ç›®è®€å–åˆ°æ•¸æ“š:', data);
                return data;
            }
            
            console.warn('âš  æœªæ‰¾åˆ°ä»»ä½•å•å·æ•¸æ“š');
            return null;
        }

        function toNumber(value) {
            const n = Number(value);
            return Number.isFinite(n) ? n : 0;
        }

        function computeRiskLevel(avg) {
            // å§‹çµ‚è¿”å›ä¸­æ–‡ï¼Œåœ¨é¡¯ç¤ºæ™‚å†ç¿»è­¯
            if (avg >= 7) return 'ä½';
            if (avg >= 4) return 'ä¸­';
            return 'é«˜';
        }
        
        // ç›£è½èªè¨€è®Šæ›´äº‹ä»¶ï¼Œæ›´æ–°å ±å‘Šå’Œ AI å…§å®¹
        window.addEventListener('languageChanged', async function() {
            // åœ¨ updateReport() ä¹‹å‰ï¼Œå…ˆä¿è­·å·²ç”Ÿæˆçš„å…§å®¹
            // updateReport() æœƒèª¿ç”¨ updatePage()ï¼Œå¯èƒ½è¦†è“‹å·²ç”Ÿæˆçš„å…§å®¹
            const adviceEl = document.getElementById('adviceText');
            const hadGeneratedContent = adviceEl && !adviceEl.hasAttribute('data-i18n');
            
            await updateReport();
            
            // é‡æ–°ç²å– AI å»ºè­°ï¼ˆä½¿ç”¨æ–°èªè¨€ï¼‰
            const surveyData = await parseSurveyData();
            if (surveyData) {
                const toNumber = (value) => {
                    const n = Number(value);
                    return Number.isFinite(n) ? n : 0;
                };
                const m1 = toNumber((surveyData && (surveyData.M1 || surveyData.m1)) || localStorage.getItem('survey_M1') || 0);
                const m2 = toNumber((surveyData && (surveyData.M2 || surveyData.m2)) || localStorage.getItem('survey_M2') || 0);
                const m3 = toNumber((surveyData && (surveyData.M3 || surveyData.m3)) || localStorage.getItem('survey_M3') || 0);
                const m4 = toNumber((surveyData && (surveyData.M4 || surveyData.m4)) || localStorage.getItem('survey_M4') || 0);
                const m5 = toNumber((surveyData && (surveyData.M5 || surveyData.m5)) || localStorage.getItem('survey_M5') || 0);
                
                // é‡æ–°ç”Ÿæˆé¢¨éšªæ”¹å–„å»ºè­°å’Œ AI æ´å¯Ÿï¼ˆä½¿ç”¨æ–°èªè¨€ï¼‰
                generatePersonalizedAdvice(m1, m2, m3, m4, m5);
                // ç¢ºä¿ AI å€å¡Šåœ¨èªè¨€åˆ‡æ›å¾Œæ­£ç¢ºé¡¯ç¤º
                const aiSection = document.getElementById('aiInsightsSection');
                const hasOpenAnswers = (surveyData.open1 && surveyData.open1.trim()) || 
                                      (surveyData.open2 && surveyData.open2.trim()) || 
                                      (surveyData.open3 && surveyData.open3.trim());
                if (hasOpenAnswers && aiSection) {
                    aiSection.style.display = 'block';
                }
                await getAIInsights();
            }
        });

        function updateRadarChart(m1, m2, m3, m4, m5) {
            const centerX = 100;
            const centerY = 100;
            const maxRadius = 80;
            const values = [m1, m2, m3, m4, m5];
            const angles = [-90, -18, 54, 126, 198].map(deg => (deg * Math.PI) / 180);

            const points = values.map((v, i) => {
                const ratio = Math.max(0, Math.min(10, v)) / 10;
                const r = maxRadius * ratio;
                const x = centerX + r * Math.cos(angles[i]);
                const y = centerY + r * Math.sin(angles[i]);
                return `${x},${y}`;
            });

            const polygon = document.getElementById('radarPolygon');
            if (polygon) {
                polygon.setAttribute('points', points.join(' '));
            }
        }

        function formatTimestamp(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            if (isNaN(d.getTime())) return '-';
            // ä½¿ç”¨24å°æ™‚åˆ¶æ ¼å¼ï¼ˆæ—¥æœŸä¸è£œé›¶ï¼Œæ™‚é–“è£œé›¶ï¼‰
            const year = d.getFullYear();
            const month = d.getMonth() + 1;  // ä¸è£œé›¶ï¼š1, 2, ..., 12
            const day = d.getDate();  // ä¸è£œé›¶ï¼š1, 2, ..., 31
            const hours = String(d.getHours()).padStart(2, '0');  // è£œé›¶ï¼š00, 01, ..., 23
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const seconds = String(d.getSeconds()).padStart(2, '0');
            
            // çµ±ä¸€æ ¼å¼ï¼š2026/1/11 00:36:58
            return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
        }

        async function updateReport(forceRegenerate = false) {
            try {
                const data = await parseSurveyData();
            
            // æ›´æ–°ç³»çµ±åç¨±
            const systemNameEl = document.getElementById('systemNameDisplay');
            const pdfSystemNameEl = document.getElementById('pdfSystemNameText');
            const systemName = (data && data.systemName) || localStorage.getItem('survey_systemName') || '-';
            
            if (systemNameEl) {
                systemNameEl.textContent = systemName;
            }
            
            // æ›´æ–°PDFå°ˆç”¨çš„ç³»çµ±åç¨±é¡¯ç¤ºï¼ˆåªåœ¨éœ€è¦ç”ŸæˆPDFæ™‚é¡¯ç¤ºï¼‰
            if (pdfSystemNameEl) {
                pdfSystemNameEl.textContent = systemName;
            }
            
            // æ›´æ–°è©•ä¼°æ—¥æœŸï¼ˆç„¡è«–æ˜¯å¦æœ‰æ•¸æ“šéƒ½é¡¯ç¤ºï¼‰
            const assessmentDateEl = document.getElementById('assessmentDate');
            if (assessmentDateEl) {
                // å„ªå…ˆä½¿ç”¨å¾ Session è®€å–çš„æ™‚é–“æˆ³
                const ts = window.surveyTimestamp || localStorage.getItem('survey_timestamp');
                assessmentDateEl.textContent = formatTimestamp(ts) || '-';
            }
            
            // æª¢æŸ¥æ˜¯å¦æœ‰æœ‰æ•ˆçš„å•å·æ•¸æ“šï¼ˆè‡³å°‘æœ‰ä¸€å€‹ M åˆ†æ•¸ï¼‰
            const hasValidData = data && (data.M1 || data.M2 || data.M3 || data.M4 || data.M5 || 
                                          data.m1 || data.m2 || data.m3 || data.m4 || data.m5);
            
            if (!hasValidData) {
                // æ²’æœ‰å•å·æ•¸æ“šï¼Œé¡¯ç¤ºå¼•å°é é¢ï¼Œéš±è—å ±å‘Šå…§å®¹
                const reportContent = document.getElementById('reportContent');
                const noReportGuide = document.getElementById('noReportGuide');
                const reportActions = document.querySelector('.report-actions');
                
                if (reportContent) {
                    reportContent.style.display = 'none';
                }
                if (noReportGuide) {
                    noReportGuide.style.display = 'flex';
                }
                if (reportActions) {
                    reportActions.style.display = 'none';
                }
                return;
            }
            
            // æœ‰æ•¸æ“šï¼Œé¡¯ç¤ºå ±å‘Šå…§å®¹ï¼Œéš±è—å¼•å°é é¢
            const reportContent = document.getElementById('reportContent');
            const noReportGuide = document.getElementById('noReportGuide');
            const reportActions = document.querySelector('.report-actions');
            
            if (reportContent) {
                reportContent.style.display = 'flex';
            }
            if (noReportGuide) {
                noReportGuide.style.display = 'none';
            }
            if (reportActions) {
                reportActions.style.display = 'flex';
            }

            console.log('è™•ç†å•å·æ•¸æ“š:', data);

            // ç¢ºä¿æ‰€æœ‰å€¼éƒ½å­˜åœ¨ï¼Œå¦‚æœæ²’æœ‰å‰‡ä½¿ç”¨ 0
            const m1 = toNumber(data.M1 || data.m1 || 0);
            const m2 = toNumber(data.M2 || data.m2 || 0);
            const m3 = toNumber(data.M3 || data.m3 || 0);
            const m4 = toNumber(data.M4 || data.m4 || 0);
            const m5 = toNumber(data.M5 || data.m5 || 0);
            
            console.log('M1-M5 åˆ†æ•¸:', { m1, m2, m3, m4, m5 });
            console.log('åŸå§‹æ•¸æ“š:', data);

            const total = m1 + m2 + m3 + m4 + m5;
            const avg = total / 5;
            const level = computeRiskLevel(avg);

            const totalScoreEl = document.getElementById('totalScore');
            if (totalScoreEl) {
                totalScoreEl.textContent = total.toFixed(1);
            }
            
            const levelEl = document.getElementById('riskLevel');
            if (levelEl) {
                // é¢¨éšªç­‰ç´šç¿»è­¯
                const levelMap = {
                    'zh-TW': { 'ä½': 'ä½', 'ä¸­': 'ä¸­', 'é«˜': 'é«˜' },
                    'en-US': { 'ä½': 'Low', 'ä¸­': 'Medium', 'é«˜': 'High' }
                };
                levelEl.textContent = levelMap[i18n.currentLang]?.[level] || level;
                levelEl.classList.remove('low', 'medium', 'high');
                if (level === 'ä½') levelEl.classList.add('low');
                else if (level === 'ä¸­') levelEl.classList.add('medium');
                else levelEl.classList.add('high');
            }

            // æ›´æ–°å»ºè­°è¡Œå‹•
            const actionEl = document.getElementById('riskAction');
            if (actionEl) {
                const actionMap = {
                    'zh-TW': {
                        'é«˜': 'å»ºè­°æ–¼ 1â€“2 å€‹æœˆå…§å•Ÿå‹•æ”¹å–„',
                        'ä¸­': 'å»ºè­°ç´å…¥å­£åº¦æª¢è¦–',
                        'ä½': 'å»ºè­°åŠå¹´è¤‡æŸ¥'
                    },
                    'en-US': {
                        'é«˜': 'Recommend initiating improvements within 1â€“2 months',
                        'ä¸­': 'Recommend quarterly review',
                        'ä½': 'Recommend semi-annual review'
                    }
                };
                const currentLang = i18n.currentLang || 'zh-TW';
                actionEl.textContent = actionMap[currentLang]?.[level] || '';
            }

            const ts = window.surveyTimestamp || localStorage.getItem('survey_timestamp');
            const surveyTimeEl = document.getElementById('surveyTime');
            if (surveyTimeEl) {
                surveyTimeEl.textContent = formatTimestamp(ts);
            }
            
            // æ›´æ–°è©•ä¼°æ—¥æœŸ
            if (assessmentDateEl) {
                assessmentDateEl.textContent = formatTimestamp(ts);
            }

            // é¢¨éšªæ”¹å–„å»ºè­°æ”¹ç‚º AI ç”Ÿæˆ
            const adviceEl = document.getElementById('adviceText');
            if (adviceEl) {
                // å¦‚æœå¼·åˆ¶é‡æ–°ç”Ÿæˆï¼Œæ¸…é™¤å·²ç”Ÿæˆçš„å…§å®¹
                if (forceRegenerate) {
                    adviceEl.setAttribute('data-i18n', 'Report.DefaultAdvice');
                    adviceEl.textContent = i18n.t('Report.DefaultAdvice');
                }
                // åªæœ‰åœ¨æ²’æœ‰å·²ç”Ÿæˆçš„å…§å®¹æ™‚æ‰è¨­ç½®é è¨­å€¼
                // å¦‚æœå…ƒç´ æ²’æœ‰ data-i18n å±¬æ€§ï¼Œèªªæ˜å·²ç¶“æœ‰ç”Ÿæˆçš„å…§å®¹ï¼Œä¸è¦è¦†è“‹
                if (adviceEl.hasAttribute('data-i18n')) {
                    adviceEl.textContent = i18n.t('Report.DefaultAdvice');
                }
                // ç•°æ­¥ç²å– AI å»ºè­°ï¼ˆæœƒæ›´æ–°å…§å®¹ä¸¦ç§»é™¤ data-i18n å±¬æ€§ï¼‰
                generatePersonalizedAdvice(m1, m2, m3, m4, m5, forceRegenerate);
            }

            updateRadarChart(m1, m2, m3, m4, m5);

            // æ›´æ–°åˆ†æ•¸èªªæ˜è¡¨
            updateScoreDescriptionTable(m1, m2, m3, m4, m5);

            // Update open questions (è£œå……èªªæ˜)
            updateOpenQuestions(data);
            
            // å¦‚æœæœ‰è£œå……èªªæ˜ï¼Œè§¸ç™¼ AI åˆ†æï¼ˆæ³¨æ„ï¼šä¸è¦åœ¨ updateReport ä¸­èª¿ç”¨ï¼Œé¿å…é‡è¤‡ï¼‰
            // getAIInsights() æœƒåœ¨é é¢åˆå§‹åŒ–æ™‚å–®ç¨èª¿ç”¨
            } catch (error) {
                console.error('updateReport éŒ¯èª¤:', error);
                // ç™¼ç”ŸéŒ¯èª¤æ™‚ï¼Œè‡³å°‘é¡¯ç¤ºå¼•å°é é¢
                const reportContent = document.getElementById('reportContent');
                const noReportGuide = document.getElementById('noReportGuide');
                if (reportContent) {
                    reportContent.style.display = 'none';
                }
                if (noReportGuide) {
                    noReportGuide.style.display = 'flex';
                }
            }
        }

        function updateScoreDescriptionTable(m1, m2, m3, m4, m5) {
            const tableBody = document.getElementById('scoreTableBody');
            const scoreTable = document.getElementById('scoreDescriptionTable');
            
            if (!tableBody || !scoreTable) return;

            // æŒ‡æ¨™é…ç½®
            const metrics = [
                { key: 'M1', label: 'M1 äº¤æ¥', value: m1, i18nKey: 'Report.RadarM1' },
                { key: 'M2', label: 'M2 è¿½æº¯', value: m2, i18nKey: 'Report.RadarM2' },
                { key: 'M3', label: 'M3 è®Šæ›´', value: m3, i18nKey: 'Report.RadarM3' },
                { key: 'M4', label: 'M4 é©—æ”¶', value: m4, i18nKey: 'Report.RadarM4' },
                { key: 'M5', label: 'M5 æºé€š', value: m5, i18nKey: 'Report.RadarM5' }
            ];

            // æ¸…ç©ºè¡¨æ ¼å…§å®¹
            tableBody.innerHTML = '';

            // å¡«å……è¡¨æ ¼
            metrics.forEach(metric => {
                const description = i18n.getScoreDescription(metric.key, metric.value);
                const label = i18n.t(metric.i18nKey);
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid rgba(255, 255, 255, 0.05)';
                
                row.innerHTML = `
                    <td style="padding: 10px 8px; color: #e0e0e0;">${label}</td>
                    <td style="padding: 10px 8px; text-align: center; color: #ffffff; font-weight: 600;">${metric.value.toFixed(1)}</td>
                    <td style="padding: 10px 8px; color: #b0b0b0; line-height: 1.5;">${description || '-'}</td>
                `;
                
                tableBody.appendChild(row);
            });

            // é¡¯ç¤ºè¡¨æ ¼
            scoreTable.style.display = 'block';
        }

        function updateOpenQuestions(data) {
            const openQuestionsSection = document.getElementById('openQuestionsSection');
            const noOpenAnswers = document.getElementById('noOpenAnswers');
            let hasAnswers = false;

            // Check and display open1
            if (data.open1 && data.open1.trim()) {
                const answerEl = document.getElementById('answer-open1');
                const questionEl = document.getElementById('openQ1');
                if (answerEl && questionEl) {
                    answerEl.textContent = data.open1;
                    questionEl.style.display = 'block';
                    hasAnswers = true;
                }
            } else {
                const questionEl = document.getElementById('openQ1');
                if (questionEl) questionEl.style.display = 'none';
            }

            // Check and display open2
            if (data.open2 && data.open2.trim()) {
                const answerEl = document.getElementById('answer-open2');
                const questionEl = document.getElementById('openQ2');
                if (answerEl && questionEl) {
                    answerEl.textContent = data.open2;
                    questionEl.style.display = 'block';
                    hasAnswers = true;
                }
            } else {
                const questionEl = document.getElementById('openQ2');
                if (questionEl) questionEl.style.display = 'none';
            }

            // Check and display open3
            if (data.open3 && data.open3.trim()) {
                const answerEl = document.getElementById('answer-open3');
                const questionEl = document.getElementById('openQ3');
                if (answerEl && questionEl) {
                    answerEl.textContent = data.open3;
                    questionEl.style.display = 'block';
                    hasAnswers = true;
                }
            } else {
                const questionEl = document.getElementById('openQ3');
                if (questionEl) questionEl.style.display = 'none';
            }

            // Show/hide section
            if (openQuestionsSection) {
                if (hasAnswers) {
                    openQuestionsSection.style.display = 'block';
                    if (noOpenAnswers) noOpenAnswers.style.display = 'none';
                } else {
                    openQuestionsSection.style.display = 'none';
                }
            }
        }

        // AI Insights å‡½æ•¸
        async function getAIInsights(forceRegenerate = false) {
            try {
                const aiSection = document.getElementById('aiInsightsSection');
                const insightsLoading = document.getElementById('insights-loading');
                
                if (!aiSection || !insightsLoading) {
                    console.warn('AI å€å¡Šå…ƒç´ æœªæ‰¾åˆ°');
                    return;
                }
                
                // å¾ç¾æœ‰æ•¸æ“šæºè®€å–è£œå……èªªæ˜ï¼ˆopen1, open2, open3 å°æ‡‰ m6, m7, m8ï¼‰
                const surveyData = await parseSurveyData();
                
                // æå–è£œå……èªªæ˜
                const m6 = (surveyData && surveyData.open1) || localStorage.getItem('survey_open1') || '';
                const m7 = (surveyData && surveyData.open2) || localStorage.getItem('survey_open2') || '';
                const m8 = (surveyData && surveyData.open3) || localStorage.getItem('survey_open3') || '';
                
                // æª¢æŸ¥æ˜¯å¦æœ‰ä»»ä½•è£œå……èªªæ˜
                const hasOpenAnswers = (m6 && m6.trim()) || (m7 && m7.trim()) || (m8 && m8.trim());
                
                if (!hasOpenAnswers) {
                    console.log('æœªæ‰¾åˆ°è£œå……èªªæ˜ï¼Œéš±è— AI å€å¡Š');
                    aiSection.style.display = 'none';
                    return;
                }
                
                // æå– M1-M5 åˆ†æ•¸ä½œç‚ºä¸Šä¸‹æ–‡
                const toNumber = (value) => {
                    const n = Number(value);
                    return Number.isFinite(n) ? n : 0;
                };
                
                const m1 = toNumber((surveyData && (surveyData.M1 || surveyData.m1)) || localStorage.getItem('survey_M1') || 0);
                const m2 = toNumber((surveyData && (surveyData.M2 || surveyData.m2)) || localStorage.getItem('survey_M2') || 0);
                const m3 = toNumber((surveyData && (surveyData.M3 || surveyData.m3)) || localStorage.getItem('survey_M3') || 0);
                const m4 = toNumber((surveyData && (surveyData.M4 || surveyData.m4)) || localStorage.getItem('survey_M4') || 0);
                const m5 = toNumber((surveyData && (surveyData.M5 || surveyData.m5)) || localStorage.getItem('survey_M5') || 0);
                
                // é¡¯ç¤ºå€å¡Šä¸¦é–‹å§‹è¼‰å…¥
                console.log('æ‰¾åˆ°è£œå……èªªæ˜ï¼Œé–‹å§‹ AI åˆ†æ...', { m1, m2, m3, m4, m5, m6, m7, m8 });
                aiSection.style.display = 'block';
                const currentLang = i18n.currentLang || 'zh-TW';
                insightsLoading.textContent = currentLang === 'zh-TW' ? 'åˆ†æä¸­...' : 'Analyzing...';
                
                // æ§‹å»ºè«‹æ±‚æ•¸æ“šï¼ˆåŒ…å« M1-M5 åˆ†æ•¸å’Œ M6-M8 è£œå……èªªæ˜ï¼‰
                const m678Data = {
                    lang: currentLang,
                    forceRegenerate: forceRegenerate ? 'true' : 'false',
                    m1: String(m1),
                    m2: String(m2),
                    m3: String(m3),
                    m4: String(m4),
                    m5: String(m5),
                    m6: m6 || '',
                    m7: m7 || '',
                    m8: m8 || ''
                };
                
                console.log('ç™¼é€ AI è«‹æ±‚æ•¸æ“š:', m678Data);
                
                // å‰µå»º AbortController ç”¨æ–¼è¶…æ™‚æ§åˆ¶
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 65000); // 65 ç§’è¶…æ™‚ï¼ˆæ¯”å¾Œç«¯çš„ 60 ç§’é•·ä¸€é»ï¼‰
                
                try {
                    const response = await fetch('/Home/GenerateInsights', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(m678Data),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('AI API éŸ¿æ‡‰éŒ¯èª¤:', response.status, errorText);
                        throw new Error(`ç„¡æ³•ç²å– AI æ´å¯Ÿ (${response.status}): ${errorText.substring(0, 200)}`);
                    }
                    
                    const data = await response.json();
                    console.log('AI åˆ†æçµæœ:', data);
                    console.log('AI æ´å¯Ÿå…§å®¹:', data.insights);
                    
                    // ä½¿ç”¨ requestAnimationFrame ç¢ºä¿ DOM å·²æ›´æ–°
                    await new Promise(resolve => requestAnimationFrame(resolve));
                    
                    // ç¢ºä¿ insightsLoading å…ƒç´ ä»ç„¶å­˜åœ¨ï¼ˆå¯èƒ½åœ¨å‹•æ…‹æ›´æ–°éç¨‹ä¸­ï¼‰
                    let currentInsightsLoading = document.getElementById('insights-loading');
                    
                    // å¦‚æœæ‰¾ä¸åˆ°å…ƒç´ ï¼Œå˜—è©¦å¾ aiSection ä¸­æŸ¥æ‰¾
                    if (!currentInsightsLoading) {
                        console.warn('insights-loading å…ƒç´ ä¸å­˜åœ¨ï¼Œå˜—è©¦é‡æ–°æŸ¥æ‰¾');
                        const aiSection = document.getElementById('aiInsightsSection');
                        if (aiSection) {
                            currentInsightsLoading = aiSection.querySelector('#insights-loading');
                        }
                    }
                    
                    if (!currentInsightsLoading) {
                        console.error('ç„¡æ³•æ‰¾åˆ° insights-loading å…ƒç´ ï¼Œç„¡æ³•æ›´æ–°');
                        return;
                    }
                    
                    if (data.insights && data.insights.trim()) {
                        // é¡¯ç¤º AI æ´å¯Ÿå…§å®¹ï¼Œä¿ç•™æ›è¡Œå’Œæ ¼å¼
                        console.log('æ›´æ–° AI æ´å¯Ÿå…§å®¹åˆ°å…ƒç´ ');
                        
                        // ç§»é™¤ data-i18n å±¬æ€§ï¼Œé¿å… i18n.updatePage() è¦†è“‹å…§å®¹
                        currentInsightsLoading.removeAttribute('data-i18n');
                        
                        // æ›´æ–°å…§å®¹
                        currentInsightsLoading.innerHTML = data.insights.replace(/\n/g, '<br>');
                        
                        // å¼·åˆ¶è§¸ç™¼é‡æ’ï¼Œç¢ºä¿å…§å®¹é¡¯ç¤º
                        currentInsightsLoading.offsetHeight;
                        
                        // é¡¯ç¤ºå¾Œï¼Œé¡¯ç¤ºåˆ·æ–°æç¤ºï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                        const refreshHint = document.getElementById('aiRefreshHint');
                        if (refreshHint) {
                            refreshHint.style.display = 'block';
                            // ç¢ºä¿æç¤ºæ–‡å­—ä¹Ÿæ›´æ–°èªè¨€ï¼ˆä½†ä¸æœƒå½±éŸ¿å·²æ›´æ–°çš„ AI å…§å®¹ï¼‰
                            i18n.updatePage();
                        }
                        
                        console.log('âœ“ AI æ´å¯Ÿå…§å®¹å·²æˆåŠŸæ›´æ–°');
                    } else {
                        console.warn('AI æ´å¯Ÿå…§å®¹ç‚ºç©º');
                        const currentLang = i18n.currentLang || 'zh-TW';
                        // ç§»é™¤ data-i18n å±¬æ€§ï¼Œé¿å…è¢«è¦†è“‹
                        currentInsightsLoading.removeAttribute('data-i18n');
                        currentInsightsLoading.textContent = currentLang === 'zh-TW' 
                            ? 'æš«æ™‚ç„¡æ³•ç”Ÿæˆ AI æ´å¯Ÿ' 
                            : 'Unable to generate AI insights';
                    }
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        throw new Error('è«‹æ±‚è¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦');
                    }
                    throw fetchError;
                }
            } catch (error) {
                console.error('AI æ´å¯Ÿè¼‰å…¥éŒ¯èª¤:', error);
                const insightsLoading = document.getElementById('insights-loading');
                const currentLang = i18n.currentLang || 'zh-TW';
                if (insightsLoading) {
                    // ç§»é™¤ data-i18n å±¬æ€§ï¼Œé¿å…è¢«è¦†è“‹
                    insightsLoading.removeAttribute('data-i18n');
                    let errorMsg;
                    if (error.message.includes('è¶…æ™‚') || error.message.includes('timeout')) {
                        errorMsg = currentLang === 'zh-TW'
                            ? 'AI åˆ†æè«‹æ±‚è¶…æ™‚ï¼Œè«‹é‡æ–°æ•´ç†é é¢å¾Œå†è©¦'
                            : 'AI analysis request timed out, please refresh and try again';
                    } else {
                        errorMsg = currentLang === 'zh-TW'
                            ? `AI æ´å¯Ÿè¼‰å…¥å¤±æ•—ï¼š${error.message}`
                            : `Failed to load AI insights: ${error.message}`;
                    }
                    insightsLoading.innerHTML = `<span style="color: #ff6b6b;">${errorMsg}</span>`;
                }
                // å³ä½¿å‡ºéŒ¯ä¹Ÿé¡¯ç¤ºå€å¡Šï¼Œè®“ç”¨æˆ¶çŸ¥é“æœ‰å•é¡Œ
                const aiSection = document.getElementById('aiInsightsSection');
                if (aiSection) {
                    aiSection.style.display = 'block';
                }
            }
        }

        // æ ¼å¼åŒ–é¢¨éšªæ”¹å–„å»ºè­°æ–‡æœ¬ï¼ˆå°‡æ¢åˆ—å¼å…§å®¹è½‰æ›ç‚ºåˆ†æ®µæ’ç‰ˆï¼‰
        function formatAdviceText(text) {
            if (!text) return '';
            
            // å°‡æ–‡æœ¬æŒ‰è¡Œåˆ†å‰²
            const lines = text.split('\n').filter(line => line.trim());
            let html = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // æª¢æŸ¥æ˜¯å¦ç‚ºæ¢åˆ—å¼é–‹é ­ï¼ˆæ•¸å­—ã€â€¢ã€-ã€* ç­‰ï¼‰
                const isListItem = /^(\d+[\.\)]|[\u2022\u2023\u25E6\u2043\u2219â€¢\-\*])\s/.test(line) || 
                                   /^ã€/.test(line) || 
                                   /^[A-Z][a-z]+ \d+:/.test(line); // åŒ¹é… "Recommendation 1:" æ ¼å¼
                
                if (isListItem) {
                    // æ¢åˆ—å¼é …ç›®ï¼Œä½¿ç”¨æ®µè½ä¸¦æ·»åŠ é©ç•¶çš„æ¨£å¼
                    html += `<p style="margin: 8px 0; padding-left: 16px; line-height: 1.6;">${escapeHtml(line)}</p>`;
                } else {
                    // æ™®é€šæ®µè½
                    html += `<p style="margin: 8px 0; line-height: 1.6;">${escapeHtml(line)}</p>`;
                }
            }
            
            return html || escapeHtml(text);
        }
        
        // HTML è½‰ç¾©å‡½æ•¸
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é¢¨éšªæ”¹å–„å»ºè­° AI ç”Ÿæˆå‡½æ•¸
        async function generatePersonalizedAdvice(m1, m2, m3, m4, m5, forceRegenerate = false) {
            try {
                const adviceEl = document.getElementById('adviceText');
                if (!adviceEl) return;

                const currentLang = i18n.currentLang || 'zh-TW';
                adviceEl.textContent = currentLang === 'zh-TW' ? 'ç”Ÿæˆä¸­...' : 'Generating...';

                const adviceData = {
                    lang: currentLang,
                    forceRegenerate: forceRegenerate ? 'true' : 'false',
                    m1: String(m1),
                    m2: String(m2),
                    m3: String(m3),
                    m4: String(m4),
                    m5: String(m5)
                };

                const response = await fetch('/Home/GeneratePersonalizedAdvice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(adviceData)
                });

                if (!response.ok) {
                    throw new Error(`ç„¡æ³•ç²å–é¢¨éšªæ”¹å–„å»ºè­° (${response.status})`);
                }

                const data = await response.json();
                if (data.advice) {
                    // ç§»é™¤ data-i18n å±¬æ€§ï¼Œé¿å… i18n.updatePage() è¦†è“‹å…§å®¹
                    adviceEl.removeAttribute('data-i18n');
                    // å°‡æ¢åˆ—å¼å…§å®¹è½‰æ›ç‚ºåˆ†æ®µæ’ç‰ˆï¼ˆå°‡æ•¸å­—é–‹é ­çš„è¡Œå’Œæ¢åˆ—ç¬¦è™Ÿè½‰æ›ç‚ºæ®µè½ï¼‰
                    const formattedAdvice = formatAdviceText(data.advice);
                    adviceEl.innerHTML = formattedAdvice;
                    
                    // é¡¯ç¤º F5 æç¤º
                    const refreshHint = document.getElementById('adviceRefreshHint');
                    if (refreshHint) {
                        refreshHint.style.display = 'block';
                    }
                } else {
                    // ç§»é™¤ data-i18n å±¬æ€§ï¼Œé¿å…è¢«è¦†è“‹
                    adviceEl.removeAttribute('data-i18n');
                    adviceEl.textContent = currentLang === 'zh-TW'
                        ? 'æš«æ™‚ç„¡æ³•ç”Ÿæˆé¢¨éšªæ”¹å–„å»ºè­°'
                        : 'Unable to generate risk improvement recommendations';
                }
            } catch (error) {
                console.error('é¢¨éšªæ”¹å–„å»ºè­°è¼‰å…¥éŒ¯èª¤:', error);
                const adviceEl = document.getElementById('adviceText');
                const currentLang = i18n.currentLang || 'zh-TW';
                if (adviceEl) {
                    // ç§»é™¤ data-i18n å±¬æ€§ï¼Œé¿å…è¢«è¦†è“‹
                    adviceEl.removeAttribute('data-i18n');
                    adviceEl.textContent = currentLang === 'zh-TW'
                        ? 'é¢¨éšªæ”¹å–„å»ºè­°è¼‰å…¥å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦'
                        : 'Failed to load risk improvement recommendations, please try again later';
                }
            }
        }

        // æ·»åŠ é é¦–é å°¾çš„è¼”åŠ©å‡½æ•¸
        function addHeaderFooter(pdf, pageNumber, totalPages, systemName) {
            // ç¢ºä¿é é¢å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡ä¸æ·»åŠ é é¦–é å°¾
            const currentTotalPages = pdf.internal.getNumberOfPages();
            if (pageNumber > currentTotalPages) {
                console.warn(`é é¢ ${pageNumber} ä¸å­˜åœ¨ï¼Œè·³éæ·»åŠ é é¦–é å°¾`);
                return;
            }
            
            // è¨˜éŒ„æ·»åŠ é é¦–é å°¾å‰çš„é æ•¸ï¼Œç¢ºä¿ä¸æœƒå‰µå»ºæ–°é é¢
            const pagesBefore = pdf.internal.getNumberOfPages();
            
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 10;
            const headerHeight = 15;
            const footerHeight = 15;
            
            // ä¿å­˜ç•¶å‰ç‹€æ…‹
            pdf.saveGraphicsState();
            
            // ç¢ºä¿è¨­ç½®åˆ°æ­£ç¢ºçš„é é¢ï¼ˆä¸å‰µå»ºæ–°é é¢ï¼‰
            try {
                pdf.setPage(pageNumber);
            } catch (e) {
                console.warn(`ç„¡æ³•è¨­ç½®åˆ°é é¢ ${pageNumber}:`, e);
                pdf.restoreGraphicsState();
                return;
            }
            
            // é é¦–
            pdf.setDrawColor(200, 200, 200);
            pdf.setLineWidth(0.1);
            pdf.line(margin, margin + headerHeight, pageWidth - margin, margin + headerHeight);
            
            pdf.setTextColor(100, 100, 100);
            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'normal');
            
            // å·¦å´ï¼šç³»çµ±åç¨±ï¼ˆå¦‚æœæ˜¯ä¸­æ–‡ï¼Œä½¿ç”¨ canvas æ¸²æŸ“ç‚ºåœ–ç‰‡ï¼‰
            if (systemName) {
                // æª¢æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
                const hasChinese = /[\u4e00-\u9fa5]/.test(systemName);
                
                if (hasChinese) {
                    // ä½¿ç”¨ canvas åŒæ­¥æ¸²æŸ“ä¸­æ–‡æ–‡å­—ç‚ºåœ–ç‰‡
                    try {
                        const textCanvas = document.createElement('canvas');
                        const ctx = textCanvas.getContext('2d');
                        
                        // è¨­ç½®å­—é«”å’Œæ¨£å¼ï¼ˆä½¿ç”¨æ”¯æŒä¸­æ–‡çš„å­—é«”ï¼‰
                        const fontSize = 8;
                        // å˜—è©¦ä½¿ç”¨ç³»çµ±æ”¯æŒä¸­æ–‡çš„å­—é«”
                        ctx.font = `${fontSize}px "Microsoft YaHei", "SimHei", "PingFang SC", "Hiragino Sans GB", "WenQuanYi Micro Hei", Arial, sans-serif`;
                        ctx.fillStyle = 'rgb(100, 100, 100)';
                        ctx.textBaseline = 'top';
                        
                        // è¨ˆç®—æ–‡å­—å¯¬åº¦ï¼ˆå°æ–¼ä¸­æ–‡ï¼ŒmeasureText å¯èƒ½ä¸æº–ç¢ºï¼Œä½¿ç”¨æ›´å¤§çš„å¯¬åº¦ï¼‰
                        let textWidth = 0;
                        for (let i = 0; i < systemName.length; i++) {
                            const char = systemName[i];
                            if (/[\u4e00-\u9fa5]/.test(char)) {
                                // ä¸­æ–‡å­—ç¬¦ï¼Œå¤§ç´„æ˜¯å­—é«”å¤§å°çš„ 1.2 å€
                                textWidth += fontSize * 1.2;
                            } else {
                                textWidth += ctx.measureText(char).width;
                            }
                        }
                        
                        textCanvas.width = Math.ceil(textWidth) + 4;
                        textCanvas.height = fontSize + 4;
                        
                        // é‡æ–°è¨­ç½®å­—é«”ï¼ˆcanvas å¤§å°æ”¹è®Šå¾Œéœ€è¦é‡æ–°è¨­ç½®ï¼‰
                        ctx.font = `${fontSize}px "Microsoft YaHei", "SimHei", "PingFang SC", "Hiragino Sans GB", "WenQuanYi Micro Hei", Arial, sans-serif`;
                        ctx.fillStyle = 'rgb(100, 100, 100)';
                        ctx.textBaseline = 'top';
                        
                        // ç¹ªè£½æ–‡å­—
                        ctx.fillText(systemName, 2, 2);
                        
                        // è½‰æ›ç‚ºåœ–ç‰‡ä¸¦æ·»åŠ åˆ° PDF
                        const nameImgData = textCanvas.toDataURL('image/png');
                        const nameImgWidth = (textCanvas.width * 0.264583); // px to mm (96 DPI)
                        const nameImgHeight = (textCanvas.height * 0.264583);
                        pdf.addImage(nameImgData, 'PNG', margin, margin + 5, nameImgWidth, nameImgHeight);
                    } catch (e) {
                        console.warn('ä¸­æ–‡ç³»çµ±åç¨±æ¸²æŸ“å¤±æ•—:', e);
                        // å¦‚æœå¤±æ•—ï¼Œè·³éï¼ˆç³»çµ±åç¨±å·²åœ¨å ±å‘Šå…§å®¹ä¸­é¡¯ç¤ºï¼‰
                    }
                } else {
                    // æ²’æœ‰ä¸­æ–‡ï¼Œç›´æ¥é¡¯ç¤º
                    pdf.text(systemName, margin, margin + 10);
                }
            }
            
            // å³å´ï¼šSmart Sequence Tech
            const headerText = 'Smart Sequence Tech';
            const headerTextWidth = pdf.getTextWidth(headerText);
            pdf.text(headerText, pageWidth - margin - headerTextWidth, margin + 10);
            
            // é å°¾
            pdf.setDrawColor(200, 200, 200);
            pdf.line(margin, pageHeight - margin - footerHeight, pageWidth - margin, pageHeight - margin - footerHeight);
            
            // å·¦å´ï¼šé ç¢¼ï¼ˆæ ¹æ“šèªè¨€é¡¯ç¤ºï¼‰
            const currentLang = i18n.currentLang || 'zh-TW';
            const pageText = currentLang === 'zh-TW' 
                ? `ç¬¬ ${pageNumber} é  / å…± ${totalPages} é `
                : `Page ${pageNumber} / ${totalPages}`;
            
            // æª¢æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡ï¼Œå¦‚æœåŒ…å«å‰‡ä½¿ç”¨ Canvas æ¸²æŸ“
            const hasChinese = /[\u4e00-\u9fa5]/.test(pageText);
            if (hasChinese) {
                try {
                    // ä½¿ç”¨ Canvas æ¸²æŸ“ä¸­æ–‡é ç¢¼
                    const textCanvas = document.createElement('canvas');
                    const ctx = textCanvas.getContext('2d');
                    if (!ctx) throw new Error('ç„¡æ³•ç²å– canvas context');
                    
                    const fontSize = 9;
                    ctx.font = `${fontSize}px "Microsoft YaHei", "SimHei", "PingFang SC", "Hiragino Sans GB", "WenQuanYi Micro Hei", Arial, sans-serif`;
                    ctx.fillStyle = 'rgb(100, 100, 100)';
                    ctx.textBaseline = 'top';
                    
                    // è¨ˆç®—æ–‡å­—å¯¬åº¦
                    let textWidth = 0;
                    for (let i = 0; i < pageText.length; i++) {
                        const char = pageText[i];
                        if (/[\u4e00-\u9fa5]/.test(char)) {
                            textWidth += fontSize * 1.2;
                        } else {
                            textWidth += ctx.measureText(char).width;
                        }
                    }
                    
                    textCanvas.width = Math.ceil(textWidth) + 4;
                    textCanvas.height = fontSize + 4;
                    
                    // é‡æ–°è¨­ç½®å­—é«”
                    ctx.font = `${fontSize}px "Microsoft YaHei", "SimHei", "PingFang SC", "Hiragino Sans GB", "WenQuanYi Micro Hei", Arial, sans-serif`;
                    ctx.fillStyle = 'rgb(100, 100, 100)';
                    ctx.textBaseline = 'top';
                    
                    // ç¹ªè£½æ–‡å­—
                    ctx.fillText(pageText, 2, 2);
                    
                    // è½‰æ›ç‚ºåœ–ç‰‡ä¸¦æ·»åŠ åˆ° PDF
                    const pageImgData = textCanvas.toDataURL('image/png');
                    const pageImgWidth = (textCanvas.width * 0.264583); // px to mm
                    const pageImgHeight = (textCanvas.height * 0.264583);
                    pdf.addImage(pageImgData, 'PNG', margin, pageHeight - margin - 5 - pageImgHeight, pageImgWidth, pageImgHeight);
                } catch (e) {
                    console.warn('ä¸­æ–‡é ç¢¼æ¸²æŸ“å¤±æ•—ï¼Œä½¿ç”¨è‹±æ–‡:', e);
                    // å¦‚æœå¤±æ•—ï¼Œä½¿ç”¨è‹±æ–‡
                    pdf.text(`Page ${pageNumber} / ${totalPages}`, margin, pageHeight - margin - 5);
                }
            } else {
                // æ²’æœ‰ä¸­æ–‡ï¼Œç›´æ¥é¡¯ç¤º
                pdf.text(pageText, margin, pageHeight - margin - 5);
            }
            
            // å³å´ï¼šç‰ˆæ¬Šä¿¡æ¯
            const footerText = 'Â© Smart Sequence Tech';
            const footerTextWidth = pdf.getTextWidth(footerText);
            pdf.text(footerText, pageWidth - margin - footerTextWidth, pageHeight - margin - 5);
            
            // æ¢å¾©ç‹€æ…‹
            pdf.restoreGraphicsState();
            
            // æª¢æŸ¥æ˜¯å¦æ„å¤–å‰µå»ºäº†æ–°é é¢
            const pagesAfter = pdf.internal.getNumberOfPages();
            if (pagesAfter > pagesBefore) {
                console.warn(`æ·»åŠ é é¦–é å°¾å¾Œé æ•¸å¢åŠ  (${pagesAfter} > ${pagesBefore})ï¼Œåˆªé™¤å¤šé¤˜é é¢`);
                for (let extraPage = pagesAfter; extraPage > pagesBefore; extraPage--) {
                    try {
                        pdf.deletePage(extraPage);
                        console.log(`å·²åˆªé™¤æ„å¤–å‰µå»ºçš„é é¢ ${extraPage}`);
                    } catch (e) {
                        console.warn(`ç„¡æ³•åˆªé™¤æ„å¤–å‰µå»ºçš„é é¢ ${extraPage}:`, e);
                    }
                }
            }
            
            return headerHeight + footerHeight;
        }

        // ç”Ÿæˆ PDF åˆ†æ•¸è¡¨æ ¼è¡Œçš„è¼”åŠ©å‡½æ•¸
        function generateScoreTableRows(m1, m2, m3, m4, m5) {
            const metrics = [
                { key: 'M1', value: m1, label: i18n.t('Report.RadarM1') },
                { key: 'M2', value: m2, label: i18n.t('Report.RadarM2') },
                { key: 'M3', value: m3, label: i18n.t('Report.RadarM3') },
                { key: 'M4', value: m4, label: i18n.t('Report.RadarM4') },
                { key: 'M5', value: m5, label: i18n.t('Report.RadarM5') }
            ];

            return metrics.map(metric => {
                const description = i18n.getScoreDescription(metric.key, metric.value);
                return `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 8px 4px; color: #333;">${metric.label}</td>
                        <td style="padding: 8px 4px; text-align: center; color: #333; font-weight: 600;">${metric.value.toFixed(1)}</td>
                        <td style="padding: 8px 4px; color: #666; line-height: 1.4;">${description || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // å‰µå»º PDF å°ˆç”¨çš„å…§å®¹çµæ§‹
        async function createPdfContent() {
            const data = await parseSurveyData();
            if (!data) return null;

            const systemName = (data && data.systemName) || localStorage.getItem('survey_systemName') || '-';
            const timestamp = window.surveyTimestamp || localStorage.getItem('survey_timestamp');
            const m1 = toNumber(data.M1 || 0);
            const m2 = toNumber(data.M2 || 0);
            const m3 = toNumber(data.M3 || 0);
            const m4 = toNumber(data.M4 || 0);
            const m5 = toNumber(data.M5 || 0);
            const total = m1 + m2 + m3 + m4 + m5;
            const avg = total / 5;
            const level = computeRiskLevel(avg);
            const currentLang = i18n.currentLang || 'zh-TW';
            
            // é¢¨éšªç­‰ç´šç¿»è­¯
            const levelMap = {
                'zh-TW': { 'ä½': 'ä½', 'ä¸­': 'ä¸­', 'é«˜': 'é«˜' },
                'en-US': { 'ä½': 'Low', 'ä¸­': 'Medium', 'é«˜': 'High' }
            };
            const riskLevelText = levelMap[currentLang]?.[level] || level;
            
            // ç²å– AI ç”Ÿæˆçš„é¢¨éšªæ”¹å–„å»ºè­°
            let adviceText = i18n.t('Report.DefaultAdvice');
            try {
                const adviceData = {
                    lang: currentLang,
                    m1: String(m1),
                    m2: String(m2),
                    m3: String(m3),
                    m4: String(m4),
                    m5: String(m5)
                };
                
                const adviceResponse = await fetch('/Home/GeneratePersonalizedAdvice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(adviceData)
                });
                
                if (adviceResponse.ok) {
                    const adviceResult = await adviceResponse.json();
                    if (adviceResult.advice) {
                        adviceText = adviceResult.advice;
                    }
                }
            } catch (error) {
                console.error('PDF é¢¨éšªæ”¹å–„å»ºè­°è¼‰å…¥å¤±æ•—:', error);
                // å¦‚æœå¤±æ•—ï¼Œä½¿ç”¨é è¨­å»ºè­°
                if (m3 <= 6) {
                    adviceText = i18n.t('Report.AdviceLow');
                } else {
                    adviceText = i18n.t('Report.AdviceNormal');
                }
            }

            // å‰µå»º PDF å°ˆç”¨å®¹å™¨ï¼ˆä½¿ç”¨ A4 å°ºå¯¸å„ªåŒ–ï¼‰
            const pdfContainer = document.createElement('div');
            pdfContainer.id = 'pdfContentContainer';
            pdfContainer.className = 'pdf-content-container';
            pdfContainer.style.cssText = `
                position: absolute;
                left: -9999px;
                top: 0;
                width: 180mm; /* ç¨å¾®å°æ–¼ A4 å¯¬åº¦ï¼Œç•™å‡ºé‚Šè· */
                background: #ffffff;
                padding: 12mm;
                box-sizing: border-box;
                font-family: Arial, "Microsoft YaHei", "SimHei", sans-serif;
                font-size: 12px;
                line-height: 1.5;
            `;

            // ç³»çµ±åç¨±
            pdfContainer.innerHTML = `
                <!-- ç³»çµ±åç¨±å’Œæ¨™é¡Œ -->
                <div class="pdf-header" style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #ddd;">
                    <h1 style="margin: 0 0 4px 0; font-size: 18px; color: #333; font-weight: 600;">${systemName || 'DocEngine'}</h1>
                    <h2 style="margin: 0; font-size: 14px; color: #666; font-weight: 500;">${i18n.t('Report.Title')}</h2>
                </div>

                <!-- å ±å‘Šä¿¡æ¯ï¼ˆç·Šæ¹Šï¼‰ -->
                <div style="margin-bottom: 12px; padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 9px; color: #555; line-height: 1.4;">
                    <div style="margin-bottom: 3px;">
                        <strong>${i18n.t('Report.AssessmentDate')}:</strong> ${formatTimestamp(timestamp)}
                    </div>
                    <div>
                        <strong>${i18n.t('Assessment.MaturityLabel')}</strong>${i18n.t('Assessment.MaturityDesc')}
                    </div>
                </div>

                <!-- é›·é”åœ–èˆ‡é¢¨éšªåˆ†æ•¸å€å¡Šï¼ˆä¸¦æ’ï¼‰ -->
                <div class="pdf-block" data-block="radar" style="margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 6px; page-break-inside: avoid;">
                    <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #333; font-weight: 600;">${i18n.t('Report.RadarTitle')}</h3>
                    <p style="margin: 0 0 12px 0; font-size: 10px; color: #666;">${i18n.t('Report.RadarDesc')}</p>
                    <div style="display: flex; gap: 16px; align-items: flex-start;">
                        <!-- é›·é”åœ–ï¼ˆå·¦å´ï¼‰ -->
                        <div style="flex: 1; text-align: center;">
                            <svg id="pdfRadarChart" viewBox="-20 -20 240 240" style="max-width: 200px; height: auto;">
                                <!-- Background circles -->
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#ddd" stroke-width="1"/>
                                <circle cx="100" cy="100" r="60" fill="none" stroke="#ddd" stroke-width="1"/>
                                <circle cx="100" cy="100" r="40" fill="none" stroke="#ddd" stroke-width="1"/>
                                <circle cx="100" cy="100" r="20" fill="none" stroke="#ddd" stroke-width="1"/>
                                <!-- Axes -->
                                <line x1="100" y1="100" x2="100" y2="20" stroke="#ccc" stroke-width="1"/>
                                <line x1="100" y1="100" x2="167" y2="70" stroke="#ccc" stroke-width="1"/>
                                <line x1="100" y1="100" x2="147" y2="160" stroke="#ccc" stroke-width="1"/>
                                <line x1="100" y1="100" x2="53" y2="160" stroke="#ccc" stroke-width="1"/>
                                <line x1="100" y1="100" x2="33" y2="70" stroke="#ccc" stroke-width="1"/>
                                <!-- Data polygon -->
                                <polygon id="pdfRadarPolygon" fill="rgba(98, 0, 234, 0.3)" stroke="#6200ea" stroke-width="2"/>
                                <!-- Labels -->
                                <text x="100" y="15" text-anchor="middle" font-size="12" fill="#333">${i18n.t('Report.RadarM1')}</text>
                                <text x="180" y="75" text-anchor="middle" font-size="12" fill="#333">${i18n.t('Report.RadarM2')}</text>
                                <text x="165" y="170" text-anchor="middle" font-size="12" fill="#333">${i18n.t('Report.RadarM3')}</text>
                                <text x="35" y="170" text-anchor="middle" font-size="12" fill="#333">${i18n.t('Report.RadarM4')}</text>
                                <text x="20" y="75" text-anchor="middle" font-size="12" fill="#333">${i18n.t('Report.RadarM5')}</text>
                            </svg>
                        </div>
                        <!-- é¢¨éšªåˆ†æ•¸ï¼ˆå³å´ï¼Œç›´å¼æ’åˆ—ï¼‰ -->
                        <div style="flex: 0 0 140px; padding: 12px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                            <h4 style="margin: 0 0 12px 0; font-size: 12px; font-weight: 600; color: #333; text-align: center; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0;">${i18n.t('Report.FingerprintTitle')}</h4>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                    <div style="font-size: 9px; color: #666; margin-bottom: 4px; text-align: left;">${i18n.t('Report.TotalScore')}</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #333; text-align: left;">${total.toFixed(1)}</div>
                                </div>
                                <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                    <div style="font-size: 9px; color: #666; margin-bottom: 4px; text-align: left;">${i18n.t('Report.RiskLevel')}</div>
                                    <div style="font-size: 14px; font-weight: 600; color: ${level === 'é«˜' ? '#d32f2f' : level === 'ä¸­' ? '#f57c00' : '#388e3c'}; text-align: left;">
                                        ${riskLevelText}
                                    </div>
                                    <div style="font-size: 9px; color: #666; margin-top: 4px; text-align: left; line-height: 1.3;">
                                        ${currentLang === 'zh-TW' 
                                            ? (level === 'é«˜' ? 'å»ºè­°æ–¼ 1â€“2 å€‹æœˆå…§å•Ÿå‹•æ”¹å–„' : level === 'ä¸­' ? 'å»ºè­°ç´å…¥å­£åº¦æª¢è¦–' : 'å»ºè­°åŠå¹´è¤‡æŸ¥')
                                            : (level === 'é«˜' ? 'Recommend initiating improvements within 1â€“2 months' : level === 'ä¸­' ? 'Recommend quarterly review' : 'Recommend semi-annual review')}
                                    </div>
                                </div>
                                <div style="padding: 8px 0;">
                                    <div style="font-size: 9px; color: #666; margin-bottom: 4px; text-align: left;">${i18n.t('Report.SampleTime')}</div>
                                    <div style="font-size: 9px; color: #333; line-height: 1.3; text-align: left;">${formatTimestamp(timestamp)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- åˆ†æ•¸èªªæ˜è¡¨ï¼ˆæ”¾åœ¨ä¸‹æ–¹ï¼‰ -->
                    <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                        <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #333;">${i18n.t('Score.TableTitle')}</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                            <thead>
                                <tr style="border-bottom: 1px solid #ddd; background: #f5f5f5;">
                                    <th style="padding: 6px 4px; text-align: left; font-weight: 600; color: #555;">${i18n.t('Score.Indicator')}</th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 600; color: #555; width: 50px;">${i18n.t('Score.Value')}</th>
                                    <th style="padding: 6px 4px; text-align: left; font-weight: 600; color: #555;">${i18n.t('Score.Description')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${generateScoreTableRows(m1, m2, m3, m4, m5)}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- é¢¨éšªæ”¹å–„å»ºè­°å€å¡Š -->
                <div class="pdf-block" data-block="advice" style="margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 6px; page-break-inside: avoid;">
                    <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #333; font-weight: 600;">${i18n.t('Report.ImprovementAdvice')}</h3>
                    <div style="margin: 0; font-size: 12px; line-height: 1.6; color: #444;">${formatAdviceText(adviceText)}</div>
                </div>

                <!-- è£œå……èªªæ˜å€å¡Šï¼ˆèª¿æ•´é †åºï¼Œæ”¾åœ¨é¢¨éšªæ´å¯Ÿä¹‹å‰ï¼‰ -->
                ${data.open1 || data.open2 || data.open3 ? `
                <div class="pdf-block" data-block="open-questions" style="margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 6px; page-break-inside: avoid;">
                    <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #333; font-weight: 600;">${i18n.t('Report.OpenQuestions')}</h3>
                    <p style="margin: 0 0 12px 0; font-size: 10px; color: #666;">${i18n.t('Report.OpenQuestionsDesc')}</p>
                    ${data.open1 ? `<div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 4px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 12px; font-weight: 600; color: #333;">${i18n.t('Assessment.OpenQ6')}</h4>
                        <p style="margin: 0; font-size: 11px; line-height: 1.4; color: #555; white-space: pre-wrap;">${data.open1}</p>
                    </div>` : ''}
                    ${data.open2 ? `<div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 4px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 12px; font-weight: 600; color: #333;">${i18n.t('Assessment.OpenQ7')}</h4>
                        <p style="margin: 0; font-size: 11px; line-height: 1.4; color: #555; white-space: pre-wrap;">${data.open2}</p>
                    </div>` : ''}
                    ${data.open3 ? `<div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 4px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 12px; font-weight: 600; color: #333;">${i18n.t('Assessment.OpenQ8')}</h4>
                        <p style="margin: 0; font-size: 11px; line-height: 1.4; color: #555; white-space: pre-wrap;">${data.open3}</p>
                    </div>` : ''}
                </div>
                ` : ''}

                <!-- é¢¨éšªæ´å¯Ÿå€å¡Šï¼ˆèª¿æ•´é †åºï¼Œæ”¾åœ¨è£œå……èªªæ˜ä¹‹å¾Œï¼‰ -->
                ${(data.open1 || data.open2 || data.open3) ? `
                <div class="pdf-block" data-block="ai-insights" style="margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 6px; page-break-inside: avoid;">
                    <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #333; font-weight: 600;">${i18n.t('Report.AIInsights')}</h3>
                    <p style="margin: 0 0 12px 0; font-size: 10px; color: #666;">${i18n.t('Report.AIInsightsDesc')}</p>
                    <div id="pdf-ai-insights" style="padding: 10px; background: white; border-radius: 4px; font-size: 11px; line-height: 1.5; color: #555;">
                        <!-- AI æ´å¯Ÿå…§å®¹å°‡åœ¨é€™è£¡å‹•æ…‹æ’å…¥ -->
                    </div>
                </div>
                ` : ''}

                <!-- å…è²¬è²æ˜å€å¡Š -->
                <div class="pdf-block" data-block="disclaimer" style="margin-top: 24px; margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 6px; border-left: 3px solid #6200ea; page-break-inside: avoid;">
                    <h3 style="margin: 0 0 8px 0; font-size: 13px; color: #333; font-weight: 600;">${currentLang === 'zh-TW' ? 'æœ¬å ±å‘Šé©ç”¨æ–¼' : 'This report is applicable for:'}</h3>
                    <div style="font-size: 10px; line-height: 1.8; color: #555;">
                        ${currentLang === 'zh-TW' 
                            ? `æœ¬å ±å‘Šé©ç”¨æ–¼ï¼š<br/>
â€§ è»Ÿé«”å°ˆæ¡ˆé¢¨éšªç›¤é»<br/>
â€§ ç³»çµ±äº¤æ¥èˆ‡æ²»ç†æª¢è¦–<br/>
ä¸å–ä»£ï¼š<br/>
â€§ ç¨½æ ¸<br/>
â€§ æ³•è¦èªè­‰<br/>
â€§ ç¨‹å¼ç¢¼å®‰å…¨æƒæ`
                            : `This report is applicable for:<br/>
â€§ Software project risk assessment<br/>
â€§ System handover and governance review<br/>
Does not replace:<br/>
â€§ Audit<br/>
â€§ Regulatory certification<br/>
â€§ Code security scanning`}
                    </div>
                </div>
            `;

            // æ›´æ–°é›·é”åœ–
            const pdfRadarPolygon = pdfContainer.querySelector('#pdfRadarPolygon');
            if (pdfRadarPolygon) {
                const centerX = 100;
                const centerY = 100;
                const maxRadius = 80;
                const values = [m1, m2, m3, m4, m5];
                const angles = [-90, -18, 54, 126, 198].map(deg => (deg * Math.PI) / 180);
                const points = values.map((v, i) => {
                    const ratio = Math.max(0, Math.min(10, v)) / 10;
                    const r = maxRadius * ratio;
                    const x = centerX + r * Math.cos(angles[i]);
                    const y = centerY + r * Math.sin(angles[i]);
                    return `${x},${y}`;
                });
                pdfRadarPolygon.setAttribute('points', points.join(' '));
            }

            // ç²å–ä¸¦å¡«å…… AI æ´å¯Ÿå…§å®¹ï¼ˆå¦‚æœæœ‰è£œå……èªªæ˜ï¼‰
            // å„ªå…ˆä½¿ç”¨é é¢ä¸Šå·²é¡¯ç¤ºçš„ AI æ´å¯Ÿå…§å®¹ï¼Œç¢ºä¿ PDF å’Œé é¢ä¸€è‡´
            const pdfAiInsights = pdfContainer.querySelector('#pdf-ai-insights');
            if (pdfAiInsights && (data.open1 || data.open2 || data.open3)) {
                try {
                    // å…ˆæª¢æŸ¥é é¢ä¸Šæ˜¯å¦å·²æœ‰ AI æ´å¯Ÿå…§å®¹
                    const pageInsightsEl = document.getElementById('insights-loading');
                    let aiContent = null;
                    
                    if (pageInsightsEl && pageInsightsEl.innerHTML && 
                        !pageInsightsEl.textContent.includes('åˆ†æä¸­') && 
                        !pageInsightsEl.textContent.includes('Analyzing') &&
                        !pageInsightsEl.textContent.includes('ç„¡æ³•ç”Ÿæˆ') &&
                        !pageInsightsEl.textContent.includes('Unable to') &&
                        !pageInsightsEl.textContent.includes('è¼‰å…¥å¤±æ•—') &&
                        !pageInsightsEl.textContent.includes('Failed to')) {
                        // ä½¿ç”¨é é¢ä¸Šçš„å…§å®¹ï¼ˆå»é™¤ HTML æ¨™ç±¤å¾Œé‡æ–°æ ¼å¼åŒ–ï¼‰
                        aiContent = pageInsightsEl.innerHTML;
                        console.log('ä½¿ç”¨é é¢ä¸Šå·²é¡¯ç¤ºçš„ AI æ´å¯Ÿå…§å®¹');
                    }
                    
                    if (aiContent) {
                        // ç›´æ¥ä½¿ç”¨é é¢çš„å…§å®¹
                        pdfAiInsights.innerHTML = aiContent;
                    } else {
                        // å¦‚æœé é¢æ²’æœ‰å…§å®¹ï¼Œå‰‡é‡æ–°èª¿ç”¨ API
                        const m6 = data.open1 || '';
                        const m7 = data.open2 || '';
                        const m8 = data.open3 || '';
                        
                        const m678Data = {
                            lang: currentLang,
                            m1: String(m1),
                            m2: String(m2),
                            m3: String(m3),
                            m4: String(m4),
                            m5: String(m5),
                            m6: m6,
                            m7: m7,
                            m8: m8
                        };
                        
                        const aiResponse = await fetch('/Home/GenerateInsights', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(m678Data)
                        });
                        
                        if (aiResponse.ok) {
                            const aiData = await aiResponse.json();
                            if (aiData.insights) {
                                pdfAiInsights.innerHTML = aiData.insights.replace(/\n/g, '<br>');
                            } else {
                                pdfAiInsights.textContent = currentLang === 'zh-TW' 
                                    ? 'ç„¡æ³•ç”Ÿæˆ AI æ´å¯Ÿ' 
                                    : 'Unable to generate AI insights';
                            }
                        } else {
                            pdfAiInsights.textContent = currentLang === 'zh-TW' 
                                ? 'AI æ´å¯Ÿè¼‰å…¥å¤±æ•—' 
                                : 'Failed to load AI insights';
                        }
                    }
                } catch (error) {
                    console.error('PDF AI æ´å¯Ÿè¼‰å…¥éŒ¯èª¤:', error);
                    if (pdfAiInsights) {
                        pdfAiInsights.textContent = currentLang === 'zh-TW' 
                            ? 'AI æ´å¯Ÿè¼‰å…¥å¤±æ•—' 
                            : 'Failed to load AI insights';
                    }
                }
            }

            // æ·»åŠ åˆ° bodyï¼ˆä½†éš±è—ï¼‰
            document.body.appendChild(pdfContainer);

            return pdfContainer;
        }

        async function downloadPdf() {
            try {
                // ç²å–ç³»çµ±åç¨±ç”¨æ–¼æ–‡ä»¶åå’Œé é¦–
                const systemName = localStorage.getItem('survey_systemName') || 'DocEngine';
                const safeFileName = systemName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                const fileName = `${safeFileName}-Risk-Report.pdf`;

                // é¡¯ç¤ºè¼‰å…¥æç¤ºï¼ˆæ ¹æ“šèªè¨€é¡¯ç¤ºï¼‰
                const btn = document.getElementById('downloadPdfBtn');
                const originalText = btn.textContent;
                btn.disabled = true;
                const currentLang = i18n.currentLang || 'zh-TW';
                btn.textContent = currentLang === 'zh-TW' ? 'ç”Ÿæˆä¸­...' : 'Generating...';

                // å‰µå»º PDF å°ˆç”¨å…§å®¹
                const pdfContainer = await createPdfContent();
                if (!pdfContainer) {
                    throw new Error(currentLang === 'zh-TW' ? 'ç„¡æ³•è®€å–å•å·è³‡æ–™' : 'Unable to read survey data');
                }

                // ç­‰å¾…å¸ƒå±€ç©©å®š
                await new Promise(resolve => setTimeout(resolve, 300));

                // æª¢æ¸¬æ‰€æœ‰å€å¡Šé‚Šç•Œï¼ˆä½¿ç”¨ data-block æ¨™è¨˜ï¼‰
                const containerRect = pdfContainer.getBoundingClientRect();
                const allBlocks = Array.from(pdfContainer.querySelectorAll('[data-block]')).filter(el => {
                    // åªåŒ…å«å¯è¦‹çš„å…ƒç´ 
                    const rect = el.getBoundingClientRect();
                    return rect.height > 0 && rect.width > 0;
                });
                
                // è¨ˆç®—æ¯å€‹å€å¡Šåœ¨å®¹å™¨ä¸­çš„ä½ç½®ï¼ˆç›¸å°æ–¼ pdfContainerï¼‰
                const blockBoundaries = allBlocks.map(el => {
                    const rect = el.getBoundingClientRect();
                    const relativeTop = rect.top - containerRect.top;
                    const relativeBottom = rect.bottom - containerRect.top;
                    const blockId = el.getAttribute('data-block');
                    
                    // è¨­ç½®å„ªå…ˆç´šï¼šfingerprint å’Œ advice æœ€é«˜ï¼Œå…¶ä»–æ¬¡ä¹‹
                    let priority = 2;
                    if (blockId === 'fingerprint' || blockId === 'advice') {
                        priority = 1;
                    }
                    
                    return {
                        top: relativeTop,
                        bottom: relativeBottom,
                        height: rect.height,
                        element: el,
                        blockId: blockId,
                        priority: priority
                    };
                }).sort((a, b) => a.top - b.top); // æŒ‰ä½ç½®æ’åº
                
                console.log('æª¢æ¸¬åˆ°çš„å€å¡Šé‚Šç•Œ:', blockBoundaries.map(b => ({
                    block: b.blockId,
                    top: b.top,
                    bottom: b.bottom,
                    height: b.height
                })));

                // ä½¿ç”¨ html2canvas ç”Ÿæˆåœ–ç‰‡ï¼ˆPDF å°ˆç”¨å®¹å™¨ï¼‰
                let canvas;
                try {
                    canvas = await html2canvas(pdfContainer, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        allowTaint: false,
                        width: pdfContainer.scrollWidth,
                        height: pdfContainer.scrollHeight
                    });
                } catch (canvasError) {
                    console.error('Canvas generation error:', canvasError);
                    // æ¸…ç† PDF å®¹å™¨
                    if (pdfContainer && pdfContainer.parentNode) {
                        pdfContainer.parentNode.removeChild(pdfContainer);
                    }
                    throw new Error('ç„¡æ³•ç”Ÿæˆå ±å‘Šåœ–ç‰‡ï¼Œè«‹ç¨å¾Œå†è©¦');
                }

                // é©—è­‰ canvas æ˜¯å¦æœ‰æ•ˆ
                if (!canvas || canvas.width === 0 || canvas.height === 0) {
                    // æ¸…ç† PDF å®¹å™¨
                    if (pdfContainer && pdfContainer.parentNode) {
                        pdfContainer.parentNode.removeChild(pdfContainer);
                    }
                    throw new Error('ç”Ÿæˆçš„åœ–ç‰‡ç„¡æ•ˆï¼Œè«‹ç¨å¾Œå†è©¦');
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 10;
                const headerFooterHeight = 30; // é é¦–é å°¾ç¸½é«˜åº¦

                const imgWidth = pageWidth - (margin * 2);
                const availableHeight = pageHeight - (margin * 2) - headerFooterHeight;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                // æ·»åŠ å…§å®¹ï¼Œæ¯é éƒ½æœ‰é é¦–é å°¾
                let yOffset = 0;
                let actualPageNumber = 0;
                
                // å…ˆè¨ˆç®—å¯¦éš›éœ€è¦çš„é æ•¸ï¼ˆè€ƒæ…®åˆ†é èª¿æ•´ï¼‰
                let estimatedPageCount = Math.ceil(imgHeight / availableHeight);
                
                while (yOffset < imgHeight) {
                    // åœ¨å‰µå»ºé é¢å‰å…ˆæª¢æŸ¥æ˜¯å¦çœŸçš„é‚„æœ‰å…§å®¹
                    if (yOffset >= imgHeight) {
                        break;
                    }
                    
                    actualPageNumber++;
                    
                    if (actualPageNumber > 1) {
                        pdf.addPage();
                    }

                    // æ³¨æ„ï¼šå…ˆä¸æ·»åŠ é é¦–é å°¾ï¼Œç­‰å…§å®¹ç¢ºå®šå¾Œå†æ·»åŠ ï¼Œé¿å…ç©ºé 

                    // è¨ˆç®—ç•¶å‰é è¦é¡¯ç¤ºçš„åœ–ç‰‡éƒ¨åˆ†
                    const scaleFactor = imgHeight / pdfContainer.scrollHeight;
                    
                    // è¨ˆç®—é»˜èªé é«˜
                    let pageImgHeight = Math.min(imgHeight - yOffset, availableHeight);
                    
                    // å¦‚æœå‰©é¤˜å…§å®¹ä¸è¶³ï¼Œä¸è¦å‰µå»ºæ–°é 
                    if (pageImgHeight < 5) {
                        // åˆªé™¤å‰›å‰µå»ºçš„é é¢
                        if (actualPageNumber > 1) {
                            try {
                                pdf.deletePage(actualPageNumber);
                            } catch (e) {
                                console.warn('ç„¡æ³•åˆªé™¤ç©ºé :', e);
                            }
                        }
                        actualPageNumber--;
                        break;
                    }
                    
                    const sourceY = (yOffset / imgHeight) * canvas.height;
                    const currentPageEnd = yOffset + pageImgHeight;
                    
                    // æ‰¾åˆ°ç•¶å‰ yOffset å°æ‡‰çš„å€å¡Šï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                    let currentBlock = null;
                    for (const block of blockBoundaries) {
                        const blockTop = block.top * scaleFactor;
                        const blockBottom = block.bottom * scaleFactor;
                        if (yOffset >= blockTop && yOffset < blockBottom) {
                            currentBlock = block;
                            break;
                        }
                    }
                    
                    // å¦‚æœç•¶å‰åœ¨ä¸€å€‹å€å¡Šå…§ï¼Œå¿…é ˆå®Œæ•´é¡¯ç¤ºé€™å€‹å€å¡Š
                    if (currentBlock) {
                        const blockTop = currentBlock.top * scaleFactor;
                        const blockBottom = currentBlock.bottom * scaleFactor;
                        const remainingInBlock = blockBottom - yOffset;
                        
                        if (remainingInBlock <= availableHeight) {
                            // å¯ä»¥å®Œæ•´æ”¾åœ¨ä¸€é ï¼Œé¡¯ç¤ºå®Œæ•´
                            pageImgHeight = remainingInBlock;
                            console.log(`é é¢ ${actualPageNumber}: å€å¡Š ${currentBlock.blockId} åœ¨ç•¶å‰é é–‹å§‹ï¼Œå®Œæ•´é¡¯ç¤ºåˆ°çµæŸ (${remainingInBlock.toFixed(1)}mm)`);
                        } else {
                            // å€å¡Šå¤ªå¤§ç„¡æ³•æ”¾åœ¨ä¸€é 
                            // å„ªå…ˆé¸æ“‡ï¼šå¦‚æœç•¶å‰é æ˜¯é€™å€‹å€å¡Šçš„ç¬¬ä¸€é ï¼Œå˜—è©¦é¡¯ç¤ºä¸€é 
                            // å¦å‰‡ï¼šå¼·åˆ¶é™åˆ¶åœ¨ availableHeight å…§
                            const isFirstPageOfBlock = Math.abs(yOffset - blockTop) < 5; // 5mm å®¹å·®
                            
                            if (isFirstPageOfBlock) {
                                // é€™æ˜¯å€å¡Šçš„ç¬¬ä¸€é ï¼Œé¡¯ç¤ºä¸€é å…§å®¹
                                pageImgHeight = availableHeight;
                                console.log(`é é¢ ${actualPageNumber}: å€å¡Š ${currentBlock.blockId} å¤ªå¤§ï¼Œç¬¬ä¸€é é¡¯ç¤º ${availableHeight.toFixed(1)}mm (å‰©é¤˜ ${remainingInBlock.toFixed(1)}mm)ï¼Œä¸‹ä¸€é ç¹¼çºŒ`);
                            } else {
                                // ä¸æ˜¯ç¬¬ä¸€é ï¼Œé¡¯ç¤ºå‰©é¤˜å…§å®¹ï¼ˆä½†é™åˆ¶åœ¨å¯ç”¨é«˜åº¦å…§ï¼‰
                                pageImgHeight = Math.min(remainingInBlock, availableHeight);
                                console.log(`é é¢ ${actualPageNumber}: å€å¡Š ${currentBlock.blockId} ç¹¼çºŒé¡¯ç¤ºï¼Œå‰©é¤˜ ${remainingInBlock.toFixed(1)}mmï¼Œç•¶å‰é é¡¯ç¤º ${pageImgHeight.toFixed(1)}mm`);
                            }
                        }
                    } else {
                        // ç•¶å‰ä¸åœ¨ä»»ä½•å€å¡Šå…§ï¼Œæª¢æŸ¥æ˜¯å¦æœƒåˆ‡åˆ°ä¸‹ä¸€å€‹å€å¡Š
                        // æŒ‰å„ªå…ˆç´šæ’åºæª¢æŸ¥ï¼ˆé«˜å„ªå…ˆç´šå…ˆæª¢æŸ¥ï¼‰
                        const sortedBlocks = [...blockBoundaries].sort((a, b) => a.priority - b.priority);
                        
                        for (const block of sortedBlocks) {
                            const blockTop = block.top * scaleFactor;
                            const blockBottom = block.bottom * scaleFactor;
                            
                            // å¦‚æœç•¶å‰é çµæŸä½ç½®æœƒåˆ‡åˆ°å€å¡Šä¸­é–“ï¼Œæå‰çµæŸç•¶å‰é 
                            if (yOffset < blockTop && currentPageEnd > blockTop && currentPageEnd < blockBottom) {
                                // å¼·åˆ¶çµæŸç•¶å‰é ï¼Œè®“å€å¡Šå¾æ–°é é–‹å§‹
                                const distanceToBlock = blockTop - yOffset;
                                
                                // ç¢ºä¿è‡³å°‘æœ‰ä¸€é»å…§å®¹ï¼ˆè‡³å°‘ 10mmï¼‰ï¼Œå¦å‰‡ç›´æ¥è·³éåˆ°å€å¡Šé–‹å§‹
                                if (distanceToBlock >= 10) {
                                    pageImgHeight = blockTop - yOffset;
                                    console.log(`é é¢ ${actualPageNumber}: æœƒåˆ‡åˆ°å€å¡Š ${block.blockId} ä¸­é–“ï¼Œæå‰çµæŸåˆ°å€å¡Šé–‹å§‹è™• (${distanceToBlock.toFixed(1)}mm)`);
                                    break; // æ‰¾åˆ°æœƒåˆ‡åˆ°çš„å€å¡Šï¼Œåœæ­¢æª¢æŸ¥
                                } else {
                                    // è·é›¢å¤ªçŸ­ï¼Œç›´æ¥è·³åˆ°å€å¡Šé–‹å§‹è™•
                                    pageImgHeight = Math.max(distanceToBlock, 5); // è‡³å°‘ 5mm
                                    console.log(`é é¢ ${actualPageNumber}: è·é›¢å€å¡Š ${block.blockId} å¤ªçŸ­ï¼Œé¡¯ç¤ºåˆ°å€å¡Šé–‹å§‹è™• (${pageImgHeight.toFixed(1)}mm)`);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // ç¢ºä¿ pageImgHeight åœ¨åˆç†ç¯„åœå…§ï¼ˆé€™å¾ˆé‡è¦ï¼ï¼‰
                    const maxAllowedHeight = Math.min(availableHeight, imgHeight - yOffset);
                    pageImgHeight = Math.min(pageImgHeight, maxAllowedHeight);
                    pageImgHeight = Math.max(pageImgHeight, 0);
                    
                    // å¦‚æœé é«˜ç‚º 0 æˆ–å¤ªå°ï¼Œä½¿ç”¨æœ€å°é«˜åº¦
                    if (pageImgHeight <= 0) {
                        pageImgHeight = Math.min(availableHeight * 0.1, imgHeight - yOffset, 20); // è‡³å°‘é¡¯ç¤º10%æˆ–20mmæˆ–å‰©é¤˜å…§å®¹
                    }
                    
                    // æœ€çµ‚é©—è­‰ï¼šå¦‚æœä»ç„¶å¤ªå°æˆ–æ²’æœ‰å…§å®¹ï¼Œè·³éé€™ä¸€é 
                    if (pageImgHeight < 5 || yOffset >= imgHeight) {
                        console.log(`é é¢ ${actualPageNumber}: å…§å®¹ä¸è¶³ï¼Œè·³éé€™ä¸€é  (pageImgHeight=${pageImgHeight.toFixed(1)}mm, yOffset=${yOffset.toFixed(1)}mm)`);
                        // åˆªé™¤å‰›æ·»åŠ çš„ç©ºé 
                        if (actualPageNumber > 1) {
                            try {
                                pdf.deletePage(actualPageNumber);
                            } catch (e) {
                                console.warn('ç„¡æ³•åˆªé™¤ç©ºé :', e);
                            }
                        }
                        // æ¸›å°‘é æ•¸è¨ˆæ•¸ï¼Œå› ç‚ºé é¢å·²è¢«åˆªé™¤
                        actualPageNumber--;
                        break;
                    }
                    
                    let sourceHeight = (pageImgHeight / imgHeight) * canvas.height;
                    let finalSourceY = sourceY;

                    // ç¢ºä¿ sourceHeight æœ‰æ•ˆ
                    if (sourceHeight <= 0 || sourceHeight > canvas.height || sourceY < 0 || sourceY >= canvas.height) {
                        console.warn(`Invalid source dimensions: sourceY=${sourceY}, sourceHeight=${sourceHeight}, canvas.height=${canvas.height}`);
                        // èª¿æ•´ç‚ºæœ‰æ•ˆå€¼
                        finalSourceY = Math.max(0, Math.min(sourceY, canvas.height - 1));
                        sourceHeight = Math.min(sourceHeight, canvas.height - finalSourceY);
                        if (sourceHeight <= 0) {
                            // åˆªé™¤å‰›å‰µå»ºçš„é é¢
                            if (actualPageNumber > 1) {
                                try {
                                    pdf.deletePage(actualPageNumber);
                                    actualPageNumber--;
                                } catch (e) {
                                    console.warn('ç„¡æ³•åˆªé™¤ç„¡æ•ˆé :', e);
                                }
                            }
                            break;
                        }
                        // é‡æ–°è¨ˆç®— pageImgHeight
                        pageImgHeight = (sourceHeight / canvas.height) * imgHeight;
                    }

                    // å‰µå»ºç•¶å‰é çš„åœ–ç‰‡
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = Math.max(Math.floor(sourceHeight), 1); // ç¢ºä¿è‡³å°‘ç‚º1
                    
                    const tempCtx = tempCanvas.getContext('2d');
                    if (!tempCtx) {
                        console.error('ç„¡æ³•ç²å– canvas context');
                        // åˆªé™¤å‰›å‰µå»ºçš„é é¢
                        if (actualPageNumber > 1) {
                            try {
                                pdf.deletePage(actualPageNumber);
                                actualPageNumber--;
                            } catch (e) {
                                console.warn('ç„¡æ³•åˆªé™¤ç„¡contexté :', e);
                            }
                        }
                        break;
                    }
                    
                    try {
                        // ç¹ªè£½åœ–ç‰‡ç‰‡æ®µ
                        tempCtx.drawImage(
                            canvas, 
                            0, finalSourceY, canvas.width, sourceHeight,  // æºåœ–ç‰‡å€åŸŸ
                            0, 0, canvas.width, sourceHeight              // ç›®æ¨™canvaså€åŸŸ
                        );
                        
                        // è½‰æ›ç‚ºåœ–ç‰‡æ•¸æ“šï¼Œæ·»åŠ éŒ¯èª¤è™•ç†
                        let pageImgData;
                        try {
                            pageImgData = tempCanvas.toDataURL('image/png', 1.0);
                            if (!pageImgData || pageImgData === 'data:,') {
                                console.error('åœ–ç‰‡æ•¸æ“šè½‰æ›å¤±æ•—');
                                // åˆªé™¤å‰›å‰µå»ºçš„é é¢
                                if (actualPageNumber > 1) {
                                    try {
                                        pdf.deletePage(actualPageNumber);
                                        actualPageNumber--;
                                    } catch (e) {
                                        console.warn('ç„¡æ³•åˆªé™¤å¤±æ•—é :', e);
                                    }
                                }
                                break;
                            }
                        } catch (imgError) {
                            console.error('åœ–ç‰‡æ•¸æ“šè½‰æ›éŒ¯èª¤:', imgError);
                            // åˆªé™¤å‰›å‰µå»ºçš„é é¢
                            if (actualPageNumber > 1) {
                                try {
                                    pdf.deletePage(actualPageNumber);
                                    actualPageNumber--;
                                } catch (e) {
                                    console.warn('ç„¡æ³•åˆªé™¤éŒ¯èª¤é :', e);
                                }
                            }
                            break;
                        }
                        
                        const actualPageImgHeight = (tempCanvas.height * imgWidth) / tempCanvas.width;

                        // æ·»åŠ å…§å®¹åœ–ç‰‡ï¼ˆåœ¨é é¦–ä¸‹æ–¹ï¼‰
                        const contentY = margin + 15; // é é¦–ä¸‹æ–¹
                        try {
                            pdf.addImage(pageImgData, 'PNG', margin, contentY, imgWidth, actualPageImgHeight, undefined, 'FAST');
                            // å…ˆä¸æ·»åŠ é é¦–é å°¾ï¼Œç­‰æ‰€æœ‰é é¢å®Œæˆå¾Œçµ±ä¸€æ·»åŠ ï¼Œé¿å…å‰µå»ºå¤šé¤˜é é¢
                        } catch (pdfImgError) {
                            console.error('æ·»åŠ åœ–ç‰‡åˆ°PDFå¤±æ•—:', pdfImgError);
                            try {
                                // å˜—è©¦ä½¿ç”¨ SLOW æ¨¡å¼
                                pdf.addImage(pageImgData, 'PNG', margin, contentY, imgWidth, actualPageImgHeight, undefined, 'SLOW');
                                // å…ˆä¸æ·»åŠ é é¦–é å°¾ï¼Œç­‰æ‰€æœ‰é é¢å®Œæˆå¾Œçµ±ä¸€æ·»åŠ 
                            } catch (slowError) {
                                console.error('ä½¿ç”¨ SLOW æ¨¡å¼ä¹Ÿå¤±æ•—:', slowError);
                                throw new Error('ç„¡æ³•å°‡åœ–ç‰‡æ·»åŠ åˆ°PDF: ' + slowError.message);
                            }
                        }
                    } catch (drawError) {
                        console.error('ç¹ªè£½åœ–ç‰‡ç‰‡æ®µå¤±æ•—:', drawError);
                        throw new Error('ç”ŸæˆPDFåœ–ç‰‡å¤±æ•—: ' + drawError.message);
                    }

                    yOffset += pageImgHeight;
                    
                    // æª¢æŸ¥æ˜¯å¦é‚„æœ‰å…§å®¹
                    if (yOffset >= imgHeight) {
                        break;
                    }
                }
                
                // ç²å–å¯¦éš›é æ•¸ï¼ˆå¯èƒ½å› ç‚ºåˆªé™¤ç©ºé è€Œæ¸›å°‘ï¼‰
                let totalPages = pdf.internal.getNumberOfPages();
                
                // æª¢æŸ¥ä¸¦æ¸…ç†å¤šé¤˜çš„ç©ºé 
                // å¦‚æœ actualPageNumber å’Œ totalPages ä¸ä¸€è‡´ï¼Œåˆªé™¤å¤šé¤˜çš„é é¢
                console.log(`åˆ†é å®Œæˆ: actualPageNumber=${actualPageNumber}, totalPages=${totalPages}, yOffset=${yOffset.toFixed(1)}, imgHeight=${imgHeight.toFixed(1)}`);
                
                if (totalPages > actualPageNumber) {
                    console.log(`ç™¼ç¾å¤šé¤˜é é¢: å¯¦éš›é æ•¸ ${totalPages} > è¨ˆæ•¸é æ•¸ ${actualPageNumber}ï¼Œå°‡åˆªé™¤å¤šé¤˜é é¢`);
                    for (let pageNum = totalPages; pageNum > actualPageNumber; pageNum--) {
                        try {
                            pdf.deletePage(pageNum);
                            console.log(`å·²åˆªé™¤é é¢ ${pageNum}`);
                        } catch (e) {
                            console.warn(`ç„¡æ³•åˆªé™¤å¤šé¤˜é é¢ ${pageNum}:`, e);
                        }
                    }
                    // é‡æ–°ç²å–å¯¦éš›é æ•¸
                    totalPages = pdf.internal.getNumberOfPages();
                }
                
                // ä½¿ç”¨å¯¦éš›é æ•¸ä½œç‚ºæœ€çµ‚é æ•¸
                let finalTotalPages = totalPages;
                
                // ç¢ºä¿ä¸æœƒæœ‰é¡å¤–çš„é é¢è¢«å‰µå»º
                // æ›´æ–°æ‰€æœ‰é é¢çš„é é¦–é å°¾ï¼ˆä½¿ç”¨æœ€çµ‚å¯¦éš›é æ•¸ï¼‰
                if (finalTotalPages > 0) {
                    for (let pageNum = 1; pageNum <= finalTotalPages; pageNum++) {
                        // ç¢ºä¿é é¢å­˜åœ¨æ‰è¨­ç½®
                        const currentTotalPages = pdf.internal.getNumberOfPages();
                        if (pageNum > currentTotalPages) {
                            console.warn(`é é¢ ${pageNum} ä¸å­˜åœ¨ï¼Œåœæ­¢æ›´æ–°`);
                            finalTotalPages = currentTotalPages; // æ›´æ–°æœ€çµ‚é æ•¸
                            break;
                        }
                        
                        pdf.setPage(pageNum);
                        
                        // æ¸…é™¤èˆŠçš„é é¦–é å°¾ï¼Œé‡æ–°æ·»åŠ ï¼ˆä½¿ç”¨æœ€çµ‚é æ•¸ï¼‰
                        addHeaderFooter(pdf, pageNum, finalTotalPages, systemName);
                        
                        // æ¯æ¬¡æ›´æ–°å¾Œæª¢æŸ¥æ˜¯å¦å‰µå»ºäº†æ–°é 
                        const newTotalPages = pdf.internal.getNumberOfPages();
                        if (newTotalPages > finalTotalPages) {
                            console.warn(`æ›´æ–°é é¢ ${pageNum} å¾Œé æ•¸å¢åŠ  (${newTotalPages} > ${finalTotalPages})ï¼Œç«‹å³åˆªé™¤`);
                            for (let extraPage = newTotalPages; extraPage > finalTotalPages; extraPage--) {
                                try {
                                    pdf.deletePage(extraPage);
                                    console.log(`å·²åˆªé™¤å¤šé¤˜é é¢ ${extraPage}`);
                                } catch (e) {
                                    console.warn(`ç„¡æ³•åˆªé™¤å¤šé¤˜é é¢ ${extraPage}:`, e);
                                }
                            }
                            // é‡æ–°ç²å–å¯¦éš›é æ•¸
                            finalTotalPages = pdf.internal.getNumberOfPages();
                        }
                    }
                    
                    // æœ€å¾Œå†æ¬¡æª¢æŸ¥ä¸¦æ¸…ç†æ‰€æœ‰å¤šé¤˜é é¢ï¼ˆä»¥é˜²è¬ä¸€ï¼‰
                    finalTotalPages = pdf.internal.getNumberOfPages();
                    if (finalTotalPages > actualPageNumber) {
                        console.log(`æœ€çµ‚æª¢æŸ¥ï¼šç™¼ç¾å¤šé¤˜é é¢ (${finalTotalPages} > ${actualPageNumber})ï¼Œåˆªé™¤`);
                        for (let pageNum = finalTotalPages; pageNum > actualPageNumber; pageNum--) {
                            try {
                                pdf.deletePage(pageNum);
                                console.log(`æœ€çµ‚åˆªé™¤é é¢ ${pageNum}`);
                            } catch (e) {
                                console.warn(`ç„¡æ³•åˆªé™¤é é¢ ${pageNum}:`, e);
                            }
                        }
                        finalTotalPages = pdf.internal.getNumberOfPages();
                    }
                    
                    // æœ€çµ‚é©—è­‰ï¼šç¢ºä¿é æ•¸æ­£ç¢ºï¼ˆä¸­æ–‡ç‰ˆç‰¹åˆ¥æª¢æŸ¥ï¼‰
                    const finalCheckPages = pdf.internal.getNumberOfPages();
                    if (finalCheckPages !== finalTotalPages) {
                        console.warn(`æœ€çµ‚é©—è­‰ï¼šé æ•¸ä¸ä¸€è‡´ (${finalCheckPages} !== ${finalTotalPages})ï¼Œä½¿ç”¨å¯¦éš›é æ•¸`);
                        finalTotalPages = finalCheckPages;
                    }
                }

                pdf.save(fileName);
                
                // æ¸…ç† PDF å®¹å™¨
                if (pdfContainer && pdfContainer.parentNode) {
                    pdfContainer.parentNode.removeChild(pdfContainer);
                }
                
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                btn.disabled = false;
                btn.textContent = originalText;
            } catch (error) {
                console.error('PDF ç”ŸæˆéŒ¯èª¤:', error);
                
                // ç¢ºä¿æ¸…ç† PDF å®¹å™¨
                const pdfContainer = document.getElementById('pdfContentContainer');
                if (pdfContainer && pdfContainer.parentNode) {
                    pdfContainer.parentNode.removeChild(pdfContainer);
                }
                
                const currentLang = i18n.currentLang || 'zh-TW';
                const errorMsg = currentLang === 'zh-TW' 
                    ? 'PDF ç”Ÿæˆå¤±æ•—ï¼š' + error.message
                    : 'PDF generation failed: ' + error.message;
                alert(errorMsg);
                
                // æ¢å¾©æŒ‰éˆ•ç‹€æ…‹
                const btn = document.getElementById('downloadPdfBtn');
                if (btn) {
                    btn.disabled = false;
                    const btnText = btn.getAttribute('data-i18n') 
                        ? i18n.t(btn.getAttribute('data-i18n')) 
                        : (currentLang === 'zh-TW' ? 'ä¸‹è¼‰ PDF å ±å‘Š' : 'Download PDF Report');
                    btn.textContent = btnText;
                }
            }
        }

        document.getElementById('downloadPdfBtn').addEventListener('click', downloadPdf);

        // æª¢æŸ¥æ˜¯å¦ç‚ºé é¢åˆ·æ–°ï¼ˆF5ï¼‰
        const isPageRefresh = performance.navigation.type === 1 || performance.getEntriesByType('navigation')[0]?.type === 'reload';
        
        // é é¢è¼‰å…¥æ™‚æ›´æ–°å ±å‘Šï¼ˆå»¶é²ç¢ºä¿æ‰€æœ‰å…ƒç´ éƒ½å·²æ¸²æŸ“å’Œ i18n å·²åˆå§‹åŒ–ï¼‰
        setTimeout(async function() {
            try {
                // 1. å…ˆæ›´æ–°å•å·é›·é”åœ–ç­‰DOM
                await updateReport(isPageRefresh);
                // 2. å†åŸ·è¡ŒAIåˆ†æï¼ˆä¾è³´DOMè³‡æ–™ï¼Œå¦‚æœæ˜¯åˆ·æ–°å‰‡å¼·åˆ¶é‡æ–°ç”Ÿæˆï¼‰
                await getAIInsights(isPageRefresh);
            } catch (error) {
                console.error('é é¢åˆå§‹åŒ–éŒ¯èª¤:', error);
                // ç¢ºä¿è‡³å°‘é¡¯ç¤ºå¼•å°é é¢
                const reportContent = document.getElementById('reportContent');
                const noReportGuide = document.getElementById('noReportGuide');
                if (reportContent) {
                    reportContent.style.display = 'none';
                }
                if (noReportGuide) {
                    noReportGuide.style.display = 'flex';
                }
            }
        }, 300);
    </script>
}
