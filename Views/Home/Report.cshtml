@{
    ViewData["Title"] = "風險評估報告";
    var isDevelopment = ViewData["IsDevelopment"] as bool? ?? false;
    var environment = ViewData["Environment"] as string ?? "Production";
}

<div class="app-container">
    <!-- Sidebar Navigation -->
    <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <div class="sidebar-logo">
                    <img src="~/images/logo.svg" alt="智序資訊" class="logo-image" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';" />
                    <svg class="logo-svg" style="display:none;" viewBox="0 0 200 200" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="20" y="20" width="40" height="120" stroke="currentColor" stroke-width="2" fill="none"/>
                        <rect x="60" y="60" width="60" height="40" stroke="currentColor" stroke-width="2" fill="none"/>
                        <rect x="60" y="100" width="40" height="40" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M140 20 L140 80 L180 80 L180 60 L160 60 L160 20 Z" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M140 100 L140 140 L180 140 L180 120 L160 120 L160 100 Z" stroke="currentColor" stroke-width="2" fill="none"/>
                        <path d="M120 140 L120 160 L180 160 L180 140 Z" stroke="currentColor" stroke-width="2" fill="none"/>
                        <rect x="140" y="20" width="40" height="20" stroke="currentColor" stroke-width="2" fill="none"/>
                    </svg>
                </div>
                <div class="sidebar-brand-text">
                    <h2 class="sidebar-title">DocEngine</h2>
                    <p class="sidebar-subtitle">智序資訊</p>
                </div>
            </div>
            <button class="sidebar-close" id="sidebarClose" aria-label="Close sidebar">
                <span></span>
                <span></span>
            </button>
        </div>
        <nav class="sidebar-nav">
            <a href="@Url.Action("Index", "Home")" class="nav-item" data-page="dashboard">
                <span class="nav-icon">📊</span>
                <span class="nav-text" data-i18n="Nav.Dashboard">儀表板</span>
            </a>
            <a href="@Url.Action("Projects", "Home")" class="nav-item" data-page="projects">
                <span class="nav-icon">📁</span>
                <span class="nav-text" data-i18n="Nav.Projects">專案</span>
            </a>
            <a href="@Url.Action("Assessment", "Home")" class="nav-item" data-page="assessment">
                <span class="nav-icon">📝</span>
                <span class="nav-text" data-i18n="Nav.Assessment">評估</span>
            </a>
            <a href="@Url.Action("Report", "Home")" class="nav-item active" data-page="report">
                <span class="nav-icon">📋</span>
                <span class="nav-text" data-i18n="Nav.Report">報告</span>
            </a>
            <a href="@Url.Action("Documentation", "Home")" class="nav-item" data-page="documentation">
                <span class="nav-icon">📄</span>
                <span class="nav-text" data-i18n="Nav.Documentation">文件</span>
            </a>
            <a href="@Url.Action("Risks", "Home")" class="nav-item" data-page="risks">
                <span class="nav-icon">⚠️</span>
                <span class="nav-text" data-i18n="Nav.Risks">風險</span>
            </a>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Mobile Header with Hamburger and Language Switcher -->
        <header class="mobile-header">
            <button class="hamburger" id="hamburger" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
            <h1 class="mobile-title">DocEngine</h1>
            <div class="mobile-header-actions">
                <div class="language-switcher-top">
                    <button class="lang-btn-top" onclick="i18n.setLang('zh-TW')" data-lang="zh-TW">
                        <span data-i18n="Common.Chinese">繁體中文</span>
                    </button>
                    <button class="lang-btn-top" onclick="i18n.setLang('en-US')" data-lang="en-US">
                        <span data-i18n="Common.English">English</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Page Content -->
        <div class="content-wrapper">
            <div class="report-header">
                <div class="report-header-top">
                    <div class="report-header-left">
                        <h1 class="report-title" data-i18n="Report.Title">風險評估報告</h1>
                        <p class="report-subtitle" data-i18n="Report.Subtitle">根據您的問卷結果自動生成的風險指紋分析</p>
                    </div>
                    <div class="report-header-right">
                        <div class="header-actions">
                            <div class="language-switcher-top">
                                <button class="lang-btn-top" onclick="i18n.setLang('zh-TW')" data-lang="zh-TW">
                                    <span data-i18n="Common.Chinese">繁體中文</span>
                                </button>
                                <button class="lang-btn-top" onclick="i18n.setLang('en-US')" data-lang="en-US">
                                    <span data-i18n="Common.English">English</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 專案資訊條：改為橫向卡片置於標題下方，避免擠在右側 -->
                <div class="report-meta-bar">
                    <div class="report-meta-item">
                        <span class="report-meta-label" data-i18n="Report.ProjectName">專案名稱</span>
                        <span class="report-meta-value" id="projectNameDisplay">-</span>
                    </div>
                    <div class="report-meta-item">
                        <span class="report-meta-label" data-i18n="Report.SystemName">系統名稱</span>
                        <span class="report-meta-value" id="systemNameDisplay">-</span>
                    </div>
                    <div class="report-meta-item">
                        <span class="report-meta-label" data-i18n="Report.SystemCode">系統代號</span>
                        <span class="report-meta-value" id="systemCodeDisplay">-</span>
                    </div>
                    <div class="report-meta-item">
                        <span class="report-meta-label" data-i18n="Report.EvaluatorRole">評估人角色</span>
                        <span class="report-meta-value" id="evaluatorRoleDisplay">-</span>
                    </div>
                    <div class="report-meta-item">
                        <span class="report-meta-label" data-i18n="Report.ReportId">報告編號</span>
                        <span class="report-meta-value" id="reportIdDisplay">-</span>
                    </div>
                    <div class="report-meta-item">
                        <span class="report-meta-label" data-i18n="Report.AssessmentTime">評估時間</span>
                        <span class="report-meta-value" id="assessmentTime">-</span>
                    </div>
                </div>

                <div class="maturity-info-box">
                    <svg class="info-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10"></circle>
                        <line x1="12" y1="16" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12.01" y2="8"></line>
                    </svg>
                    <span class="info-text">
                        <strong data-i18n="Assessment.MaturityLabel">M = 成熟度 (Maturity)</strong>
                        <span data-i18n="Assessment.MaturityDesc">：評估各項流程與能力的成熟程度，分數越高表示該領域越成熟</span>
                    </span>
                </div>
            </div>

            <!-- No Data Guide Section (當沒有報告數據時顯示) -->
            <div id="noReportGuide" class="report-no-data-guide" style="display: none;">
                <div class="no-data-card">
                    <div class="no-data-icon">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                            <polyline points="14 2 14 8 20 8"></polyline>
                            <line x1="16" y1="13" x2="8" y2="13"></line>
                            <line x1="16" y1="17" x2="8" y2="17"></line>
                        </svg>
                    </div>
                    <h2 class="no-data-title" data-i18n="Report.NoReportTitle">尚未生成報告</h2>
                    <p class="no-data-description" data-i18n="Report.NoReportDesc">完成風險評估問卷並付款後，即可查看您的專屬風險評估報告。</p>
                    <div class="no-data-actions">
                        <a href="@Url.Action("Assessment", "Home")" class="report-button primary">
                            <span data-i18n="Report.GoToAssessment">前往評估問卷</span>
                        </a>
                    </div>
                </div>
            </div>

            <div id="reportContent" class="report-layout" style="display: none;">
                <!-- System Name Display (for PDF) -->
                <div class="pdf-system-name" id="pdfSystemName" style="display: none;">
                    <h2 class="pdf-system-name-text" id="pdfSystemNameText"></h2>
                </div>
                
                <!-- Radar + Summary -->
                <section class="report-top" data-section="radar-summary">
                    <div class="report-card radar-card" data-block="radar">
                        <div class="section-header">
                            <h2 class="section-title" data-i18n="Report.RadarTitle">M1-M5 分數雷達圖</h2>
                            <p class="section-description" data-i18n="Report.RadarDesc">視覺化顯示五項關鍵風險指標</p>
                        </div>
                        <div class="radar-chart-container report-radar-container">
                            <div class="radar-chart">
                                <svg id="reportRadar" class="radar-svg" viewBox="-20 -20 240 240" preserveAspectRatio="xMidYMid meet">
                                    <!-- Background circles -->
                                    <circle cx="100" cy="100" r="80" class="radar-circle" />
                                    <circle cx="100" cy="100" r="60" class="radar-circle" />
                                    <circle cx="100" cy="100" r="40" class="radar-circle" />
                                    <circle cx="100" cy="100" r="20" class="radar-circle" />

                                    <!-- 5 axes -->
                                    <line x1="100" y1="100" x2="100" y2="20" class="radar-line" />
                                    <line x1="100" y1="100" x2="167" y2="70" class="radar-line" />
                                    <line x1="100" y1="100" x2="147" y2="160" class="radar-line" />
                                    <line x1="100" y1="100" x2="53" y2="160" class="radar-line" />
                                    <line x1="100" y1="100" x2="33" y2="70" class="radar-line" />

                                    <!-- Dynamic polygon for M1-M5 -->
                                    <polygon id="radarPolygon" points="" class="radar-polygon" />

                                    <!-- Axis labels -->
                                    <text x="100" y="15" class="radar-label" data-i18n="Report.RadarM1">M1 交接</text>
                                    <text x="180" y="75" class="radar-label" data-i18n="Report.RadarM2">M2 追溯</text>
                                    <text x="165" y="170" class="radar-label" data-i18n="Report.RadarM3">M3 變更</text>
                                    <text x="35" y="170" class="radar-label" data-i18n="Report.RadarM4">M4 驗收</text>
                                    <text x="20" y="75" class="radar-label" data-i18n="Report.RadarM5">M5 溝通</text>
                                </svg>
                            </div>
                        </div>
                    </div>

                    <div class="report-card fingerprint-card" data-block="fingerprint">
                        <div class="section-header">
                            <h2 class="section-title" data-i18n="Report.FingerprintTitle">風險指紋總結</h2>
                            <p class="section-description" data-i18n="Report.FingerprintDesc">整體風險輪廓與建議</p>
                        </div>
                        <div class="fingerprint-metrics">
                            <div class="metric-item">
                                <span class="metric-label" data-i18n="Report.TotalScore">總分</span>
                                <span class="metric-value" id="totalScore">0</span>
                            </div>
                            <div class="metric-item risk-level-item">
                                <span class="metric-label" data-i18n="Report.RiskLevel">風險等級</span>
                                <div class="risk-level-content">
                                    <div class="risk-level-row">
                                        <span class="metric-badge" id="riskLevel">-</span>
                                        <span class="metric-action" id="riskAction" style="display: inline-block; font-size: 11px; color: #b0b0b0; font-weight: normal; line-height: 1.4; margin-left: 12px;">-</span>
                                    </div>
                                    <span class="metric-threshold" id="riskThreshold" style="display: block; font-size: 10px; color: #888; font-weight: normal; line-height: 1.3; margin-top: 6px;">-</span>
                                </div>
                            </div>
                            <div class="metric-item">
                                <span class="metric-label" data-i18n="Report.SampleTime">樣本時間</span>
                                <span class="metric-value" id="surveyTime">-</span>
                            </div>
                        </div>
                        <!-- 分數說明表（移到風險分數下方） -->
                        <div class="score-description-table" id="scoreDescriptionTable" style="margin-top: 24px; padding: 16px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; display: none;">
                            <h3 style="margin: 0 0 12px 0; font-size: 14px; font-weight: 600; color: #e0e0e0;" data-i18n="Score.TableTitle">各指標分數說明</h3>
                            <table style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                <thead>
                                    <tr style="border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                                        <th style="padding: 8px; text-align: left; color: #b0b0b0; font-weight: 600;" data-i18n="Score.Indicator">指標</th>
                                        <th style="padding: 8px; text-align: center; color: #b0b0b0; font-weight: 600; width: 80px;" data-i18n="Score.Value">分數</th>
                                        <th style="padding: 8px; text-align: left; color: #b0b0b0; font-weight: 600;" data-i18n="Score.Description">說明</th>
                                    </tr>
                                </thead>
                                <tbody id="scoreTableBody">
                                    <!-- 動態填充 -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </section>

                <!-- Risk Improvement Advice Section (獨立區塊) -->
                <section class="report-advice-section" data-section="advice">
                    <div class="report-card advice-card" data-block="advice">
                        <div class="section-header">
                            <h2 class="section-title" data-i18n="Report.ImprovementAdvice">風險改善建議</h2>
                        </div>
                        <div class="advice-block">
                            <p class="advice-text" id="adviceText" data-i18n="Report.DefaultAdvice">
                                將根據您的問卷結果產生具體建議。
                            </p>
                            
                            <!-- 最小交付物建議區塊 -->
                            <div class="deliverables-block" id="deliverablesBlock" style="display: none; margin-top: 24px; padding-top: 20px; border-top: 1px solid rgba(255, 255, 255, 0.1);">
                                <h3 class="deliverables-title" style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 12px;" data-i18n="Report.DeliverablesTitle">本次評估建議之最小交付物：</h3>
                                <p class="deliverables-intro" id="deliverablesIntro" style="font-size: 12px; color: #b0b0b0; margin-bottom: 16px; line-height: 1.5;"></p>
                                <div class="deliverables-list" id="deliverablesList" style="font-size: 12px; color: #d0d0d0; line-height: 1.8;"></div>
                            </div>
                            
                            <div class="ai-refresh-hint" id="adviceRefreshHint" style="display: none; margin-top: 12px; padding: 8px 12px; background: rgba(98, 0, 234, 0.1); border-left: 3px solid #6200ea; border-radius: 4px; font-size: 12px; color: #b0b0b0; line-height: 1.5;">
                                <svg class="lightbulb-icon" style="width: 16px; height: 16px; flex-shrink: 0; color: #ffc107;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21h6"></path>
                                    <path d="M12 3a6 6 0 0 0-6 6c0 2.5 1.5 4.5 3 6a3 3 0 0 1 0 3h6a3 3 0 0 1 0-3c1.5-1.5 3-3.5 3-6a6 6 0 0 0-6-6z"></path>
                                    <line x1="9" y1="18" x2="15" y2="18"></line>
                                </svg>
                                <span><span data-i18n="Report.TipLabel">提示</span>：<span data-i18n="Report.RefreshHint">可以重新整理頁面(F5)</span><span data-i18n="Report.AIRefreshHint">產生替代建議（用於腦力激盪）</span></span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Open Questions Section -->
                <section class="report-open-questions" id="openQuestionsSection" style="display: none;" data-section="open-questions">
                    <div class="report-card" data-block="open-questions">
                        <div class="section-header">
                            <h2 class="section-title" data-i18n="Report.OpenQuestions">補充說明</h2>
                            <p class="section-description" data-i18n="Report.OpenQuestionsDesc">您的詳細說明與補充資訊</p>
                        </div>
                        <div class="open-questions-content">
                            <div class="open-question-item" id="openQ1" style="display: none;">
                                <h4 class="open-question-label" data-i18n="Assessment.OpenQ6">問題 6. 請描述您的專案面臨的主要挑戰</h4>
                                <p class="open-question-answer" id="answer-open1"></p>
                            </div>
                            <div class="open-question-item" id="openQ2" style="display: none;">
                                <h4 class="open-question-label" data-i18n="Assessment.OpenQ7">問題 7. 請說明您期望改善的領域</h4>
                                <p class="open-question-answer" id="answer-open2"></p>
                            </div>
                            <div class="open-question-item" id="openQ3" style="display: none;">
                                <h4 class="open-question-label" data-i18n="Assessment.OpenQ8">問題 8. 請提供其他相關資訊</h4>
                                <p class="open-question-answer" id="answer-open3"></p>
                            </div>
                            <div class="no-open-answers" id="noOpenAnswers" style="display: none;">
                                <p data-i18n="Report.NoOpenAnswers">未填寫補充說明</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- AI Insights Section -->
                <section class="report-ai-insights" id="aiInsightsSection" style="display: none;" data-section="ai-insights">
                    <div class="report-card" data-block="ai-insights">
                        <div class="section-header">
                            <h2 class="section-title" data-i18n="Report.AIInsights">風險洞察</h2>
                            <p class="section-description" data-i18n="Report.AIInsightsDesc">針對 M6、M7、M8 補充說明的深度分析</p>
                        </div>
                        <div class="ai-section" id="ai-insights">
                            <div id="insights-loading" data-i18n="Report.Analyzing">分析中...</div>
                            <div class="ai-refresh-hint" id="aiRefreshHint" style="display: none; margin-top: 12px; padding: 8px 12px; background: rgba(98, 0, 234, 0.1); border-left: 3px solid #6200ea; border-radius: 4px; font-size: 12px; color: #b0b0b0; line-height: 1.5;">
                                <svg class="lightbulb-icon" style="width: 16px; height: 16px; flex-shrink: 0; color: #ffc107;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M9 21h6"></path>
                                    <path d="M12 3a6 6 0 0 0-6 6c0 2.5 1.5 4.5 3 6a3 3 0 0 1 0 3h6a3 3 0 0 1 0-3c1.5-1.5 3-3.5 3-6a6 6 0 0 0-6-6z"></path>
                                    <line x1="9" y1="18" x2="15" y2="18"></line>
                                </svg>
                                <span><span data-i18n="Report.TipLabel">提示</span>：<span data-i18n="Report.RefreshHint">可以重新整理頁面(F5)</span><span data-i18n="Report.AIRefreshHint">產生替代建議（用於腦力激盪）</span></span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 30 天行動清單 Section -->
                <section class="report-action-plan" id="actionPlanSection" data-section="action-plan" style="display: none;">
                    <div class="report-card" data-block="action-plan">
                        <div class="section-header">
                            <h2 class="section-title" data-i18n="Report.ActionPlanTitle">30 天行動清單</h2>
                            <p class="section-description" data-i18n="Report.ActionPlanDesc">本次評估的下一步行動建議</p>
                        </div>
                        <div class="action-plan-content" id="actionPlanContent">
                            <!-- 動態生成內容 -->
                        </div>
                        <div class="risk-controlled-message" id="riskControlledMessage" style="display: none; padding: 16px; background: rgba(56, 142, 60, 0.1); border-radius: 8px; border-left: 3px solid #388e3c; font-size: 12px; line-height: 1.6; color: #b0b0b0;">
                            <p id="riskControlledText"></p>
                        </div>
                    </div>
                </section>

                <!-- Disclaimer Section -->
                <section class="report-disclaimer" data-section="disclaimer">
                    <div class="report-card" data-block="disclaimer" style="margin-top: 32px; padding: 20px; background: rgba(255, 255, 255, 0.03); border-radius: 8px; border-left: 3px solid #6200ea;">
                        <div class="disclaimer-content" style="font-size: 12px; line-height: 1.8; color: #b0b0b0;">
                            <div data-i18n="Report.DisclaimerContent" style="white-space: pre-line;">本報告依使用者自填資料產出

本報告適用於：
‧ 軟體專案風險盤點
‧ 系統交接與治理檢視
不取代：
‧ 稽核
‧ 法規認證
‧ 程式碼安全掃描</div>
                        </div>
                    </div>
                </section>

                <!-- Actions -->
                <section class="report-actions">
                    <button id="downloadPdfBtn" class="report-button primary" data-i18n="Report.DownloadPDF">
                        下載 PDF 報告
                    </button>
                </section>
            </div>
        </div>
    </main>

    <!-- Overlay for mobile -->
    <div class="overlay" id="overlay"></div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        const hamburger = document.getElementById('hamburger');
        const sidebar = document.getElementById('sidebar');
        const sidebarClose = document.getElementById('sidebarClose');
        const overlay = document.getElementById('overlay');
        const navItems = document.querySelectorAll('.nav-item');

        function toggleSidebar() {
            sidebar.classList.toggle('active');
            overlay.classList.toggle('active');
            document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
        }

        hamburger?.addEventListener('click', toggleSidebar);
        sidebarClose?.addEventListener('click', toggleSidebar);
        overlay?.addEventListener('click', toggleSidebar);

        navItems.forEach(item => {
            item.addEventListener('click', function (e) {
                if (this.getAttribute('href') === '#') {
                    e.preventDefault();
                }

                navItems.forEach(nav => nav.classList.remove('active'));
                this.classList.add('active');

                if (window.innerWidth <= 768) {
                    toggleSidebar();
                }
            });
        });

        window.addEventListener('resize', function () {
            if (window.innerWidth > 768) {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        });

        // 從服務端 Session 讀取問卷數據（完全移除 localStorage）
        async function parseSurveyData() {
            // 從服務端 Session 讀取（完全移除 localStorage）
            try {
                // 移除詳細日誌（安全考量）
                const response = await fetch('/Home/GetSurveyData', {
                    method: 'GET',
                    credentials: 'same-origin' // 確保發送 Cookie
                });
                
                if (response.ok) {
                    const result = await response.json();
                    
                    if (result.success && result.data) {
                        // 檢查是否有 M1-M5 分數（僅在開發環境顯示警告）
                        const hasMValues = result.data.M1 || result.data.M2 || result.data.M3 || 
                                         result.data.M4 || result.data.M5 || 
                                         result.data.m1 || result.data.m2 || 
                                         result.data.m3 || result.data.m4 || result.data.m5;
                        
                        if (!hasMValues && (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1')) {
                            console.warn('⚠️ 警告：數據中沒有 M1-M5 分數！這可能導致報告無法顯示。');
                        }
                        
                        // 同時保存時間戳到變數中
                        if (result.timestamp) {
                            window.surveyTimestamp = result.timestamp;
                        }
                        return result.data;
                    }
                }
            } catch (error) {
                // 僅在開發環境顯示錯誤詳情
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.error('無法從服務端 Session 讀取數據:', error);
                }
            }
            return null;
        }

        function toNumber(value) {
            const n = Number(value);
            return Number.isFinite(n) ? n : 0;
        }

        function computeRiskLevel(total) {
            // 根據總分（0-50）計算風險等級，始終返回中文，在顯示時再翻譯
            // 0-20：高、21-35：中、36-50：低
            if (total >= 36) return '低';
            if (total >= 21) return '中';
            return '高';
        }
        
        // 監聽語言變更事件，更新報告和 AI 內容
        window.addEventListener('languageChanged', async function() {
            // 在 updateReport() 之前，先保護已生成的內容
            // updateReport() 會調用 updatePage()，可能覆蓋已生成的內容
            const adviceEl = document.getElementById('adviceText');
            const hadGeneratedContent = adviceEl && !adviceEl.hasAttribute('data-i18n');
            
            await updateReport();
            
            // 重新獲取 AI 建議（使用新語言）
            const surveyData = await parseSurveyData();
            if (surveyData) {
                const toNumber = (value) => {
                    const n = Number(value);
                    return Number.isFinite(n) ? n : 0;
                };
                const m1 = toNumber((surveyData && (surveyData.M1 || surveyData.m1)) || 0);
                const m2 = toNumber((surveyData && (surveyData.M2 || surveyData.m2)) || 0);
                const m3 = toNumber((surveyData && (surveyData.M3 || surveyData.m3)) || 0);
                const m4 = toNumber((surveyData && (surveyData.M4 || surveyData.m4)) || 0);
                const m5 = toNumber((surveyData && (surveyData.M5 || surveyData.m5)) || 0);
                
                // 重新生成風險改善建議和 AI 洞察（使用新語言）
                generatePersonalizedAdvice(m1, m2, m3, m4, m5);
                // 確保 AI 區塊在語言切換後正確顯示
                const aiSection = document.getElementById('aiInsightsSection');
                const hasOpenAnswers = (surveyData.open1 && surveyData.open1.trim()) || 
                                      (surveyData.open2 && surveyData.open2.trim()) || 
                                      (surveyData.open3 && surveyData.open3.trim());
                if (hasOpenAnswers && aiSection) {
                    aiSection.style.display = 'block';
                }
                // 重新更新開放式問題（會自動根據語言翻譯）
                await updateOpenQuestions(surveyData);
                await getAIInsights();
            }
        });

        function updateRadarChart(m1, m2, m3, m4, m5) {
            const centerX = 100;
            const centerY = 100;
            const maxRadius = 80;
            const values = [m1, m2, m3, m4, m5];
            const angles = [-90, -18, 54, 126, 198].map(deg => (deg * Math.PI) / 180);

            const points = values.map((v, i) => {
                const ratio = Math.max(0, Math.min(10, v)) / 10;
                const r = maxRadius * ratio;
                const x = centerX + r * Math.cos(angles[i]);
                const y = centerY + r * Math.sin(angles[i]);
                return `${x},${y}`;
            });

            const polygon = document.getElementById('radarPolygon');
            if (polygon) {
                polygon.setAttribute('points', points.join(' '));
            }
        }

        function formatTimestamp(ts) {
            if (!ts) return '-';
            const d = new Date(ts);
            if (isNaN(d.getTime())) return '-';
            // 使用24小時制格式（日期不補零，時間補零）
            const year = d.getFullYear();
            const month = d.getMonth() + 1;  // 不補零：1, 2, ..., 12
            const day = d.getDate();  // 不補零：1, 2, ..., 31
            const hours = String(d.getHours()).padStart(2, '0');  // 補零：00, 01, ..., 23
            const minutes = String(d.getMinutes()).padStart(2, '0');
            const seconds = String(d.getSeconds()).padStart(2, '0');
            
            // 統一格式：2026/1/11 00:36:58
            return `${year}/${month}/${day} ${hours}:${minutes}:${seconds}`;
        }

        async function updateReport(forceRegenerate = false) {
            try {
                const data = await parseSurveyData();
            
            // 更新專案資訊（專案名稱、系統名稱、系統代號、評估人角色）
            const projectNameEl = document.getElementById('projectNameDisplay');
            const systemNameEl = document.getElementById('systemNameDisplay');
            const systemCodeEl = document.getElementById('systemCodeDisplay');
            const evaluatorRoleEl = document.getElementById('evaluatorRoleDisplay');
            const pdfSystemNameEl = document.getElementById('pdfSystemNameText');
            
            const projectName = (data && data.projectName) || '-';
            const systemName = (data && data.systemName) || '-';
            const systemCode = (data && data.systemCode) || '-';
            const evaluatorRole = (data && data.evaluatorRole) || '-';
            
            if (projectNameEl) {
                projectNameEl.textContent = projectName;
            }
            if (systemNameEl) {
                systemNameEl.textContent = systemName;
            }
            if (systemCodeEl) {
                systemCodeEl.textContent = systemCode;
            }
            if (evaluatorRoleEl) {
                evaluatorRoleEl.textContent = evaluatorRole;
            }
            
            // 更新PDF專用的系統名稱顯示（只在需要生成PDF時顯示）
            if (pdfSystemNameEl) {
                pdfSystemNameEl.textContent = systemName;
            }
            
            // 生成並顯示報告編號
            const reportIdEl = document.getElementById('reportIdDisplay');
            if (reportIdEl && systemCode && systemCode !== '-') {
                try {
                    const response = await fetch('/Home/GenerateReportId', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ systemCode: systemCode })
                    });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.success && result.reportId) {
                            reportIdEl.textContent = result.reportId;
                            // 保存報告編號到 Session
                            try {
                                await fetch('/Home/SaveReportId', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ reportId: result.reportId })
                                });
                            } catch (err) {
                                console.warn('保存報告編號到 Session 失敗:', err);
                            }
                        } else {
                            // 嘗試從 Session 讀取已保存的報告編號
                            try {
                                const savedResponse = await fetch('/Home/GetReportId');
                                if (savedResponse.ok) {
                                    const savedResult = await savedResponse.json();
                                    if (savedResult.success && savedResult.reportId && savedResult.reportId !== '-') {
                                        reportIdEl.textContent = savedResult.reportId;
                                    } else {
                                        reportIdEl.textContent = '-';
                                    }
                                } else {
                                    reportIdEl.textContent = '-';
                                }
                            } catch (err) {
                                reportIdEl.textContent = '-';
                            }
                        }
                    } else {
                        // 嘗試從 Session 讀取已保存的報告編號
                        try {
                            const savedResponse = await fetch('/Home/GetReportId');
                            if (savedResponse.ok) {
                                const savedResult = await savedResponse.json();
                                if (savedResult.success && savedResult.reportId && savedResult.reportId !== '-') {
                                    reportIdEl.textContent = savedResult.reportId;
                                } else {
                                    reportIdEl.textContent = '-';
                                }
                            } else {
                                reportIdEl.textContent = '-';
                            }
                        } catch (err) {
                            reportIdEl.textContent = '-';
                        }
                    }
                } catch (error) {
                    console.warn('生成報告編號失敗:', error);
                    reportIdEl.textContent = '-';
                }
            } else if (reportIdEl) {
                reportIdEl.textContent = '-';
            }
            
            // 更新評估時間（無論是否有數據都顯示）
            const assessmentTimeEl = document.getElementById('assessmentTime');
            if (assessmentTimeEl) {
                // 使用從 Session 讀取的時間戳
                const ts = window.surveyTimestamp;
                assessmentTimeEl.textContent = formatTimestamp(ts) || '-';
            }
            
            // 檢查是否有有效的問卷數據（至少有一個 M 分數）
            const hasValidData = data && (data.M1 || data.M2 || data.M3 || data.M4 || data.M5 || 
                                          data.m1 || data.m2 || data.m3 || data.m4 || data.m5);
            
            if (!hasValidData) {
                // 僅在開發環境顯示詳細錯誤
                if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                    console.error('✗ 沒有有效的問卷數據！顯示引導頁面。');
                }
                
                // 沒有問卷數據，顯示引導頁面，隱藏報告內容
                const reportContent = document.getElementById('reportContent');
                const noReportGuide = document.getElementById('noReportGuide');
                const reportActions = document.querySelector('.report-actions');
                
                if (reportContent) {
                    reportContent.style.display = 'none';
                }
                if (noReportGuide) {
                    noReportGuide.style.display = 'flex';
                }
                if (reportActions) {
                    reportActions.style.display = 'none';
                }
                return;
            }
            
            console.log('✓ 有有效的問卷數據，繼續生成報告...');
            
            // 有數據，顯示報告內容，隱藏引導頁面
            const reportContent = document.getElementById('reportContent');
            const noReportGuide = document.getElementById('noReportGuide');
            const reportActions = document.querySelector('.report-actions');
            
            if (reportContent) {
                reportContent.style.display = 'flex';
            }
            if (noReportGuide) {
                noReportGuide.style.display = 'none';
            }
            if (reportActions) {
                reportActions.style.display = 'flex';
            }

            console.log('處理問卷數據:', data);

            // 確保所有值都存在，如果沒有則使用 0
            const m1 = toNumber(data.M1 || data.m1 || 0);
            const m2 = toNumber(data.M2 || data.m2 || 0);
            const m3 = toNumber(data.M3 || data.m3 || 0);
            const m4 = toNumber(data.M4 || data.m4 || 0);
            const m5 = toNumber(data.M5 || data.m5 || 0);
            
            // 移除詳細日誌（安全考量）

            const total = m1 + m2 + m3 + m4 + m5;
            const level = computeRiskLevel(total);

            const totalScoreEl = document.getElementById('totalScore');
            if (totalScoreEl) {
                totalScoreEl.textContent = total.toFixed(1);
            }
            
            const levelEl = document.getElementById('riskLevel');
            const thresholdEl = document.getElementById('riskThreshold');
            if (levelEl) {
                // 風險等級翻譯
                const levelMap = {
                    'zh-TW': { '低': '低', '中': '中', '高': '高' },
                    'en-US': { '低': 'Low', '中': 'Medium', '高': 'High' }
                };
                levelEl.textContent = levelMap[i18n.currentLang]?.[level] || level;
                levelEl.classList.remove('low', 'medium', 'high');
                if (level === '低') levelEl.classList.add('low');
                else if (level === '中') levelEl.classList.add('medium');
                else levelEl.classList.add('high');
            }
            
            // 顯示風險等級門檻說明
            if (thresholdEl) {
                const currentLang = i18n.currentLang || 'zh-TW';
                const thresholdText = currentLang === 'zh-TW' 
                    ? '0–20 高、21–35 中、36–50 低'
                    : '0–20 High, 21–35 Medium, 36–50 Low';
                thresholdEl.textContent = thresholdText;
            }

            // 更新建議行動並調整英文版排版
            const actionEl = document.getElementById('riskAction');
            if (actionEl && thresholdEl) {
                const currentLang = i18n.currentLang || 'zh-TW';
                if (currentLang === 'en-US') {
                    // 英文版：建議和門檻說明都從風險等級徽章下方開始，左對齊
                    actionEl.style.marginLeft = '0';
                    actionEl.style.display = 'block';
                    actionEl.style.marginTop = '6px';
                    thresholdEl.style.marginLeft = '0';
                    thresholdEl.style.marginTop = '4px';
                } else {
                    // 中文版：保持原有排版（建議在右邊，門檻說明在下方）
                    actionEl.style.marginLeft = '12px';
                    actionEl.style.display = 'inline-block';
                    actionEl.style.marginTop = '0';
                    thresholdEl.style.marginLeft = '0';
                    thresholdEl.style.marginTop = '6px';
                }
            }
            if (actionEl) {
                const actionMap = {
                    'zh-TW': {
                        '高': '建議於 1–2 個月內啟動改善',
                        '中': '建議納入季度檢視',
                        '低': '建議半年複查'
                    },
                    'en-US': {
                        '高': 'Recommend initiating improvements within 1–2 months',
                        '中': 'Recommend quarterly review',
                        '低': 'Recommend semi-annual review'
                    }
                };
                const currentLang = i18n.currentLang || 'zh-TW';
                actionEl.textContent = actionMap[currentLang]?.[level] || '';
            }

            const ts = window.surveyTimestamp;
            const surveyTimeEl = document.getElementById('surveyTime');
            if (surveyTimeEl) {
                surveyTimeEl.textContent = formatTimestamp(ts);
            }
            
            // 更新評估日期
            // 修復：使用正確的變數名 assessmentTimeEl（不是 assessmentDateEl）
            const assessmentTimeElForUpdate = document.getElementById('assessmentTime');
            if (assessmentTimeElForUpdate) {
                assessmentTimeElForUpdate.textContent = formatTimestamp(ts) || '-';
            }

            // 風險改善建議改為 AI 生成
            const adviceEl = document.getElementById('adviceText');
            if (adviceEl) {
                // 如果強制重新生成，清除已生成的內容
                if (forceRegenerate) {
                    adviceEl.setAttribute('data-i18n', 'Report.DefaultAdvice');
                    adviceEl.textContent = i18n.t('Report.DefaultAdvice');
                }
                // 只有在沒有已生成的內容時才設置預設值
                // 如果元素沒有 data-i18n 屬性，說明已經有生成的內容，不要覆蓋
                if (adviceEl.hasAttribute('data-i18n')) {
                    adviceEl.textContent = i18n.t('Report.DefaultAdvice');
                }
                // 異步獲取 AI 建議（會更新內容並移除 data-i18n 屬性）
                generatePersonalizedAdvice(m1, m2, m3, m4, m5, forceRegenerate);
            } else {
                // 如果建議已經生成，只更新交付物
                updateDeliverables(m1, m2, m3, m4, m5);
            }

            // 生成 30 天行動清單
            generateActionPlan(m1, m2, m3, m4, m5, total);

            updateRadarChart(m1, m2, m3, m4, m5);

            // 更新分數說明表
            updateScoreDescriptionTable(m1, m2, m3, m4, m5);

            // Update open questions (補充說明)
            updateOpenQuestions(data);
            
            // 如果有補充說明，觸發 AI 分析（注意：不要在 updateReport 中調用，避免重複）
            // getAIInsights() 會在頁面初始化時單獨調用
            } catch (error) {
                console.error('updateReport 錯誤:', error);
                // 發生錯誤時，至少顯示引導頁面
                const reportContent = document.getElementById('reportContent');
                const noReportGuide = document.getElementById('noReportGuide');
                if (reportContent) {
                    reportContent.style.display = 'none';
                }
                if (noReportGuide) {
                    noReportGuide.style.display = 'flex';
                }
            }
        }

        function updateScoreDescriptionTable(m1, m2, m3, m4, m5) {
            const tableBody = document.getElementById('scoreTableBody');
            const scoreTable = document.getElementById('scoreDescriptionTable');
            
            if (!tableBody || !scoreTable) return;

            // 指標配置
            const metrics = [
                { key: 'M1', label: 'M1 交接', value: m1, i18nKey: 'Report.RadarM1' },
                { key: 'M2', label: 'M2 追溯', value: m2, i18nKey: 'Report.RadarM2' },
                { key: 'M3', label: 'M3 變更', value: m3, i18nKey: 'Report.RadarM3' },
                { key: 'M4', label: 'M4 驗收', value: m4, i18nKey: 'Report.RadarM4' },
                { key: 'M5', label: 'M5 溝通', value: m5, i18nKey: 'Report.RadarM5' }
            ];

            // 清空表格內容
            tableBody.innerHTML = '';

            // 填充表格
            metrics.forEach(metric => {
                const description = i18n.getScoreDescription(metric.key, metric.value);
                const label = i18n.t(metric.i18nKey);
                
                const row = document.createElement('tr');
                row.style.borderBottom = '1px solid rgba(255, 255, 255, 0.05)';
                
                row.innerHTML = `
                    <td style="padding: 10px 8px; color: #e0e0e0;">${label}</td>
                    <td style="padding: 10px 8px; text-align: center; color: #ffffff; font-weight: 600;">${metric.value.toFixed(1)}</td>
                    <td style="padding: 10px 8px; color: #b0b0b0; line-height: 1.5;">${description || '-'}</td>
                `;
                
                tableBody.appendChild(row);
            });

            // 顯示表格
            scoreTable.style.display = 'block';
        }

        async function updateOpenQuestions(data) {
            const openQuestionsSection = document.getElementById('openQuestionsSection');
            const noOpenAnswers = document.getElementById('noOpenAnswers');
            let hasAnswers = false;

            // 如果語言是英文，先翻譯內容
            let displayData = { ...data };
            const currentLang = i18n.currentLang || 'zh-TW';
            if (currentLang === 'en-US' && (data.open1 || data.open2 || data.open3)) {
                try {
                    const translateResponse = await fetch('/Home/TranslateOpenQuestions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            lang: currentLang,
                            open1: data.open1 || '',
                            open2: data.open2 || '',
                            open3: data.open3 || ''
                        })
                    });
                    
                    if (translateResponse.ok) {
                        const translateResult = await translateResponse.json();
                        if (translateResult.success) {
                            displayData = {
                                ...data,
                                open1: translateResult.open1 || data.open1,
                                open2: translateResult.open2 || data.open2,
                                open3: translateResult.open3 || data.open3
                            };
                        }
                    }
                } catch (error) {
                    console.warn('翻譯開放式問題失敗，使用原始內容:', error);
                }
            }

            // Check and display open1
            if (displayData.open1 && displayData.open1.trim()) {
                const answerEl = document.getElementById('answer-open1');
                const questionEl = document.getElementById('openQ1');
                if (answerEl && questionEl) {
                    answerEl.textContent = displayData.open1;
                    questionEl.style.display = 'block';
                    hasAnswers = true;
                }
            } else {
                const questionEl = document.getElementById('openQ1');
                if (questionEl) questionEl.style.display = 'none';
            }

            // Check and display open2
            if (displayData.open2 && displayData.open2.trim()) {
                const answerEl = document.getElementById('answer-open2');
                const questionEl = document.getElementById('openQ2');
                if (answerEl && questionEl) {
                    answerEl.textContent = displayData.open2;
                    questionEl.style.display = 'block';
                    hasAnswers = true;
                }
            } else {
                const questionEl = document.getElementById('openQ2');
                if (questionEl) questionEl.style.display = 'none';
            }

            // Check and display open3
            if (displayData.open3 && displayData.open3.trim()) {
                const answerEl = document.getElementById('answer-open3');
                const questionEl = document.getElementById('openQ3');
                if (answerEl && questionEl) {
                    answerEl.textContent = displayData.open3;
                    questionEl.style.display = 'block';
                    hasAnswers = true;
                }
            } else {
                const questionEl = document.getElementById('openQ3');
                if (questionEl) questionEl.style.display = 'none';
            }

            // Show/hide section
            if (openQuestionsSection) {
                if (hasAnswers) {
                    openQuestionsSection.style.display = 'block';
                    if (noOpenAnswers) noOpenAnswers.style.display = 'none';
                } else {
                    openQuestionsSection.style.display = 'none';
                }
            }
        }

        // AI Insights 函數
        async function getAIInsights(forceRegenerate = false) {
            try {
                const aiSection = document.getElementById('aiInsightsSection');
                const insightsLoading = document.getElementById('insights-loading');
                
                if (!aiSection || !insightsLoading) {
                    console.warn('AI 區塊元素未找到');
                    return;
                }
                
                // 從現有數據源讀取補充說明（open1, open2, open3 對應 m6, m7, m8）
                const surveyData = await parseSurveyData();
                
                // 提取補充說明
                const m6 = (surveyData && surveyData.open1) || '';
                const m7 = (surveyData && surveyData.open2) || '';
                const m8 = (surveyData && surveyData.open3) || '';
                
                // 檢查是否有任何補充說明
                const hasOpenAnswers = (m6 && m6.trim()) || (m7 && m7.trim()) || (m8 && m8.trim());
                
                if (!hasOpenAnswers) {
                    console.log('未找到補充說明，隱藏 AI 區塊');
                    aiSection.style.display = 'none';
                    return;
                }
                
                // 提取 M1-M5 分數作為上下文
                const toNumber = (value) => {
                    const n = Number(value);
                    return Number.isFinite(n) ? n : 0;
                };
                
                const m1 = toNumber((surveyData && (surveyData.M1 || surveyData.m1)) || 0);
                const m2 = toNumber((surveyData && (surveyData.M2 || surveyData.m2)) || 0);
                const m3 = toNumber((surveyData && (surveyData.M3 || surveyData.m3)) || 0);
                const m4 = toNumber((surveyData && (surveyData.M4 || surveyData.m4)) || 0);
                const m5 = toNumber((surveyData && (surveyData.M5 || surveyData.m5)) || 0);
                
                // 顯示區塊並開始載入
                // 移除敏感數據的 console.log（安全考量）
                aiSection.style.display = 'block';
                const currentLang = i18n.currentLang || 'zh-TW';
                insightsLoading.textContent = currentLang === 'zh-TW' ? '分析中...' : 'Analyzing...';
                
                // 構建請求數據（包含 M1-M5 分數和 M6-M8 補充說明）
                const m678Data = {
                    lang: currentLang,
                    forceRegenerate: forceRegenerate ? 'true' : 'false',
                    m1: String(m1),
                    m2: String(m2),
                    m3: String(m3),
                    m4: String(m4),
                    m5: String(m5),
                    m6: m6 || '',
                    m7: m7 || '',
                    m8: m8 || ''
                };
                
                // 移除敏感數據的 console.log（安全考量）
                
                // 創建 AbortController 用於超時控制
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 65000); // 65 秒超時（比後端的 60 秒長一點）
                
                try {
                    const response = await fetch('/Home/GenerateInsights', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(m678Data),
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error('AI API 響應錯誤:', response.status, errorText);
                        throw new Error(`無法獲取 AI 洞察 (${response.status}): ${errorText.substring(0, 200)}`);
                    }
                    
                    const data = await response.json();
                    // 移除 AI 生成內容的 console.log（安全考量：避免敏感資訊洩露）
                    
                    // 使用 requestAnimationFrame 確保 DOM 已更新
                    await new Promise(resolve => requestAnimationFrame(resolve));
                    
                    // 確保 insightsLoading 元素仍然存在（可能在動態更新過程中）
                    let currentInsightsLoading = document.getElementById('insights-loading');
                    
                    // 如果找不到元素，嘗試從 aiSection 中查找
                    if (!currentInsightsLoading) {
                        console.warn('insights-loading 元素不存在，嘗試重新查找');
                        const aiSection = document.getElementById('aiInsightsSection');
                        if (aiSection) {
                            currentInsightsLoading = aiSection.querySelector('#insights-loading');
                        }
                    }
                    
                    if (!currentInsightsLoading) {
                        console.error('無法找到 insights-loading 元素，無法更新');
                        return;
                    }
                    
                    if (data.insights && data.insights.trim()) {
                        // 顯示 AI 洞察內容，保留換行和格式
                        // 移除 console.log（安全考量）
                        
                        // 移除 data-i18n 屬性，避免 i18n.updatePage() 覆蓋內容
                        currentInsightsLoading.removeAttribute('data-i18n');
                        
                        // 更新內容
                        currentInsightsLoading.innerHTML = data.insights.replace(/\n/g, '<br>');
                        
                        // 強制觸發重排，確保內容顯示
                        currentInsightsLoading.offsetHeight;
                        
                        // 顯示後，顯示刷新提示（如果存在）
                        const refreshHint = document.getElementById('aiRefreshHint');
                        if (refreshHint) {
                            refreshHint.style.display = 'flex';
                            // 確保提示文字也更新語言（但不會影響已更新的 AI 內容）
                            i18n.updatePage();
                        }
                        
                        // 移除 console.log（安全考量）
                    } else {
                        console.warn('AI 洞察內容為空');
                        const currentLang = i18n.currentLang || 'zh-TW';
                        // 移除 data-i18n 屬性，避免被覆蓋
                        currentInsightsLoading.removeAttribute('data-i18n');
                        currentInsightsLoading.textContent = currentLang === 'zh-TW' 
                            ? '暫時無法生成 AI 洞察' 
                            : 'Unable to generate AI insights';
                    }
                } catch (fetchError) {
                    clearTimeout(timeoutId);
                    if (fetchError.name === 'AbortError') {
                        throw new Error('請求超時，請稍後再試');
                    }
                    throw fetchError;
                }
            } catch (error) {
                console.error('AI 洞察載入錯誤:', error);
                const insightsLoading = document.getElementById('insights-loading');
                const currentLang = i18n.currentLang || 'zh-TW';
                if (insightsLoading) {
                    // 移除 data-i18n 屬性，避免被覆蓋
                    insightsLoading.removeAttribute('data-i18n');
                    let errorMsg;
                    if (error.message.includes('超時') || error.message.includes('timeout')) {
                        errorMsg = currentLang === 'zh-TW'
                            ? 'AI 分析請求超時，請重新整理頁面後再試'
                            : 'AI analysis request timed out, please refresh and try again';
                    } else {
                        errorMsg = currentLang === 'zh-TW'
                            ? `AI 洞察載入失敗：${error.message}`
                            : `Failed to load AI insights: ${error.message}`;
                    }
                    insightsLoading.innerHTML = `<span style="color: #ff6b6b;">${errorMsg}</span>`;
                }
                // 即使出錯也顯示區塊，讓用戶知道有問題
                const aiSection = document.getElementById('aiInsightsSection');
                if (aiSection) {
                    aiSection.style.display = 'block';
                }
            }
        }

        // 格式化風險改善建議文本（將條列式內容轉換為分段排版）
        function formatAdviceText(text) {
            if (!text) return '';
            
            // 將文本按行分割
            const lines = text.split('\n').filter(line => line.trim());
            let html = '';
            
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue;
                
                // 檢查是否為條列式開頭（數字、•、-、* 等）
                const isListItem = /^(\d+[\.\)]|[\u2022\u2023\u25E6\u2043\u2219•\-\*])\s/.test(line) || 
                                   /^【/.test(line) || 
                                   /^[A-Z][a-z]+ \d+:/.test(line); // 匹配 "Recommendation 1:" 格式
                
                if (isListItem) {
                    // 條列式項目，使用段落並添加適當的樣式
                    html += `<p style="margin: 8px 0; padding-left: 16px; line-height: 1.6;">${escapeHtml(line)}</p>`;
                } else {
                    // 普通段落
                    html += `<p style="margin: 8px 0; line-height: 1.6;">${escapeHtml(line)}</p>`;
                }
            }
            
            return html || escapeHtml(text);
        }
        
        // HTML 轉義函數
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 風險改善建議 AI 生成函數
        async function generatePersonalizedAdvice(m1, m2, m3, m4, m5, forceRegenerate = false) {
            try {
                const adviceEl = document.getElementById('adviceText');
                if (!adviceEl) return;

                const currentLang = i18n.currentLang || 'zh-TW';
                adviceEl.textContent = currentLang === 'zh-TW' ? '生成中...' : 'Generating...';

                const adviceData = {
                    lang: currentLang,
                    forceRegenerate: forceRegenerate ? 'true' : 'false',
                    m1: String(m1),
                    m2: String(m2),
                    m3: String(m3),
                    m4: String(m4),
                    m5: String(m5)
                };

                const response = await fetch('/Home/GeneratePersonalizedAdvice', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(adviceData)
                });

                if (!response.ok) {
                    throw new Error(`無法獲取風險改善建議 (${response.status})`);
                }

                const data = await response.json();
                if (data.advice) {
                    // 移除 data-i18n 屬性，避免 i18n.updatePage() 覆蓋內容
                    adviceEl.removeAttribute('data-i18n');
                    // 將條列式內容轉換為分段排版（將數字開頭的行和條列符號轉換為段落）
                    const formattedAdvice = formatAdviceText(data.advice);
                    adviceEl.innerHTML = formattedAdvice;
                    
                    // 顯示 F5 提示
                    const refreshHint = document.getElementById('adviceRefreshHint');
                    if (refreshHint) {
                        refreshHint.style.display = 'flex';
                    }
                    
                    // 更新最小交付物建議
                    updateDeliverables(m1, m2, m3, m4, m5);
                } else {
                    // 移除 data-i18n 屬性，避免被覆蓋
                    adviceEl.removeAttribute('data-i18n');
                    adviceEl.textContent = currentLang === 'zh-TW'
                        ? '暫時無法生成風險改善建議'
                        : 'Unable to generate risk improvement recommendations';
                }
            } catch (error) {
                console.error('風險改善建議載入錯誤:', error);
                const adviceEl = document.getElementById('adviceText');
                const currentLang = i18n.currentLang || 'zh-TW';
                if (adviceEl) {
                    // 移除 data-i18n 屬性，避免被覆蓋
                    adviceEl.removeAttribute('data-i18n');
                    adviceEl.textContent = currentLang === 'zh-TW'
                        ? '風險改善建議載入失敗，請稍後再試'
                        : 'Failed to load risk improvement recommendations, please try again later';
                }
            }
        }

        // 最小交付物對應表（中文）
        const deliverablesMapZh = {
            'M1': ['交接清單', '文件目錄規範', '交接會議模板'],
            'M2': ['需求追溯矩陣（RTM）', '變更紀錄表'],
            'M3': ['變更影響評估表', '變更決策紀錄'],
            'M4': ['驗收條件清單', 'Definition of Done 範本'],
            'M5': ['角色責任表（RACI）', '會議節奏表']
        };
        
        // 最小交付物對應表（英文）
        const deliverablesMapEn = {
            'M1': ['Handover Checklist', 'Documentation Structure', 'Handover Meeting Template'],
            'M2': ['Requirements Traceability Matrix (RTM)', 'Change Log'],
            'M3': ['Impact Analysis', 'Decision Record'],
            'M4': ['Acceptance Criteria', 'Definition of Done Template'],
            'M5': ['RACI Chart', 'Meeting Cadence']
        };
        
        // 根據語言選擇對應的交付物表
        function getDeliverablesMap() {
            const currentLang = i18n.currentLang || 'zh-TW';
            return currentLang === 'en-US' ? deliverablesMapEn : deliverablesMapZh;
        }

        // 決定要顯示哪些M的交付物（規則A、B、C）
        function determineDeliverables(m1, m2, m3, m4, m5) {
            const scores = [
                { key: 'M1', value: m1, label: 'M1' },
                { key: 'M2', value: m2, label: 'M2' },
                { key: 'M3', value: m3, label: 'M3' },
                { key: 'M4', value: m4, label: 'M4' },
                { key: 'M5', value: m5, label: 'M5' }
            ];

            // 規則A：找出所有 M ≤ 6 的項目
            const lowScores = scores.filter(item => item.value <= 6).sort((a, b) => a.value - b.value);

            // 規則B：最多選前2個風險最高的M（分數最低的2個）
            let selectedMs = [];
            let isPreventive = false;

            if (lowScores.length > 0) {
                // 有M ≤ 6的情況
                selectedMs = lowScores.slice(0, 2); // 最多2個
            } else {
                // 規則C：全部 > 6分，選分數最低的那一個作為預防性建議
                const allSorted = scores.sort((a, b) => a.value - b.value);
                selectedMs = [allSorted[0]]; // 選分數最低的
                isPreventive = true;
            }

            return {
                selectedMs: selectedMs,
                isPreventive: isPreventive
            };
        }

        // 生成最小交付物建議HTML
        function generateDeliverablesHTML(m1, m2, m3, m4, m5) {
            const result = determineDeliverables(m1, m2, m3, m4, m5);
            const currentLang = i18n.currentLang || 'zh-TW';
            
            if (result.selectedMs.length === 0) {
                return null;
            }

            let html = '';
            
            // 生成介紹文字
            let introText = '';
            if (result.isPreventive) {
                introText = currentLang === 'zh-TW'
                    ? '作為預防性強化，建議建立以下最小交付物，以降低未來交接與變更風險。'
                    : 'As a preventive measure, it is recommended to establish the following minimum deliverables to reduce future handover and change risks.';
            } else {
                introText = currentLang === 'zh-TW'
                    ? '針對評估中發現的風險項目，建議優先建立以下最小交付物：'
                    : 'For the risk items identified in the assessment, it is recommended to prioritize establishing the following minimum deliverables:';
            }

            // 生成交付物列表
            const deliverablesMap = getDeliverablesMap();
            const separator = currentLang === 'zh-TW' ? '、' : ', ';
            result.selectedMs.forEach((item, index) => {
                const deliverables = deliverablesMap[item.key];
                if (deliverables && deliverables.length > 0) {
                    const deliverablesText = deliverables.join(separator);
                    html += `<div style="margin-bottom: ${index < result.selectedMs.length - 1 ? '8px' : '0'};"><strong>${item.label}：</strong>${deliverablesText}</div>`;
                }
            });

            return {
                intro: introText,
                list: html
            };
        }

        // 更新最小交付物顯示
        function updateDeliverables(m1, m2, m3, m4, m5) {
            const deliverablesBlock = document.getElementById('deliverablesBlock');
            const deliverablesIntro = document.getElementById('deliverablesIntro');
            const deliverablesList = document.getElementById('deliverablesList');

            if (!deliverablesBlock || !deliverablesIntro || !deliverablesList) {
                return;
            }

            const content = generateDeliverablesHTML(m1, m2, m3, m4, m5);
            
            if (content) {
                deliverablesIntro.textContent = content.intro;
                deliverablesList.innerHTML = content.list;
                deliverablesBlock.style.display = 'block';
            } else {
                deliverablesBlock.style.display = 'none';
            }
        }

        // 判斷是否需要顯示 30 天行動清單
        function shouldShowActionPlan(m1, m2, m3, m4, m5, total) {
            // 條件 A：是否存在任一 M ≤ 6？
            const hasLowM = m1 <= 6 || m2 <= 6 || m3 <= 6 || m4 <= 6 || m5 <= 6;
            
            // 條件 B：整體 Risk Level 是否為 High？（total ≤ 20）
            const isHighRisk = total <= 20;
            
            // 若（條件 A 為真）或（條件 B 為真）→ 顯示
            return hasLowM || isHighRisk;
        }

        // 選擇風險最高的 1 個 M（分數最低者）
        function selectHighestRiskM(m1, m2, m3, m4, m5) {
            const currentLang = i18n.currentLang || 'zh-TW';
            const nameMap = {
                'zh-TW': {
                    'M1': '系統交接',
                    'M2': '需求追溯',
                    'M3': '變更預測',
                    'M4': '驗收標準',
                    'M5': '溝通成本'
                },
                'en-US': {
                    'M1': 'System Handover',
                    'M2': 'Requirements Traceability',
                    'M3': 'Change Prediction',
                    'M4': 'Acceptance Criteria',
                    'M5': 'Communication Cost'
                }
            };
            
            const scores = [
                { key: 'M1', value: m1, label: 'M1', name: nameMap[currentLang]['M1'] },
                { key: 'M2', value: m2, label: 'M2', name: nameMap[currentLang]['M2'] },
                { key: 'M3', value: m3, label: 'M3', name: nameMap[currentLang]['M3'] },
                { key: 'M4', value: m4, label: 'M4', name: nameMap[currentLang]['M4'] },
                { key: 'M5', value: m5, label: 'M5', name: nameMap[currentLang]['M5'] }
            ];
            
            // 按分數由低到高排序，取第一個（分數最低的）
            const sorted = scores.sort((a, b) => a.value - b.value);
            return sorted[0];
        }

        // 取得最基礎/最快完成的交付物（7 天內）
        function getBasicDeliverable(mKey) {
            const deliverablesMap = getDeliverablesMap();
            const deliverables = deliverablesMap[mKey];
            if (!deliverables || deliverables.length === 0) return null;
            // 返回第一個（最基礎的）
            return deliverables[0];
        }

        // 生成 30 天行動清單
        async function generateActionPlan(m1, m2, m3, m4, m5, total) {
            const actionPlanSection = document.getElementById('actionPlanSection');
            const actionPlanContent = document.getElementById('actionPlanContent');
            const riskControlledMessage = document.getElementById('riskControlledMessage');
            const riskControlledText = document.getElementById('riskControlledText');
            
            if (!actionPlanSection || !actionPlanContent) {
                return;
            }

            const shouldShow = shouldShowActionPlan(m1, m2, m3, m4, m5, total);
            const currentLang = i18n.currentLang || 'zh-TW';

            if (!shouldShow) {
                // 不顯示行動清單，顯示風險可控說明
                actionPlanSection.style.display = 'block';
                actionPlanContent.style.display = 'none';
                riskControlledMessage.style.display = 'block';
                
                const controlledText = currentLang === 'zh-TW'
                    ? '根據本次評估結果，您的專案風險處於可控範圍內。建議持續關注各項指標的變化，並定期進行複評以確保風險管理機制有效運作。'
                    : 'Based on this assessment, your project risks are within a controllable range. It is recommended to continue monitoring changes in each indicator and conduct regular reviews to ensure risk management mechanisms are operating effectively.';
                
                riskControlledText.textContent = controlledText;
                return;
            }

            // 顯示行動清單
            actionPlanSection.style.display = 'block';
            actionPlanContent.style.display = 'block';
            riskControlledMessage.style.display = 'none';

            // 選擇風險最高的 M
            const selectedM = selectHighestRiskM(m1, m2, m3, m4, m5);
            const basicDeliverable = getBasicDeliverable(selectedM.key);
            
            if (!basicDeliverable) {
                actionPlanContent.innerHTML = currentLang === 'zh-TW' 
                    ? '<p>無法生成行動清單</p>'
                    : '<p>Unable to generate action plan</p>';
                return;
            }

            // 顯示載入中
            actionPlanContent.innerHTML = currentLang === 'zh-TW' 
                ? '<p>生成中...</p>'
                : '<p>Generating...</p>';

            try {
                // 調用 AI 生成行動清單
                const deliverables = getDeliverablesMap()[selectedM.key] || [];
                // 移除敏感數據的 console.log（安全考量）
                
                const response = await fetch('/Home/GenerateActionPlan', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        lang: currentLang,
                        mKey: selectedM.key,
                        mValue: String(selectedM.value),
                        mName: selectedM.name,
                        basicDeliverable: basicDeliverable,
                        allDeliverables: JSON.stringify(deliverables)
                    })
                });

                if (!response.ok) {
                    throw new Error(`無法獲取行動清單 (${response.status})`);
                }

                const data = await response.json();
                if (data.success && data.actionPlan) {
                    // 格式化並顯示行動清單
                    const formattedPlan = formatActionPlan(data.actionPlan, currentLang);
                    actionPlanContent.innerHTML = formattedPlan;
                } else {
                    const errorMsg = data.message || (currentLang === 'zh-TW' ? '無法生成行動清單' : 'Unable to generate action plan');
                    console.error('行動清單生成失敗:', data);
                    throw new Error(errorMsg);
                }
            } catch (error) {
                console.error('行動清單載入錯誤:', error);
                const errorMessage = error.message || (currentLang === 'zh-TW' ? '未知錯誤' : 'Unknown error');
                actionPlanContent.innerHTML = currentLang === 'zh-TW'
                    ? `<p style="color: #ff6b6b;">行動清單載入失敗：${errorMessage}<br>請檢查瀏覽器控制台以獲取詳細資訊。</p>`
                    : `<p style="color: #ff6b6b;">Failed to load action plan: ${errorMessage}<br>Please check the browser console for details.</p>`;
            }
        }

        // 格式化行動清單 HTML
        function formatActionPlan(actionPlan, lang) {
            const title = lang === 'zh-TW' 
                ? '本次評估的下一步行動清單（30 天）'
                : 'Next Steps Action Plan (30 Days) for This Assessment';
            
            let html = `<h3 style="font-size: 14px; font-weight: 600; color: #e0e0e0; margin-bottom: 16px;">${title}</h3>`;
            
            if (actionPlan.day7) {
                const day7Title = lang === 'zh-TW' ? '7 天內｜建立基礎' : 'Within 7 Days | Establish Foundation';
                html += `<div style="margin-bottom: 16px;">
                    <h4 style="font-size: 13px; font-weight: 600; color: #d0d0d0; margin-bottom: 8px;">${day7Title}</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #b0b0b0; line-height: 1.8;">
                        <li>${actionPlan.day7}</li>
                    </ul>
                </div>`;
            }
            
            if (actionPlan.day14) {
                const day14Title = lang === 'zh-TW' ? '14 天內｜形成機制' : 'Within 14 Days | Form Mechanism';
                html += `<div style="margin-bottom: 16px;">
                    <h4 style="font-size: 13px; font-weight: 600; color: #d0d0d0; margin-bottom: 8px;">${day14Title}</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #b0b0b0; line-height: 1.8;">
                        <li>${actionPlan.day14}</li>
                    </ul>
                </div>`;
            }
            
            if (actionPlan.day30) {
                const day30Title = lang === 'zh-TW' ? '30 天內｜演練與驗證' : 'Within 30 Days | Practice and Verify';
                html += `<div style="margin-bottom: 0;">
                    <h4 style="font-size: 13px; font-weight: 600; color: #d0d0d0; margin-bottom: 8px;">${day30Title}</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #b0b0b0; line-height: 1.8;">
                        <li>${actionPlan.day30}</li>
                    </ul>
                </div>`;
            }
            
            return html;
        }

        // 格式化行動清單 HTML（用於 PDF）
        function formatActionPlanForPDF(actionPlan, lang) {
            const title = lang === 'zh-TW' 
                ? '本次評估的下一步行動清單（30 天）'
                : 'Next Steps Action Plan (30 Days) for This Assessment';
            
            let html = `<h4 style="font-size: 13px; font-weight: 600; color: #333; margin-bottom: 12px;">${title}</h4>`;
            
            if (actionPlan.day7) {
                const day7Title = lang === 'zh-TW' ? '7 天內｜建立基礎' : 'Within 7 Days | Establish Foundation';
                html += `<div style="margin-bottom: 12px;">
                    <h5 style="font-size: 12px; font-weight: 600; color: #555; margin-bottom: 6px;">${day7Title}</h5>
                    <p style="margin: 0; font-size: 11px; color: #666; line-height: 1.6; padding-left: 12px;">${actionPlan.day7}</p>
                </div>`;
            }
            
            if (actionPlan.day14) {
                const day14Title = lang === 'zh-TW' ? '14 天內｜形成機制' : 'Within 14 Days | Form Mechanism';
                html += `<div style="margin-bottom: 12px;">
                    <h5 style="font-size: 12px; font-weight: 600; color: #555; margin-bottom: 6px;">${day14Title}</h5>
                    <p style="margin: 0; font-size: 11px; color: #666; line-height: 1.6; padding-left: 12px;">${actionPlan.day14}</p>
                </div>`;
            }
            
            if (actionPlan.day30) {
                const day30Title = lang === 'zh-TW' ? '30 天內｜演練與驗證' : 'Within 30 Days | Practice and Verify';
                html += `<div style="margin-bottom: 0;">
                    <h5 style="font-size: 12px; font-weight: 600; color: #555; margin-bottom: 6px;">${day30Title}</h5>
                    <p style="margin: 0; font-size: 11px; color: #666; line-height: 1.6; padding-left: 12px;">${actionPlan.day30}</p>
                </div>`;
            }
            
            return html;
        }
        
        // 從 HTML 內容轉換為 PDF 格式（用於確保 PDF 和頁面一致）
        function formatActionPlanForPDFFromHTML(htmlContent, lang) {
            // 創建臨時元素來解析 HTML
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            // 提取文本內容並格式化
            const text = tempDiv.textContent || tempDiv.innerText || '';
            return formatActionPlanForPDFFromText(text, lang);
        }
        
        // 從純文本內容轉換為 PDF 格式
        function formatActionPlanForPDFFromText(text, lang) {
            // 簡單的文本格式化，保持原有的段落結構
            const lines = text.split('\n').filter(line => line.trim());
            let formatted = '';
            
            lines.forEach(line => {
                const trimmed = line.trim();
                if (trimmed) {
                    // 檢查是否是標題（包含天數）
                    if (trimmed.includes('7') && (trimmed.includes('天') || trimmed.includes('day'))) {
                        formatted += `<h4 style="margin: 12px 0 6px 0; font-size: 13px; font-weight: 600; color: #333;">${trimmed}</h4>`;
                    } else if (trimmed.includes('14') && (trimmed.includes('天') || trimmed.includes('day'))) {
                        formatted += `<h4 style="margin: 12px 0 6px 0; font-size: 13px; font-weight: 600; color: #333;">${trimmed}</h4>`;
                    } else if (trimmed.includes('30') && (trimmed.includes('天') || trimmed.includes('day'))) {
                        formatted += `<h4 style="margin: 12px 0 6px 0; font-size: 13px; font-weight: 600; color: #333;">${trimmed}</h4>`;
                    } else {
                        formatted += `<p style="margin: 0 0 8px 0; font-size: 11px; line-height: 1.6; color: #555;">${trimmed}</p>`;
                    }
                }
            });
            
            return formatted || text;
        }

        // 添加頁首頁尾的輔助函數
        function addHeaderFooter(pdf, pageNumber, totalPages, systemName) {
            // 確保頁面存在，如果不存在則不添加頁首頁尾
            const currentTotalPages = pdf.internal.getNumberOfPages();
            if (pageNumber > currentTotalPages) {
                console.warn(`頁面 ${pageNumber} 不存在，跳過添加頁首頁尾`);
                return;
            }
            
            // 記錄添加頁首頁尾前的頁數，確保不會創建新頁面
            const pagesBefore = pdf.internal.getNumberOfPages();
            
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 10;
            const headerHeight = 15;
            const footerHeight = 15;
            
            // 保存當前狀態
            pdf.saveGraphicsState();
            
            // 確保設置到正確的頁面（不創建新頁面）
            try {
                pdf.setPage(pageNumber);
            } catch (e) {
                console.warn(`無法設置到頁面 ${pageNumber}:`, e);
                pdf.restoreGraphicsState();
                return;
            }
            
            // 頁首
            pdf.setDrawColor(200, 200, 200);
            pdf.setLineWidth(0.1);
            pdf.line(margin, margin + headerHeight, pageWidth - margin, margin + headerHeight);
            
            pdf.setTextColor(100, 100, 100);
            pdf.setFontSize(8);
            pdf.setFont('helvetica', 'normal');
            
            // 左側：系統名稱（如果是中文，使用 canvas 渲染為圖片）
            if (systemName) {
                // 檢查是否包含中文字符
                const hasChinese = /[\u4e00-\u9fa5]/.test(systemName);
                
                if (hasChinese) {
                    // 使用 canvas 同步渲染中文文字為圖片
                    try {
                        const textCanvas = document.createElement('canvas');
                        const ctx = textCanvas.getContext('2d');
                        
                        // 設置字體和樣式（使用支持中文的字體）
                        const fontSize = 8;
                        // 嘗試使用系統支持中文的字體
                        ctx.font = `${fontSize}px "Microsoft YaHei", "SimHei", "PingFang SC", "Hiragino Sans GB", "WenQuanYi Micro Hei", Arial, sans-serif`;
                        ctx.fillStyle = 'rgb(100, 100, 100)';
                        ctx.textBaseline = 'top';
                        
                        // 計算文字寬度（對於中文，measureText 可能不準確，使用更大的寬度）
                        let textWidth = 0;
                        for (let i = 0; i < systemName.length; i++) {
                            const char = systemName[i];
                            if (/[\u4e00-\u9fa5]/.test(char)) {
                                // 中文字符，大約是字體大小的 1.2 倍
                                textWidth += fontSize * 1.2;
                            } else {
                                textWidth += ctx.measureText(char).width;
                            }
                        }
                        
                        textCanvas.width = Math.ceil(textWidth) + 4;
                        textCanvas.height = fontSize + 4;
                        
                        // 重新設置字體（canvas 大小改變後需要重新設置）
                        ctx.font = `${fontSize}px "Microsoft YaHei", "SimHei", "PingFang SC", "Hiragino Sans GB", "WenQuanYi Micro Hei", Arial, sans-serif`;
                        ctx.fillStyle = 'rgb(100, 100, 100)';
                        ctx.textBaseline = 'top';
                        
                        // 繪製文字
                        ctx.fillText(systemName, 2, 2);
                        
                        // 轉換為圖片並添加到 PDF
                        const nameImgData = textCanvas.toDataURL('image/png');
                        const nameImgWidth = (textCanvas.width * 0.264583); // px to mm (96 DPI)
                        const nameImgHeight = (textCanvas.height * 0.264583);
                        pdf.addImage(nameImgData, 'PNG', margin, margin + 5, nameImgWidth, nameImgHeight);
                    } catch (e) {
                        console.warn('中文系統名稱渲染失敗:', e);
                        // 如果失敗，跳過（系統名稱已在報告內容中顯示）
                    }
                } else {
                    // 沒有中文，直接顯示
                    pdf.text(systemName, margin, margin + 10);
                }
            }
            
            // 右側：Smart Sequence Tech
            const headerText = 'Smart Sequence Tech';
            const headerTextWidth = pdf.getTextWidth(headerText);
            pdf.text(headerText, pageWidth - margin - headerTextWidth, margin + 10);
            
            // 頁尾
            pdf.setDrawColor(200, 200, 200);
            pdf.line(margin, pageHeight - margin - footerHeight, pageWidth - margin, pageHeight - margin - footerHeight);
            
            // 左側：頁碼（根據語言顯示）
            const currentLang = i18n.currentLang || 'zh-TW';
            const pageText = currentLang === 'zh-TW' 
                ? `第 ${pageNumber} 頁 / 共 ${totalPages} 頁`
                : `Page ${pageNumber} / ${totalPages}`;
            
            // 檢查是否包含中文，如果包含則使用 Canvas 渲染
            const hasChinese = /[\u4e00-\u9fa5]/.test(pageText);
            if (hasChinese) {
                try {
                    // 使用 Canvas 渲染中文頁碼
                    const textCanvas = document.createElement('canvas');
                    const ctx = textCanvas.getContext('2d');
                    if (!ctx) throw new Error('無法獲取 canvas context');
                    
                    const fontSize = 9;
                    ctx.font = `${fontSize}px "Microsoft YaHei", "SimHei", "PingFang SC", "Hiragino Sans GB", "WenQuanYi Micro Hei", Arial, sans-serif`;
                    ctx.fillStyle = 'rgb(100, 100, 100)';
                    ctx.textBaseline = 'top';
                    
                    // 計算文字寬度
                    let textWidth = 0;
                    for (let i = 0; i < pageText.length; i++) {
                        const char = pageText[i];
                        if (/[\u4e00-\u9fa5]/.test(char)) {
                            textWidth += fontSize * 1.2;
                        } else {
                            textWidth += ctx.measureText(char).width;
                        }
                    }
                    
                    textCanvas.width = Math.ceil(textWidth) + 4;
                    textCanvas.height = fontSize + 4;
                    
                    // 重新設置字體
                    ctx.font = `${fontSize}px "Microsoft YaHei", "SimHei", "PingFang SC", "Hiragino Sans GB", "WenQuanYi Micro Hei", Arial, sans-serif`;
                    ctx.fillStyle = 'rgb(100, 100, 100)';
                    ctx.textBaseline = 'top';
                    
                    // 繪製文字
                    ctx.fillText(pageText, 2, 2);
                    
                    // 轉換為圖片並添加到 PDF
                    const pageImgData = textCanvas.toDataURL('image/png');
                    const pageImgWidth = (textCanvas.width * 0.264583); // px to mm
                    const pageImgHeight = (textCanvas.height * 0.264583);
                    pdf.addImage(pageImgData, 'PNG', margin, pageHeight - margin - 5 - pageImgHeight, pageImgWidth, pageImgHeight);
                } catch (e) {
                    console.warn('中文頁碼渲染失敗，使用英文:', e);
                    // 如果失敗，使用英文
                    pdf.text(`Page ${pageNumber} / ${totalPages}`, margin, pageHeight - margin - 5);
                }
            } else {
                // 沒有中文，直接顯示
                pdf.text(pageText, margin, pageHeight - margin - 5);
            }
            
            // 右側：版權信息
            const footerText = '© Smart Sequence Tech';
            const footerTextWidth = pdf.getTextWidth(footerText);
            pdf.text(footerText, pageWidth - margin - footerTextWidth, pageHeight - margin - 5);
            
            // 恢復狀態
            pdf.restoreGraphicsState();
            
            // 檢查是否意外創建了新頁面
            const pagesAfter = pdf.internal.getNumberOfPages();
            if (pagesAfter > pagesBefore) {
                console.warn(`添加頁首頁尾後頁數增加 (${pagesAfter} > ${pagesBefore})，刪除多餘頁面`);
                for (let extraPage = pagesAfter; extraPage > pagesBefore; extraPage--) {
                    try {
                        pdf.deletePage(extraPage);
                        console.log(`已刪除意外創建的頁面 ${extraPage}`);
                    } catch (e) {
                        console.warn(`無法刪除意外創建的頁面 ${extraPage}:`, e);
                    }
                }
            }
            
            return headerHeight + footerHeight;
        }

        // 生成 PDF 分數表格行的輔助函數
        function generateScoreTableRows(m1, m2, m3, m4, m5) {
            const metrics = [
                { key: 'M1', value: m1, label: i18n.t('Report.RadarM1') },
                { key: 'M2', value: m2, label: i18n.t('Report.RadarM2') },
                { key: 'M3', value: m3, label: i18n.t('Report.RadarM3') },
                { key: 'M4', value: m4, label: i18n.t('Report.RadarM4') },
                { key: 'M5', value: m5, label: i18n.t('Report.RadarM5') }
            ];

            return metrics.map(metric => {
                const description = i18n.getScoreDescription(metric.key, metric.value);
                return `
                    <tr style="border-bottom: 1px solid #f0f0f0;">
                        <td style="padding: 8px 4px; color: #333;">${metric.label}</td>
                        <td style="padding: 8px 4px; text-align: center; color: #333; font-weight: 600;">${metric.value.toFixed(1)}</td>
                        <td style="padding: 8px 4px; color: #666; line-height: 1.4;">${description || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        // 創建 PDF 專用的內容結構
        async function createPdfContent() {
            const data = await parseSurveyData();
            if (!data) return null;

            // 專案資訊
            const projectName = (data && data.projectName) || '-';
            const systemName = (data && data.systemName) || '-';
            const systemCode = (data && data.systemCode) || '-';
            const evaluatorRole = (data && data.evaluatorRole) || '-';
            
            // 從 Session 獲取報告編號
            let reportId = '-';
            try {
                const reportIdResponse = await fetch('/Home/GetReportId');
                if (reportIdResponse.ok) {
                    const reportIdResult = await reportIdResponse.json();
                    if (reportIdResult.success && reportIdResult.reportId) {
                        reportId = reportIdResult.reportId;
                    }
                }
            } catch (error) {
                console.warn('獲取報告編號失敗:', error);
            }
            
            const timestamp = window.surveyTimestamp;
            const assessmentTime = formatTimestamp(timestamp) || '-';
            const m1 = toNumber(data.M1 || 0);
            const m2 = toNumber(data.M2 || 0);
            const m3 = toNumber(data.M3 || 0);
            const m4 = toNumber(data.M4 || 0);
            const m5 = toNumber(data.M5 || 0);
            const total = m1 + m2 + m3 + m4 + m5;
            const level = computeRiskLevel(total);
            const currentLang = i18n.currentLang || 'zh-TW';
            
            // 如果語言是英文，翻譯 M6-M8 內容
            let open1 = data.open1 || '';
            let open2 = data.open2 || '';
            let open3 = data.open3 || '';
            if (currentLang === 'en-US' && (open1 || open2 || open3)) {
                try {
                    const translateResponse = await fetch('/Home/TranslateOpenQuestions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            lang: currentLang,
                            open1: open1,
                            open2: open2,
                            open3: open3
                        })
                    });
                    
                    if (translateResponse.ok) {
                        const translateResult = await translateResponse.json();
                        if (translateResult.success) {
                            open1 = translateResult.open1 || open1;
                            open2 = translateResult.open2 || open2;
                            open3 = translateResult.open3 || open3;
                        }
                    }
                } catch (error) {
                    console.warn('PDF 翻譯開放式問題失敗，使用原始內容:', error);
                }
            }
            
            // 風險等級翻譯
            const levelMap = {
                'zh-TW': { '低': '低', '中': '中', '高': '高' },
                'en-US': { '低': 'Low', '中': 'Medium', '高': 'High' }
            };
            const riskLevelText = levelMap[currentLang]?.[level] || level;
            
            // 獲取 AI 生成的風險改善建議
            // 優先使用頁面上已顯示的建議內容，確保 PDF 和頁面一致
            let adviceText = i18n.t('Report.DefaultAdvice');
            try {
                // 先檢查頁面上是否已有 AI 生成的建議內容
                const pageAdviceEl = document.getElementById('adviceText');
                if (pageAdviceEl && pageAdviceEl.textContent && 
                    !pageAdviceEl.textContent.includes('將根據您的問卷結果') &&
                    !pageAdviceEl.textContent.includes('will be generated') &&
                    !pageAdviceEl.textContent.includes('分析中') &&
                    !pageAdviceEl.textContent.includes('Analyzing')) {
                    // 使用頁面上的內容
                    adviceText = pageAdviceEl.textContent.trim();
                } else {
                    // 如果頁面沒有內容，則重新調用 API
                    const adviceData = {
                        lang: currentLang,
                        m1: String(m1),
                        m2: String(m2),
                        m3: String(m3),
                        m4: String(m4),
                        m5: String(m5)
                    };
                    
                    const adviceResponse = await fetch('/Home/GeneratePersonalizedAdvice', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(adviceData)
                    });
                    
                    if (adviceResponse.ok) {
                        const adviceResult = await adviceResponse.json();
                        if (adviceResult.advice) {
                            adviceText = adviceResult.advice;
                        }
                    }
                }
            } catch (error) {
                // 移除 console.error（安全考量）
                // 如果失敗，使用預設建議
                if (m3 <= 6) {
                    adviceText = i18n.t('Report.AdviceLow');
                } else {
                    adviceText = i18n.t('Report.AdviceNormal');
                }
            }

            // 獲取 30 天行動清單
            // 優先使用頁面上已顯示的行動清單內容，確保 PDF 和頁面一致
            let actionPlanContent = '';
            const shouldShowPlan = shouldShowActionPlan(m1, m2, m3, m4, m5, total);
            if (shouldShowPlan) {
                try {
                    // 先檢查頁面上是否已有行動清單內容
                    const pageActionPlanEl = document.getElementById('actionPlanContent');
                    if (pageActionPlanEl && pageActionPlanEl.innerHTML && 
                        !pageActionPlanEl.textContent.includes('生成中') &&
                        !pageActionPlanEl.textContent.includes('Generating') &&
                        !pageActionPlanEl.textContent.includes('無法生成') &&
                        !pageActionPlanEl.textContent.includes('Unable to')) {
                        // 使用頁面上的內容
                        actionPlanContent = formatActionPlanForPDFFromHTML(pageActionPlanEl.innerHTML, currentLang);
                    } else {
                        // 如果頁面沒有內容，則重新調用 API
                        const selectedM = selectHighestRiskM(m1, m2, m3, m4, m5);
                        const basicDeliverable = getBasicDeliverable(selectedM.key);
                        
                        if (basicDeliverable) {
                            const actionPlanData = {
                                lang: currentLang,
                                mKey: selectedM.key,
                                mValue: String(selectedM.value),
                                mName: selectedM.name,
                                basicDeliverable: basicDeliverable,
                                allDeliverables: JSON.stringify(getDeliverablesMap()[selectedM.key] || [])
                            };
                            
                            const actionPlanResponse = await fetch('/Home/GenerateActionPlan', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify(actionPlanData)
                            });
                            
                            if (actionPlanResponse.ok) {
                                const actionPlanResult = await actionPlanResponse.json();
                                if (actionPlanResult.success && actionPlanResult.actionPlan) {
                                    actionPlanContent = formatActionPlanForPDF(actionPlanResult.actionPlan, currentLang);
                                }
                            }
                        }
                    }
                } catch (error) {
                    // 移除 console.error（安全考量）
                }
            } else {
                // 風險可控說明
                const controlledText = currentLang === 'zh-TW'
                    ? '根據本次評估結果，您的專案風險處於可控範圍內。建議持續關注各項指標的變化，並定期進行複評以確保風險管理機制有效運作。'
                    : 'Based on this assessment, your project risks are within a controllable range. It is recommended to continue monitoring changes in each indicator and conduct regular reviews to ensure risk management mechanisms are operating effectively.';
                actionPlanContent = `<p style="margin: 0; font-size: 12px; line-height: 1.6; color: #666; padding: 12px; background: rgba(56, 142, 60, 0.1); border-radius: 4px; border-left: 3px solid #388e3c;">${controlledText}</p>`;
            }
            
            // 確保 actionPlanContent 有內容（即使失敗也要顯示區塊）
            if (!actionPlanContent) {
                const errorText = currentLang === 'zh-TW'
                    ? '行動清單生成中...'
                    : 'Generating action plan...';
                actionPlanContent = `<p style="margin: 0; font-size: 12px; line-height: 1.6; color: #666;">${errorText}</p>`;
            }

            // 創建 PDF 專用容器（使用 A4 尺寸優化）
            const pdfContainer = document.createElement('div');
            pdfContainer.id = 'pdfContentContainer';
            pdfContainer.className = 'pdf-content-container';
            pdfContainer.style.cssText = `
                position: absolute;
                left: -9999px;
                top: 0;
                width: 180mm; /* 稍微小於 A4 寬度，留出邊距 */
                background: #ffffff;
                padding: 12mm;
                box-sizing: border-box;
                font-family: Arial, "Microsoft YaHei", "SimHei", sans-serif;
                font-size: 12px;
                line-height: 1.5;
            `;

            // 專案資訊和標題
            pdfContainer.innerHTML = `
                <!-- 專案資訊和標題 -->
                <div class="pdf-header" style="margin-bottom: 12px; padding-bottom: 8px; border-bottom: 1px solid #ddd;">
                    <h1 style="margin: 0 0 4px 0; font-size: 18px; color: #333; font-weight: 600;">${systemName || 'DocEngine'}</h1>
                    <h2 style="margin: 0; font-size: 14px; color: #666; font-weight: 500;">${i18n.t('Report.Title')}</h2>
                </div>

                <!-- 報告信息（緊湊） -->
                <div style="margin-bottom: 12px; padding: 8px; background: #f5f5f5; border-radius: 4px; font-size: 9px; color: #555; line-height: 1.4;">
                    <div style="margin-bottom: 3px;">
                        <strong>${i18n.t('Report.ProjectName')}:</strong> ${projectName}
                    </div>
                    <div style="margin-bottom: 3px;">
                        <strong>${i18n.t('Report.SystemName')}:</strong> ${systemName}
                    </div>
                    <div style="margin-bottom: 3px;">
                        <strong>${i18n.t('Report.SystemCode')}:</strong> ${systemCode}
                    </div>
                    <div style="margin-bottom: 3px;">
                        <strong>${i18n.t('Report.EvaluatorRole')}:</strong> ${evaluatorRole}
                    </div>
                    <div style="margin-bottom: 3px;">
                        <strong>${i18n.t('Report.ReportId')}:</strong> ${reportId}
                    </div>
                    <div style="margin-bottom: 3px;">
                        <strong>${i18n.t('Report.AssessmentTime')}:</strong> ${assessmentTime}
                    </div>
                </div>

                <!-- 雷達圖與風險分數區塊（並排） -->
                <div class="pdf-block" data-block="radar" style="margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 6px; page-break-inside: avoid;">
                    <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #333; font-weight: 600;">${i18n.t('Report.RadarTitle')}</h3>
                    <p style="margin: 0 0 8px 0; font-size: 10px; color: #666;">${i18n.t('Report.RadarDesc')}</p>
                    <p style="margin: 0 0 12px 0; font-size: 9px; color: #777; line-height: 1.4;">
                        <strong>${i18n.t('Assessment.MaturityLabel')}</strong>${i18n.t('Assessment.MaturityDesc')}
                    </p>
                    <div style="display: flex; gap: 16px; align-items: flex-start;">
                        <!-- 雷達圖（左側） -->
                        <div style="flex: 1; text-align: center;">
                            <svg id="pdfRadarChart" viewBox="-20 -20 240 240" style="max-width: 200px; height: auto;">
                                <!-- Background circles -->
                                <circle cx="100" cy="100" r="80" fill="none" stroke="#ddd" stroke-width="1"/>
                                <circle cx="100" cy="100" r="60" fill="none" stroke="#ddd" stroke-width="1"/>
                                <circle cx="100" cy="100" r="40" fill="none" stroke="#ddd" stroke-width="1"/>
                                <circle cx="100" cy="100" r="20" fill="none" stroke="#ddd" stroke-width="1"/>
                                <!-- Axes -->
                                <line x1="100" y1="100" x2="100" y2="20" stroke="#ccc" stroke-width="1"/>
                                <line x1="100" y1="100" x2="167" y2="70" stroke="#ccc" stroke-width="1"/>
                                <line x1="100" y1="100" x2="147" y2="160" stroke="#ccc" stroke-width="1"/>
                                <line x1="100" y1="100" x2="53" y2="160" stroke="#ccc" stroke-width="1"/>
                                <line x1="100" y1="100" x2="33" y2="70" stroke="#ccc" stroke-width="1"/>
                                <!-- Data polygon -->
                                <polygon id="pdfRadarPolygon" fill="rgba(98, 0, 234, 0.3)" stroke="#6200ea" stroke-width="2"/>
                                <!-- Labels -->
                                <text x="100" y="15" text-anchor="middle" font-size="12" fill="#333">${i18n.t('Report.RadarM1')}</text>
                                <text x="180" y="75" text-anchor="middle" font-size="12" fill="#333">${i18n.t('Report.RadarM2')}</text>
                                <text x="165" y="170" text-anchor="middle" font-size="12" fill="#333">${i18n.t('Report.RadarM3')}</text>
                                <text x="35" y="170" text-anchor="middle" font-size="12" fill="#333">${i18n.t('Report.RadarM4')}</text>
                                <text x="20" y="75" text-anchor="middle" font-size="12" fill="#333">${i18n.t('Report.RadarM5')}</text>
                            </svg>
                        </div>
                        <!-- 風險分數（右側，直式排列） -->
                        <div style="flex: 0 0 140px; padding: 12px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                            <h4 style="margin: 0 0 12px 0; font-size: 12px; font-weight: 600; color: #333; text-align: center; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0;">${i18n.t('Report.FingerprintTitle')}</h4>
                            <div style="display: flex; flex-direction: column; gap: 12px;">
                                <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                    <div style="font-size: 9px; color: #666; margin-bottom: 4px; text-align: left;">${i18n.t('Report.TotalScore')}</div>
                                    <div style="font-size: 18px; font-weight: 600; color: #333; text-align: left;">${total.toFixed(1)}</div>
                                </div>
                                <div style="padding: 8px 0; border-bottom: 1px solid #f0f0f0;">
                                    <div style="font-size: 9px; color: #666; margin-bottom: 4px; text-align: left;">${i18n.t('Report.RiskLevel')}</div>
                                    <div style="font-size: 14px; font-weight: 600; color: ${level === '高' ? '#d32f2f' : level === '中' ? '#f57c00' : '#388e3c'}; text-align: left;">
                                        ${riskLevelText}
                                    </div>
                                    <div style="font-size: 9px; color: #666; margin-top: 4px; text-align: left; line-height: 1.3;">
                                        ${currentLang === 'zh-TW' 
                                            ? (level === '高' ? '建議於 1–2 個月內啟動改善' : level === '中' ? '建議納入季度檢視' : '建議半年複查')
                                            : (level === '高' ? 'Recommend initiating improvements within 1–2 months' : level === '中' ? 'Recommend quarterly review' : 'Recommend semi-annual review')}
                                    </div>
                                    <div style="font-size: 8px; color: #999; margin-top: 4px; text-align: left; line-height: 1.2;">
                                        ${currentLang === 'zh-TW' ? '0–20 高、21–35 中、36–50 低' : '0–20 High, 21–35 Medium, 36–50 Low'}
                                    </div>
                                </div>
                                <div style="padding: 8px 0;">
                                    <div style="font-size: 9px; color: #666; margin-bottom: 4px; text-align: left;">${i18n.t('Report.SampleTime')}</div>
                                    <div style="font-size: 9px; color: #333; line-height: 1.3; text-align: left;">${formatTimestamp(timestamp)}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- 分數說明表（放在下方） -->
                    <div style="margin-top: 16px; padding: 12px; background: white; border-radius: 4px; border: 1px solid #e0e0e0;">
                        <h4 style="margin: 0 0 8px 0; font-size: 12px; font-weight: 600; color: #333;">${i18n.t('Score.TableTitle')}</h4>
                        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
                            <thead>
                                <tr style="border-bottom: 1px solid #ddd; background: #f5f5f5;">
                                    <th style="padding: 6px 4px; text-align: left; font-weight: 600; color: #555;">${i18n.t('Score.Indicator')}</th>
                                    <th style="padding: 6px 4px; text-align: center; font-weight: 600; color: #555; width: 50px;">${i18n.t('Score.Value')}</th>
                                    <th style="padding: 6px 4px; text-align: left; font-weight: 600; color: #555;">${i18n.t('Score.Description')}</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${generateScoreTableRows(m1, m2, m3, m4, m5)}
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- 風險改善建議區塊 -->
                <div class="pdf-block" data-block="advice" style="margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 6px; page-break-inside: avoid;">
                    <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #333; font-weight: 600;">${i18n.t('Report.ImprovementAdvice')}</h3>
                    <div style="margin: 0 0 20px 0; font-size: 12px; line-height: 1.6; color: #444;">${formatAdviceText(adviceText)}</div>
                    
                    ${(() => {
                        const deliverablesContent = generateDeliverablesHTML(m1, m2, m3, m4, m5);
                        if (deliverablesContent) {
                            return `
                                <div style="margin-top: 20px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                                    <h4 style="margin: 0 0 8px 0; font-size: 13px; font-weight: 600; color: #333;">${currentLang === 'zh-TW' ? '本次評估建議之最小交付物：' : 'Recommended Minimum Deliverables for This Assessment:'}</h4>
                                    <p style="margin: 0 0 12px 0; font-size: 11px; color: #666; line-height: 1.5;">${deliverablesContent.intro}</p>
                                    <div style="font-size: 11px; color: #555; line-height: 1.8;">${deliverablesContent.list}</div>
                                </div>
                            `;
                        }
                        return '';
                    })()}
                </div>

                <!-- 補充說明區塊（調整順序，放在風險洞察之前） -->
                ${open1 || open2 || open3 ? `
                <div class="pdf-block" data-block="open-questions" style="margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 6px; page-break-inside: avoid;">
                    <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #333; font-weight: 600;">${i18n.t('Report.OpenQuestions')}</h3>
                    <p style="margin: 0 0 12px 0; font-size: 10px; color: #666;">${i18n.t('Report.OpenQuestionsDesc')}</p>
                    ${open1 ? `<div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 4px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 12px; font-weight: 600; color: #333;">${i18n.t('Assessment.OpenQ6')}</h4>
                        <p style="margin: 0; font-size: 11px; line-height: 1.4; color: #555; white-space: pre-wrap;">${open1}</p>
                    </div>` : ''}
                    ${open2 ? `<div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 4px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 12px; font-weight: 600; color: #333;">${i18n.t('Assessment.OpenQ7')}</h4>
                        <p style="margin: 0; font-size: 11px; line-height: 1.4; color: #555; white-space: pre-wrap;">${open2}</p>
                    </div>` : ''}
                    ${open3 ? `<div style="margin-bottom: 12px; padding: 10px; background: white; border-radius: 4px;">
                        <h4 style="margin: 0 0 6px 0; font-size: 12px; font-weight: 600; color: #333;">${i18n.t('Assessment.OpenQ8')}</h4>
                        <p style="margin: 0; font-size: 11px; line-height: 1.4; color: #555; white-space: pre-wrap;">${open3}</p>
                    </div>` : ''}
                </div>
                ` : ''}

                <!-- 風險洞察區塊（調整順序，放在補充說明之後） -->
                ${(open1 || open2 || open3) ? `
                <div class="pdf-block" data-block="ai-insights" style="margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 6px; page-break-inside: avoid;">
                    <h3 style="margin: 0 0 8px 0; font-size: 15px; color: #333; font-weight: 600;">${i18n.t('Report.AIInsights')}</h3>
                    <p style="margin: 0 0 12px 0; font-size: 10px; color: #666;">${i18n.t('Report.AIInsightsDesc')}</p>
                    <div id="pdf-ai-insights" style="padding: 10px; background: white; border-radius: 4px; font-size: 11px; line-height: 1.5; color: #555;">
                        <!-- AI 洞察內容將在這裡動態插入 -->
                    </div>
                </div>
                ` : ''}

                <!-- 30 天行動清單區塊 -->
                ${actionPlanContent ? `
                <div class="pdf-block" data-block="action-plan" style="margin-top: 24px; margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 6px; page-break-inside: avoid;">
                    <h3 style="margin: 0 0 12px 0; font-size: 15px; color: #333; font-weight: 600;">${i18n.t('Report.ActionPlanTitle')}</h3>
                    <div style="font-size: 12px; line-height: 1.6; color: #555;">
                        ${actionPlanContent}
                    </div>
                </div>
                ` : ''}

                <!-- 免責聲明區塊 -->
                <div class="pdf-block" data-block="disclaimer" style="margin-top: 24px; margin-bottom: 16px; padding: 14px; background: #f8f8f8; border-radius: 6px; border-left: 3px solid #6200ea; page-break-inside: avoid;">
                    <div style="font-size: 10px; line-height: 1.8; color: #555;">
                        ${currentLang === 'zh-TW' 
                            ? `本報告依使用者自填資料產出<br/><br/>
本報告適用於：<br/>
‧ 軟體專案風險盤點<br/>
‧ 系統交接與治理檢視<br/>
不取代：<br/>
‧ 稽核<br/>
‧ 法規認證<br/>
‧ 程式碼安全掃描`
                            : `This report is generated based on user-provided data.<br/><br/>
This report is applicable for:<br/>
‧ Software project risk assessment<br/>
‧ System handover and governance review<br/>
Does not replace:<br/>
‧ Audit<br/>
‧ Regulatory certification<br/>
‧ Code security scanning`}
                    </div>
                </div>
            `;

            // 更新雷達圖
            const pdfRadarPolygon = pdfContainer.querySelector('#pdfRadarPolygon');
            if (pdfRadarPolygon) {
                const centerX = 100;
                const centerY = 100;
                const maxRadius = 80;
                const values = [m1, m2, m3, m4, m5];
                const angles = [-90, -18, 54, 126, 198].map(deg => (deg * Math.PI) / 180);
                const points = values.map((v, i) => {
                    const ratio = Math.max(0, Math.min(10, v)) / 10;
                    const r = maxRadius * ratio;
                    const x = centerX + r * Math.cos(angles[i]);
                    const y = centerY + r * Math.sin(angles[i]);
                    return `${x},${y}`;
                });
                pdfRadarPolygon.setAttribute('points', points.join(' '));
            }

            // 獲取並填充 AI 洞察內容（如果有補充說明）
            // 優先使用頁面上已顯示的 AI 洞察內容，確保 PDF 和頁面一致
            const pdfAiInsights = pdfContainer.querySelector('#pdf-ai-insights');
            if (pdfAiInsights && (open1 || open2 || open3)) {
                try {
                    // 先檢查頁面上是否已有 AI 洞察內容
                    const pageInsightsEl = document.getElementById('insights-loading');
                    let aiContent = null;
                    
                    if (pageInsightsEl && pageInsightsEl.innerHTML && 
                        !pageInsightsEl.textContent.includes('分析中') && 
                        !pageInsightsEl.textContent.includes('Analyzing') &&
                        !pageInsightsEl.textContent.includes('無法生成') &&
                        !pageInsightsEl.textContent.includes('Unable to') &&
                        !pageInsightsEl.textContent.includes('載入失敗') &&
                        !pageInsightsEl.textContent.includes('Failed to')) {
                        // 使用頁面上的內容（去除 HTML 標籤後重新格式化）
                        aiContent = pageInsightsEl.innerHTML;
                        // 移除 console.log（安全考量）
                    }
                    
                    if (aiContent) {
                        // 直接使用頁面的內容
                        pdfAiInsights.innerHTML = aiContent;
                    } else {
                        // 如果頁面沒有內容，則重新調用 API
                        const m6 = open1 || '';
                        const m7 = open2 || '';
                        const m8 = open3 || '';
                        
                        const m678Data = {
                            lang: currentLang,
                            m1: String(m1),
                            m2: String(m2),
                            m3: String(m3),
                            m4: String(m4),
                            m5: String(m5),
                            m6: m6,
                            m7: m7,
                            m8: m8
                        };
                        
                        const aiResponse = await fetch('/Home/GenerateInsights', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(m678Data)
                        });
                        
                        if (aiResponse.ok) {
                            const aiData = await aiResponse.json();
                            if (aiData.insights) {
                                pdfAiInsights.innerHTML = aiData.insights.replace(/\n/g, '<br>');
                            } else {
                                pdfAiInsights.textContent = currentLang === 'zh-TW' 
                                    ? '無法生成 AI 洞察' 
                                    : 'Unable to generate AI insights';
                            }
                        } else {
                            pdfAiInsights.textContent = currentLang === 'zh-TW' 
                                ? 'AI 洞察載入失敗' 
                                : 'Failed to load AI insights';
                        }
                    }
                } catch (error) {
                    console.error('PDF AI 洞察載入錯誤:', error);
                    if (pdfAiInsights) {
                        pdfAiInsights.textContent = currentLang === 'zh-TW' 
                            ? 'AI 洞察載入失敗' 
                            : 'Failed to load AI insights';
                    }
                }
            }

            // 添加到 body（但隱藏）
            document.body.appendChild(pdfContainer);

            return pdfContainer;
        }

        async function downloadPdf() {
            try {
                // 獲取系統名稱用於文件名和頁首
                const data = await parseSurveyData();
                const systemName = (data && data.systemName) || 'DocEngine';
                const safeFileName = systemName.replace(/[^a-zA-Z0-9\u4e00-\u9fa5]/g, '_');
                const fileName = `${safeFileName}-Risk-Report.pdf`;

                // 顯示載入提示（根據語言顯示）
                const btn = document.getElementById('downloadPdfBtn');
                const originalText = btn.textContent;
                btn.disabled = true;
                const currentLang = i18n.currentLang || 'zh-TW';
                btn.textContent = currentLang === 'zh-TW' ? '生成中...' : 'Generating...';

                // 創建 PDF 專用內容
                const pdfContainer = await createPdfContent();
                if (!pdfContainer) {
                    throw new Error(currentLang === 'zh-TW' ? '無法讀取問卷資料' : 'Unable to read survey data');
                }

                // 等待布局穩定
                await new Promise(resolve => setTimeout(resolve, 300));

                // 檢測所有區塊邊界（使用 data-block 標記）
                const containerRect = pdfContainer.getBoundingClientRect();
                const allBlocks = Array.from(pdfContainer.querySelectorAll('[data-block]')).filter(el => {
                    // 只包含可見的元素
                    const rect = el.getBoundingClientRect();
                    return rect.height > 0 && rect.width > 0;
                });
                
                // 計算每個區塊在容器中的位置（相對於 pdfContainer）
                const blockBoundaries = allBlocks.map(el => {
                    const rect = el.getBoundingClientRect();
                    const relativeTop = rect.top - containerRect.top;
                    const relativeBottom = rect.bottom - containerRect.top;
                    const blockId = el.getAttribute('data-block');
                    
                    // 設置優先級：fingerprint 和 advice 最高，其他次之
                    let priority = 2;
                    if (blockId === 'fingerprint' || blockId === 'advice') {
                        priority = 1;
                    }
                    
                    return {
                        top: relativeTop,
                        bottom: relativeBottom,
                        height: rect.height,
                        element: el,
                        blockId: blockId,
                        priority: priority
                    };
                }).sort((a, b) => a.top - b.top); // 按位置排序
                
                console.log('檢測到的區塊邊界:', blockBoundaries.map(b => ({
                    block: b.blockId,
                    top: b.top,
                    bottom: b.bottom,
                    height: b.height
                })));

                // 使用 html2canvas 生成圖片（PDF 專用容器）
                let canvas;
                try {
                    canvas = await html2canvas(pdfContainer, {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: '#ffffff',
                        logging: false,
                        allowTaint: false,
                        width: pdfContainer.scrollWidth,
                        height: pdfContainer.scrollHeight
                    });
                } catch (canvasError) {
                    console.error('Canvas generation error:', canvasError);
                    // 清理 PDF 容器
                    if (pdfContainer && pdfContainer.parentNode) {
                        pdfContainer.parentNode.removeChild(pdfContainer);
                    }
                    throw new Error('無法生成報告圖片，請稍後再試');
                }

                // 驗證 canvas 是否有效
                if (!canvas || canvas.width === 0 || canvas.height === 0) {
                    // 清理 PDF 容器
                    if (pdfContainer && pdfContainer.parentNode) {
                        pdfContainer.parentNode.removeChild(pdfContainer);
                    }
                    throw new Error('生成的圖片無效，請稍後再試');
                }

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('p', 'mm', 'a4');

                const pageWidth = pdf.internal.pageSize.getWidth();
                const pageHeight = pdf.internal.pageSize.getHeight();
                const margin = 10;
                const headerFooterHeight = 30; // 頁首頁尾總高度

                const imgWidth = pageWidth - (margin * 2);
                const availableHeight = pageHeight - (margin * 2) - headerFooterHeight;
                const imgHeight = (canvas.height * imgWidth) / canvas.width;

                // 添加內容，每頁都有頁首頁尾
                let yOffset = 0;
                let actualPageNumber = 0;
                
                // 先計算實際需要的頁數（考慮分頁調整）
                let estimatedPageCount = Math.ceil(imgHeight / availableHeight);
                
                while (yOffset < imgHeight) {
                    // 在創建頁面前先檢查是否真的還有內容
                    if (yOffset >= imgHeight) {
                        break;
                    }
                    
                    actualPageNumber++;
                    
                    if (actualPageNumber > 1) {
                        pdf.addPage();
                    }

                    // 注意：先不添加頁首頁尾，等內容確定後再添加，避免空頁

                    // 計算當前頁要顯示的圖片部分
                    const scaleFactor = imgHeight / pdfContainer.scrollHeight;
                    
                    // 計算默認頁高
                    let pageImgHeight = Math.min(imgHeight - yOffset, availableHeight);
                    
                    // 如果剩餘內容不足，不要創建新頁
                    if (pageImgHeight < 5) {
                        // 刪除剛創建的頁面
                        if (actualPageNumber > 1) {
                            try {
                                pdf.deletePage(actualPageNumber);
                            } catch (e) {
                                console.warn('無法刪除空頁:', e);
                            }
                        }
                        actualPageNumber--;
                        break;
                    }
                    
                    const sourceY = (yOffset / imgHeight) * canvas.height;
                    const currentPageEnd = yOffset + pageImgHeight;
                    
                    // 找到當前 yOffset 對應的區塊（如果有的話）
                    let currentBlock = null;
                    for (const block of blockBoundaries) {
                        const blockTop = block.top * scaleFactor;
                        const blockBottom = block.bottom * scaleFactor;
                        if (yOffset >= blockTop && yOffset < blockBottom) {
                            currentBlock = block;
                            break;
                        }
                    }
                    
                    // 如果當前在一個區塊內，必須完整顯示這個區塊
                    if (currentBlock) {
                        const blockTop = currentBlock.top * scaleFactor;
                        const blockBottom = currentBlock.bottom * scaleFactor;
                        const remainingInBlock = blockBottom - yOffset;
                        
                        if (remainingInBlock <= availableHeight) {
                            // 可以完整放在一頁，顯示完整
                            pageImgHeight = remainingInBlock;
                            console.log(`頁面 ${actualPageNumber}: 區塊 ${currentBlock.blockId} 在當前頁開始，完整顯示到結束 (${remainingInBlock.toFixed(1)}mm)`);
                        } else {
                            // 區塊太大無法放在一頁
                            // 優先選擇：如果當前頁是這個區塊的第一頁，嘗試顯示一頁
                            // 否則：強制限制在 availableHeight 內
                            const isFirstPageOfBlock = Math.abs(yOffset - blockTop) < 5; // 5mm 容差
                            
                            if (isFirstPageOfBlock) {
                                // 這是區塊的第一頁，顯示一頁內容
                                pageImgHeight = availableHeight;
                                console.log(`頁面 ${actualPageNumber}: 區塊 ${currentBlock.blockId} 太大，第一頁顯示 ${availableHeight.toFixed(1)}mm (剩餘 ${remainingInBlock.toFixed(1)}mm)，下一頁繼續`);
                            } else {
                                // 不是第一頁，顯示剩餘內容（但限制在可用高度內）
                                pageImgHeight = Math.min(remainingInBlock, availableHeight);
                                console.log(`頁面 ${actualPageNumber}: 區塊 ${currentBlock.blockId} 繼續顯示，剩餘 ${remainingInBlock.toFixed(1)}mm，當前頁顯示 ${pageImgHeight.toFixed(1)}mm`);
                            }
                        }
                    } else {
                        // 當前不在任何區塊內，檢查是否會切到下一個區塊
                        // 按優先級排序檢查（高優先級先檢查）
                        const sortedBlocks = [...blockBoundaries].sort((a, b) => a.priority - b.priority);
                        
                        for (const block of sortedBlocks) {
                            const blockTop = block.top * scaleFactor;
                            const blockBottom = block.bottom * scaleFactor;
                            
                            // 如果當前頁結束位置會切到區塊中間，提前結束當前頁
                            if (yOffset < blockTop && currentPageEnd > blockTop && currentPageEnd < blockBottom) {
                                // 強制結束當前頁，讓區塊從新頁開始
                                const distanceToBlock = blockTop - yOffset;
                                
                                // 確保至少有一點內容（至少 10mm），否則直接跳過到區塊開始
                                if (distanceToBlock >= 10) {
                                    pageImgHeight = blockTop - yOffset;
                                    console.log(`頁面 ${actualPageNumber}: 會切到區塊 ${block.blockId} 中間，提前結束到區塊開始處 (${distanceToBlock.toFixed(1)}mm)`);
                                    break; // 找到會切到的區塊，停止檢查
                                } else {
                                    // 距離太短，直接跳到區塊開始處
                                    pageImgHeight = Math.max(distanceToBlock, 5); // 至少 5mm
                                    console.log(`頁面 ${actualPageNumber}: 距離區塊 ${block.blockId} 太短，顯示到區塊開始處 (${pageImgHeight.toFixed(1)}mm)`);
                                    break;
                                }
                            }
                        }
                    }
                    
                    // 確保 pageImgHeight 在合理範圍內（這很重要！）
                    const maxAllowedHeight = Math.min(availableHeight, imgHeight - yOffset);
                    pageImgHeight = Math.min(pageImgHeight, maxAllowedHeight);
                    pageImgHeight = Math.max(pageImgHeight, 0);
                    
                    // 如果頁高為 0 或太小，使用最小高度
                    if (pageImgHeight <= 0) {
                        pageImgHeight = Math.min(availableHeight * 0.1, imgHeight - yOffset, 20); // 至少顯示10%或20mm或剩餘內容
                    }
                    
                    // 最終驗證：如果仍然太小或沒有內容，跳過這一頁
                    if (pageImgHeight < 5 || yOffset >= imgHeight) {
                        console.log(`頁面 ${actualPageNumber}: 內容不足，跳過這一頁 (pageImgHeight=${pageImgHeight.toFixed(1)}mm, yOffset=${yOffset.toFixed(1)}mm)`);
                        // 刪除剛添加的空頁
                        if (actualPageNumber > 1) {
                            try {
                                pdf.deletePage(actualPageNumber);
                            } catch (e) {
                                console.warn('無法刪除空頁:', e);
                            }
                        }
                        // 減少頁數計數，因為頁面已被刪除
                        actualPageNumber--;
                        break;
                    }
                    
                    let sourceHeight = (pageImgHeight / imgHeight) * canvas.height;
                    let finalSourceY = sourceY;

                    // 確保 sourceHeight 有效
                    if (sourceHeight <= 0 || sourceHeight > canvas.height || sourceY < 0 || sourceY >= canvas.height) {
                        console.warn(`Invalid source dimensions: sourceY=${sourceY}, sourceHeight=${sourceHeight}, canvas.height=${canvas.height}`);
                        // 調整為有效值
                        finalSourceY = Math.max(0, Math.min(sourceY, canvas.height - 1));
                        sourceHeight = Math.min(sourceHeight, canvas.height - finalSourceY);
                        if (sourceHeight <= 0) {
                            // 刪除剛創建的頁面
                            if (actualPageNumber > 1) {
                                try {
                                    pdf.deletePage(actualPageNumber);
                                    actualPageNumber--;
                                } catch (e) {
                                    console.warn('無法刪除無效頁:', e);
                                }
                            }
                            break;
                        }
                        // 重新計算 pageImgHeight
                        pageImgHeight = (sourceHeight / canvas.height) * imgHeight;
                    }

                    // 創建當前頁的圖片
                    const tempCanvas = document.createElement('canvas');
                    tempCanvas.width = canvas.width;
                    tempCanvas.height = Math.max(Math.floor(sourceHeight), 1); // 確保至少為1
                    
                    const tempCtx = tempCanvas.getContext('2d');
                    if (!tempCtx) {
                        console.error('無法獲取 canvas context');
                        // 刪除剛創建的頁面
                        if (actualPageNumber > 1) {
                            try {
                                pdf.deletePage(actualPageNumber);
                                actualPageNumber--;
                            } catch (e) {
                                console.warn('無法刪除無context頁:', e);
                            }
                        }
                        break;
                    }
                    
                    try {
                        // 繪製圖片片段
                        tempCtx.drawImage(
                            canvas, 
                            0, finalSourceY, canvas.width, sourceHeight,  // 源圖片區域
                            0, 0, canvas.width, sourceHeight              // 目標canvas區域
                        );
                        
                        // 轉換為圖片數據，添加錯誤處理
                        let pageImgData;
                        try {
                            pageImgData = tempCanvas.toDataURL('image/png', 1.0);
                            if (!pageImgData || pageImgData === 'data:,') {
                                console.error('圖片數據轉換失敗');
                                // 刪除剛創建的頁面
                                if (actualPageNumber > 1) {
                                    try {
                                        pdf.deletePage(actualPageNumber);
                                        actualPageNumber--;
                                    } catch (e) {
                                        console.warn('無法刪除失敗頁:', e);
                                    }
                                }
                                break;
                            }
                        } catch (imgError) {
                            console.error('圖片數據轉換錯誤:', imgError);
                            // 刪除剛創建的頁面
                            if (actualPageNumber > 1) {
                                try {
                                    pdf.deletePage(actualPageNumber);
                                    actualPageNumber--;
                                } catch (e) {
                                    console.warn('無法刪除錯誤頁:', e);
                                }
                            }
                            break;
                        }
                        
                        const actualPageImgHeight = (tempCanvas.height * imgWidth) / tempCanvas.width;

                        // 添加內容圖片（在頁首下方）
                        const contentY = margin + 15; // 頁首下方
                        try {
                            pdf.addImage(pageImgData, 'PNG', margin, contentY, imgWidth, actualPageImgHeight, undefined, 'FAST');
                            // 先不添加頁首頁尾，等所有頁面完成後統一添加，避免創建多餘頁面
                        } catch (pdfImgError) {
                            console.error('添加圖片到PDF失敗:', pdfImgError);
                            try {
                                // 嘗試使用 SLOW 模式
                                pdf.addImage(pageImgData, 'PNG', margin, contentY, imgWidth, actualPageImgHeight, undefined, 'SLOW');
                                // 先不添加頁首頁尾，等所有頁面完成後統一添加
                            } catch (slowError) {
                                console.error('使用 SLOW 模式也失敗:', slowError);
                                throw new Error('無法將圖片添加到PDF: ' + slowError.message);
                            }
                        }
                    } catch (drawError) {
                        console.error('繪製圖片片段失敗:', drawError);
                        throw new Error('生成PDF圖片失敗: ' + drawError.message);
                    }

                    yOffset += pageImgHeight;
                    
                    // 檢查是否還有內容
                    if (yOffset >= imgHeight) {
                        break;
                    }
                }
                
                // 獲取實際頁數（可能因為刪除空頁而減少）
                let totalPages = pdf.internal.getNumberOfPages();
                
                // 檢查並清理多餘的空頁
                // 如果 actualPageNumber 和 totalPages 不一致，刪除多餘的頁面
                console.log(`分頁完成: actualPageNumber=${actualPageNumber}, totalPages=${totalPages}, yOffset=${yOffset.toFixed(1)}, imgHeight=${imgHeight.toFixed(1)}`);
                
                if (totalPages > actualPageNumber) {
                    console.log(`發現多餘頁面: 實際頁數 ${totalPages} > 計數頁數 ${actualPageNumber}，將刪除多餘頁面`);
                    for (let pageNum = totalPages; pageNum > actualPageNumber; pageNum--) {
                        try {
                            pdf.deletePage(pageNum);
                            console.log(`已刪除頁面 ${pageNum}`);
                        } catch (e) {
                            console.warn(`無法刪除多餘頁面 ${pageNum}:`, e);
                        }
                    }
                    // 重新獲取實際頁數
                    totalPages = pdf.internal.getNumberOfPages();
                }
                
                // 使用實際頁數作為最終頁數
                let finalTotalPages = totalPages;
                
                // 確保不會有額外的頁面被創建
                // 更新所有頁面的頁首頁尾（使用最終實際頁數）
                if (finalTotalPages > 0) {
                    for (let pageNum = 1; pageNum <= finalTotalPages; pageNum++) {
                        // 確保頁面存在才設置
                        const currentTotalPages = pdf.internal.getNumberOfPages();
                        if (pageNum > currentTotalPages) {
                            console.warn(`頁面 ${pageNum} 不存在，停止更新`);
                            finalTotalPages = currentTotalPages; // 更新最終頁數
                            break;
                        }
                        
                        pdf.setPage(pageNum);
                        
                        // 清除舊的頁首頁尾，重新添加（使用最終頁數）
                        addHeaderFooter(pdf, pageNum, finalTotalPages, systemName);
                        
                        // 每次更新後檢查是否創建了新頁
                        const newTotalPages = pdf.internal.getNumberOfPages();
                        if (newTotalPages > finalTotalPages) {
                            console.warn(`更新頁面 ${pageNum} 後頁數增加 (${newTotalPages} > ${finalTotalPages})，立即刪除`);
                            for (let extraPage = newTotalPages; extraPage > finalTotalPages; extraPage--) {
                                try {
                                    pdf.deletePage(extraPage);
                                    console.log(`已刪除多餘頁面 ${extraPage}`);
                                } catch (e) {
                                    console.warn(`無法刪除多餘頁面 ${extraPage}:`, e);
                                }
                            }
                            // 重新獲取實際頁數
                            finalTotalPages = pdf.internal.getNumberOfPages();
                        }
                    }
                    
                    // 最後再次檢查並清理所有多餘頁面（以防萬一）
                    finalTotalPages = pdf.internal.getNumberOfPages();
                    if (finalTotalPages > actualPageNumber) {
                        console.log(`最終檢查：發現多餘頁面 (${finalTotalPages} > ${actualPageNumber})，刪除`);
                        for (let pageNum = finalTotalPages; pageNum > actualPageNumber; pageNum--) {
                            try {
                                pdf.deletePage(pageNum);
                                console.log(`最終刪除頁面 ${pageNum}`);
                            } catch (e) {
                                console.warn(`無法刪除頁面 ${pageNum}:`, e);
                            }
                        }
                        finalTotalPages = pdf.internal.getNumberOfPages();
                    }
                    
                    // 最終驗證：確保頁數正確（中文版特別檢查）
                    const finalCheckPages = pdf.internal.getNumberOfPages();
                    if (finalCheckPages !== finalTotalPages) {
                        console.warn(`最終驗證：頁數不一致 (${finalCheckPages} !== ${finalTotalPages})，使用實際頁數`);
                        finalTotalPages = finalCheckPages;
                    }
                }

                pdf.save(fileName);
                
                // 清理 PDF 容器
                if (pdfContainer && pdfContainer.parentNode) {
                    pdfContainer.parentNode.removeChild(pdfContainer);
                }
                
                // 恢復按鈕狀態
                btn.disabled = false;
                btn.textContent = originalText;
            } catch (error) {
                console.error('PDF 生成錯誤:', error);
                
                // 確保清理 PDF 容器
                const pdfContainer = document.getElementById('pdfContentContainer');
                if (pdfContainer && pdfContainer.parentNode) {
                    pdfContainer.parentNode.removeChild(pdfContainer);
                }
                
                const currentLang = i18n.currentLang || 'zh-TW';
                const errorMsg = currentLang === 'zh-TW' 
                    ? 'PDF 生成失敗：' + error.message
                    : 'PDF generation failed: ' + error.message;
                alert(errorMsg);
                
                // 恢復按鈕狀態
                const btn = document.getElementById('downloadPdfBtn');
                if (btn) {
                    btn.disabled = false;
                    const btnText = btn.getAttribute('data-i18n') 
                        ? i18n.t(btn.getAttribute('data-i18n')) 
                        : (currentLang === 'zh-TW' ? '下載 PDF 報告' : 'Download PDF Report');
                    btn.textContent = btnText;
                }
            }
        }

        document.getElementById('downloadPdfBtn').addEventListener('click', downloadPdf);

        // 檢查是否為頁面刷新（F5）
        const isPageRefresh = performance.navigation.type === 1 || performance.getEntriesByType('navigation')[0]?.type === 'reload';
        
        // 頁面載入時更新報告（延遲確保所有元素都已渲染和 i18n 已初始化）
        setTimeout(async function() {
            try {
                // 1. 先更新問卷雷達圖等DOM
                await updateReport(isPageRefresh);
                // 2. 再執行AI分析（依賴DOM資料，如果是刷新則強制重新生成）
                await getAIInsights(isPageRefresh);
            } catch (error) {
                console.error('頁面初始化錯誤:', error);
                // 確保至少顯示引導頁面
                const reportContent = document.getElementById('reportContent');
                const noReportGuide = document.getElementById('noReportGuide');
                if (reportContent) {
                    reportContent.style.display = 'none';
                }
                if (noReportGuide) {
                    noReportGuide.style.display = 'flex';
                }
            }
        }, 300);
    </script>
}
